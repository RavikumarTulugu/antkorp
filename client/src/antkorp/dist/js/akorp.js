/*! antkorp 2013-12-05 */
requirejs.config({baseUrl:"js/modules",waitSeconds:200,shim:{underscore:{exports:"_"},backbone:{deps:["underscore","jquery"],exports:"Backbone"}},paths:{plugins:"../lib",jquery:"../../assets/jquery/jquery.min",underscore:"../../assets/underscore/underscore-min",backbone:"../../assets/backbone/backbone-min",text:"../../assets/requirejs-text/text",bootstrap:"../lib/bootstrap.min",jcrop:"../../assets/jcrop/js",jqueryui:"../../assets/jquery-ui/ui/minified/jquery-ui.min",fullcalendar:"../../assets/fullcalendar/fullcalendar.min","jquery.tagsinput":"../../assets/jquery.tagsinput/jquery.tagsinput","jquery-tmpl":"../../assets/jquery-tmpl/jquery.tmpl.min"}}),require(["require","jquery","underscore","backbone","akputils","featureCheck"],function(a,b,c,d,e,f){b(function(){b("body").addClass("visible");var c,d=new f;d.check()&&(d.loader(),d.logger(),a(["jquery","underscore","backbone","socketModule","akpMain","akpauth","akpkons","akpvault","akprtc","akpmedia","akpplanner","akpTour","appViews","text!../templates.html","wsGet","plugins/jquery-ui","plugins/noty_full","bootstrap"],function(a,b,e,f,g,h,i,j,k,l,m,n,o){function p(a){w=a,x=d.checkURL(),x?(q(x),h.URLQuery=x):(c="prompt",w.showView(c))}function q(a){if("fu"==a.c){{var b=a.email.substring(0,a.email.lastIndexOf("@"));b+a.sid}r(a)}else"iu"==a.c||(c="prompt",w.showView(c))}function r(b){a.ajax({url:"php/applogin.php",type:"post",data:{userProfile:JSON.stringify({id:b.sid,email:b.email,mesgtype:"checkEmail"})},success:s,error:function(a,b,c){console.log("The following error occured: "+b),console.log(c)},complete:function(){}})}function s(a){var b;b=JSON.parse(a),console.log(b),b.message?t(b):console.log("user record missing.")}function t(a){h.baseUser=a.message;var b=a.message;b.confirmed?c=b.organization?b.registered?"login":"3stepwizard":"3stepwizard":(u(x),c="3stepwizard"),w.showView(c)}function u(b){a.ajax({url:"php/applogin.php",type:"post",data:{userProfile:JSON.stringify({id:b.sid,email:b.email,mesgtype:"UpdateConfirm"})},success:v,error:function(a,b,c){console.log("The following error occured: "+b,c)},complete:function(){}})}function v(a){var b=JSON.parse(a);console.log(b)}var w,x,y={vault:j,kons:i,rtc:k,media:l,calendar:m,akpauth:h,appController:d,views:o,onready:p};window.akp_ws=new g(y);var z=new f;z.init(akp_ws.handleStatusUpdates,akp_ws.handleMessage,akp_ws),z.register(["fmgr","dstore","auth","rtc","kons","calendar"]),akp_ws.init({sendCallback:z.send,closeCallback:z.close,transportObj:z});var A=e.Model.extend({defaults:{},initialize:function(){},record:function(){},routeParse:function(){var a=(window.location,this.getTab(window.location.hash)),b=this.str2Data(window.location.search);if(b)if("kons"==a&&b.konvid)b.mesgtype="request",b.request="queryLoad",i(b);else{var c={};c.mesgtype="request",c.request="getRelay",i(c)}else{var c={};c.mesgtype="request",c.request="getRelay",i(c)}},getTab:function(a){return a.substr(1,a.length)},str2Data:function(a){if(a){for(var b=a.substr(1,a.length).split("&"),c={},d=0;d<b.length;d++){var e=b[d],f=e.split("=")[0],g=e.split("=")[1];c[f]=g}return c}}});h.subscribe("loadComplete",function(){new A})}))})}),define("akputils",["jquery"],function(a){var b={"-5:30":"[GMT+05:30] India Standard Time - Kolkata"},c=function(){this._data={},this.get=function(a){return a?this._data[a]:void 0},this.set=function(a,b){this._data[a]=b}};return c.prototype.inBox=function(b,c,d){var e=a(d).width(),f=a(d).height(),g=a(d).position(),h=a(b).width(),i=a(b).height(),j=c.top,k=c.left;f+g.top<i+c.top&&(j=c.top-i),e+g.left<h+c.left&&(k=c.left-h),a(b).css({top:j,left:k})},c.prototype.linkify=function(a){var b=/(\b(https?|ftp|file):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gi;return a.replace(b,function(a){return'<a href="'+a+'" target="_blank">'+a+"</a>"})},c.prototype.isURL=function(a){var b=new RegExp("^(https?:\\/\\/)?((([a-z\\d]([a-z\\d-]*[a-z\\d])*)\\.)+[a-z]{2,}|((\\d{1,3}\\.){3}\\d{1,3}))(\\:\\d+)?(\\/[-a-z\\d%_.~+]*)*(\\?[;&a-z\\d%_.~+=-]*)?(\\#[-a-z\\d_]*)?$","i");return b.test(a)?!0:!1},c.prototype.youtubeURL=function(a){var b=/^(?:https?:\/\/)?(?:www\.)?(?:youtu\.be\/|youtube\.com\/(?:embed\/|v\/|watch\?v=|watch\?.+&v=))((\w|-){11})(?:\S+)?$/;return a.match(b)?RegExp.$1:!1},c.prototype.makeCenter=function(b){var c=a(b).width(),d=a(b).height(),e=-c/2,f=-d/2;a(b).css({top:"50%",left:"50%","margin-left":e+"px","margin-top":f+"px"})},c.prototype.mime2class=function(a){{var b="akorp-mime-";b+a.replace(/(\.|\+|\/)/g,"-")}return a=a.split("/"),b+a[0]+("image"!=a[0]&&a[1]?" "+b+a[1].replace(/(\.|\+)/g,"-")+" "+b+a[0]+"-"+a[1].replace(/(\.|\+\-)/g,""):"")},c.prototype.convBytes=function(a,b){var c=1024,d=1024*c,e=1024*d,f=1024*e;return a>=0&&c>a?a+" B":a>=c&&d>a?(a/c).toFixed(b)+" KB":a>=d&&e>a?(a/d).toFixed(b)+" MB":a>=e&&f>a?(a/e).toFixed(b)+" GB":a>=f?(a/f).toFixed(b)+" TB":a+" B"},c.prototype.min2hours=function(a){var c=Math.round(a/60),d=Math.abs(a%60),e=new String;return e=c+":"+d,b[e]},c.prototype.htmlEscape=function(a){return String(a).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")},c.prototype.htmlUnescape=function(a){return String(a).replace(/&quot;/g,'"').replace(/&#39;/g,"'").replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&amp;/g,"&")},c.prototype.array2string=function(a){var b="",c=a.length;if(!c)return b;for(var d=0;c>d;d++)b+=a[d]+",";return b},c.prototype.str2Data=function(a){if(a){for(var b=a.substr(1,a.length).split("&"),c={},d=0;d<b.length;d++){var e=b[d],f=e.split("=")[0],g=e.split("=")[1];c[f]=g}return c}},c.prototype.SHA1=function(a){function b(a,b){return a<<b|a>>>32-b}function c(a){for(var b="",c=28;;c-=4)if(b+=(a>>>c&15).toString(16),!c)return b}var d,e,f=1732584193,g=4023233417,h=2562383102,i=271733878,j=3285377520,k=4294967295,l=new Array(80),m=a.length,n=new Array;for(a+=fcc(128);a.length%4;)a+=fcc(0);for(d=0;d<a.length;d+=4)n.push(a.cca(d)<<24|a.cca(d+1)<<16|a.cca(d+2)<<8|a.cca(d+3));for(;n.length%16!=14;)n.push(0);n.push(m>>>29),n.push(m<<3&k);for(var o=0;o<n.length;o+=16){for(d=0;16>d;d++)l[d]=n[o+d];for(d=16;79>=d;d++)l[d]=b(l[d-3]^l[d-8]^l[d-14]^l[d-16],1);var p=f,q=g,r=h,s=i,t=j;for(d=0;19>=d;d++)e=b(p,5)+(q&r|~q&s)+t+l[d]+1518500249&k,t=s,s=r,r=b(q,30),q=p,p=e;for(d=20;39>=d;d++)e=b(p,5)+(q^r^s)+t+l[d]+1859775393&k,t=s,s=r,r=b(q,30),q=p,p=e;for(d=40;59>=d;d++)e=b(p,5)+(q&r|q&s|r&s)+t+l[d]+2400959708&k,t=s,s=r,r=b(q,30),q=p,p=e;for(d=60;79>=d;d++)e=b(p,5)+(q^r^s)+t+l[d]+3395469782&k,t=s,s=r,r=b(q,30),q=p,p=e;f=f+p&k,g=g+q&k,h=h+r&k,i=i+s&k,j=j+t&k}return c(f)+c(g)+c(h)+c(i)+c(j)},new c}),define("featureCheck",["jquery","underscore","backbone","akputils"],function(a,b,c,d){var e=c.View.extend({initialize:function(){a("<div/>").addClass("overlay").attr("id","logOverlay").appendTo("body"),a(".akorp-ui").hide(),this.mask=a("#logOverlay"),window.MediaSource=window.MediaSource||window.WebKitMediaSource,this.appload=a("#loadbar"),this.loading=!1},baseCss:{"font-size":"24px",color:"red",margin:"20px","line-height":"30px"},check:function(){var a=/chrom(e|ium)/.test(navigator.userAgent.toLowerCase());return a?!1 in window?(this.noSupport(),!1):!0:(this.venderError(),!1)},statusMsgs:{wait:"<p>Please wait, we are getting your identity..</p>",unreachable:"<p>Sorry! antkorp is unreachable at the moment,<br> please try after some time.</p>",noSupport:"<span class='icon-html5' style='display:inline-block; font-size:50px; '><p>Oops! your browser doesn't compatible with the application, <br>please upgrade your browser to try our demo.</p>",venderError:"<span class='icon-chrome' style='display:inline-block; font-size:50px; '></span><p>Sorry! We only support Google Chrome.<br> Get Chrome and try our Demo.</p>",noResponse:"<p>Sorry! antkorp is not Responding at the moment,<br> please try after some time.</p>"},show:function(b){a(".errDailog").remove();var c=a("<div/>").attr("id","browserFailMsg").addClass("modal errDailog").appendTo("body").append(b);this.mask.show(),this.adjust("#"+c.attr("id"))},unautherized:function(){},verifying:function(){var b=a(this.statusMsgs.wait).css({"font-size":"24px",color:"blue",margin:"20px","line-height":"30px"});this.show(b)},notReachable:function(){this.loading&&this.loaded();var b=a(this.statusMsgs.unreachable).css(this.baseCss);this.show(b)},noSupport:function(){this.loading&&this.loaded();var b=a(this.statusMsgs.noSupport).addClass("akorp-error-msg");this.show(b)},notResponding:function(){var b=a(this.statusMsgs.noResponse).css(this.baseCss);this.show(b)},venderError:function(){this.loading&&this.loaded();var b=a(this.statusMsgs.venderError).addClass("akorp-error-msg");this.show(b)},success:function(){},adjust:function(b){a(b).css("max-width","80%");var c=a(b).width(),d=(a(b).height(),-c/2);a(b).css({top:"20%",left:"50%","margin-left":d+"px"})},showLoader:function(){this.appload.show(),d.makeCenter("#loadbar"),this.loading=!0},loader:function(){window.loadComplete=0;var a=this;this.loading||this.showLoader(),window.loader=function(b,c){loadComplete+=b,a.appload.children(".apploadstatus").html(c),100==loadComplete&&a.changeLoadStatus("Connecting to the server...")}},changeLoadStatus:function(a){this.appload.children(".apploadstatus").html(a)},loaded:function(){this.appload.hide(),this.loading=!1},logger:function(){window.logger=function(a){this.canLog=!1,canLog&&console.log(a)}},checkURL:function(){return d.str2Data(window.location.search)}});return e}),define("akpMain",["jquery","underscore","backbone","akputils","text!../templates.html"],function(a,b,c,d,e){var f,g=c.View.extend({initialize:function(c){this.transporter=c.transporter,b.bindAll(this,"render","handleBeforeUnload","handleWindowMessages"),a("body").append(e),this.hasChanged=!1,a(window).bind({unload:this.handleUnload,beforeunload:this.handleBeforeUnload,message:this.handleWindowMessages});var d={my:"center bottom-20",at:"center top",using:this.tooltipUsing};a(document).tooltip({position:d}).bind({contextmenu:this.handleRightClick,click:this.handleClick})},render:function(){},handleWindowMessages:function(b){var c=b.originalEvent.data;if("hide_pdf_viewer"==c.mesgtype)a("#pdf-vwr").hide();else if("gtk_viewer"==c.mesgtype){var d=akp_ws.createUUID(),e={mesgtype:"request",request:"broadway_input",cookie:d,data:window.btoa(c.originalMsg),uid:this.transporter.handlers.akpauth.loginuserid,service:"fmgr"};this.transporter.send(e)}},handleRightClick:function(){},handleClick:function(){a(".akp").hide()},handleUnload:function(){akp_ws.close()},handleBeforeUnload:function(){return this.hasChanged?"Your session is closing. Do you want to proceed?":void 0},tooltipUsing:function(b,c){a(this).css(b),a("<div>").addClass("arrow").addClass(c.vertical).addClass(c.horizontal).appendTo(this)}}),h=function(a){this.appTitle="Neptunium Demo",this.titleTimer="",this.isVisible=!0,this.checkHidden(),this.app="",this.settings={gid:"",uid:"",user:"",groups:"",users:[]},this.GroupSelector=!0,this.originURL=window.location.origin,this.handlers=a,this.kons=new this.handlers.kons,this.calendar=a.calendar,this.vault=a.vault,this.auth=a.akpauth,this.handlers.akpauth.groups.bind("groupChange",this.groupChange,this)};return h.prototype.groupChange=function(a){this.handlers.calendar&&this.handlers.calendar.changeGroup(a),this.handlers.kons&&this.kons.changeGroup(a),this.handlers.vault&&this.handlers.vault.changeGroup(a)},h.prototype.init=function(a){a.transportObj&&(this.transportObj=a.transportObj),a.sendCallback&&(this.sendCallback=a.sendCallback),a.closeCallback&&(this.closeCallback=a.closeCallback)},h.prototype.initModules=function(a){this.GroupSelector&&f.showGroupSelector({}),this.handlers.vault&&this.handlers.vault.start({homedir:a.homedir,bookmarks:a.bookmarks})},h.prototype.setupModules=function(){window.requestAnimationFrame(f.showApp),this.handlers.kons&&this.kons.start(),this.handlers.calendar&&this.handlers.calendar.start(),this.handlers.akpauth&&this.handlers.akpauth.handleTabSwitch()},h.prototype.send=function(a,b){if(1!=b)try{if("request"==a.mesgtype||"response"==a.mesgtype||"ack"==a.mesgtype||"cancel"==a.mesgtype){var c=this.getGID();c&&(a.gid=c)}}catch(d){console.log(d.message)}this.sendCallback.call(this.transportObj,a)},h.prototype.close=function(){this.closeCallback.call()},h.prototype.onHidden=function(a,b){this.viewManager.bind("hidden",a,b)},h.prototype.onVisible=function(a,b){this.viewManager.bind("visible",a,b)},h.prototype.handleViewChange=function(a){this.viewManager.trigger(a)},h.prototype.visChange=function(){this.isHidden()?(this.isVisible=!1,this.handleViewChange("hidden")):(this.isVisible=!0,this.handleViewChange("visible"),this.resetTitle())},h.prototype.checkHidden=function(){var a=this.getHiddenProp(),b=this;if(this.viewManager=new g({transporter:this}),a){var c=a.replace(/[H|h]idden/,"")+"visibilitychange";document.addEventListener(c,function(){b.visChange()},!0)}},h.prototype.isHidden=function(){var a=this.getHiddenProp();return a?document[a]:!1},h.prototype.getHiddenProp=function(){var a=["webkit","moz","ms","o"];if("hidden"in document)return"hidden";for(var b=0;b<a.length;b++)if(a[b]+"Hidden"in document)return a[b]+"Hidden";return null},h.prototype.notifyOnHidden=function(a){this.isVisible||this.changeTitle(a)},h.prototype.changeTitle=function(a){var b=this;f.notifyAudio(),this.resetTitle(),this.titleTimer=setInterval(function(){b.swapTitle(a)},500)},h.prototype.resetTitle=function(){clearInterval(this.titleTimer),this.swapTitle(this.appTitle)},h.prototype.swapTitle=function(a){document.title=document.title==this.appTitle?a:this.appTitle},h.prototype.createUUID=function(){return"xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx".replace(/[xy]/g,function(a){var b=16*Math.random()|0,c="x"==a?b:3&b|8;return c.toString(16)})},h.prototype.get=function(a){return Getter.getEntry(a)},h.prototype.getMap=function(a){Getter.map(a)},h.prototype.getGID=function(){return this.handlers.akpauth.cgd?this.handlers.akpauth.cgd:!1},h.prototype.setVaultDir=function(a){this.vaultdir=a,this.handlers.vault.gohome(a)},h.prototype.postData=function(a){this.handlers.vault.picUpdate(a)},h.prototype.picUpdate=function(a){this.handlers.akpauth.handleMessage(a)},h.prototype.getActivedir=function(){return this.vaultdir},h.prototype.setVGroupDir=function(a){this.vaultGdir=a,this.handlers.vault.setGHome(a)},h.prototype.LoadBookmarks=function(a){this.handlers.vault.addBookmarks(a)},h.prototype.setDstoreDir=function(a){this.dstoreDir=a;try{dstore&&dstore.setHome(a)}catch(b){}},h.prototype.getIM=function(a){var b={mesgtype:"event",eventtype:"new_chat",userid:a};this.handlers.rtc.send(b)},h.prototype.getMedia=function(a,b){var c={mesgtype:"event",eventtype:"new_media",userid:a};b&&(c.audio=b.audio),this.handlers.media.send(c)},h.prototype.sendPeer=function(a){return this.handlers.media.send(a)},h.prototype.konsDialog=function(a){var b={};return b.request="konsDialog",b.mesgtype="request",b.settings=a,this.handlers.kons(b)},h.prototype.getProfile=function(a){this.handlers.akpauth.profile.show(a),this.appView.showView("user")},h.prototype.fileSelector=function(a){this.handlers.vault.showSelector(a)},h.prototype.FSDialog=function(a){return this.handlers.vault.FSDialog(a)},h.prototype.FilesViewer=function(a){return this.handlers.vault.FVDialog(a)},h.prototype.openFileBrowser=function(a){this.handlers.vault.FileBrowser(a)},h.prototype.send2Service=function(a,b){"kons"==a?new this.handlers.kons(b):"rtc"==a&&this.handlers.rtc.send(b)},h.prototype.parseRtcReq=function(a,b){return"request"==a.mesg_type&&"send_imsg"==a.request?(delete a.mesg_type,delete a.request,a.mesgtype="event",a.eventtype="new_imsg",a.imsg.sender=b,a):void 0},h.prototype.alert=function(a,b){noty({layout:"bottomRight",theme:"default",type:b||"alert",text:a,timeout:5e3})},h.prototype.inProgress=function(a){this.progressList(this.progressCodes[a])},h.prototype.handleMessage=function(b){var c=b;if(c&&c.service){var d=a.trim(c.service);switch(d){case"fmgr":this.handlers.vault.handleMessage(c);break;case"dstore":try{dstore&&dstore.add(c)}catch(b){}break;case"kons":new this.handlers.kons(c);break;case"calendar":this.handlers.calendar.send(c);break;case"rtc":this.handlers.rtc.send(c);break;case"auth":this.handlers.akpauth.handleMessage(c);break;case"notes":notes&&notes.handleMessage(c);break;case"ngw":this.handleServiceStatus(c);break;default:logger("Service not recognised:"),logger(c)}}},h.prototype.handleServiceStatus=function(a){var b={service_up:"up",service_down:"down"},c={service_up:"success",service_down:"error"},d={fmgr:"Vault",dstore:"Dstore",kons:"Konversations",rtc:"Communication",auth:"Authentication",calendar:"Planner"},e=d[a.service_name];if(e){var f=b[a.eventtype],g=c[a.eventtype];this.alert(e+" service is "+f,g)}},h.prototype.handleStatusUpdates=function(a){switch(a.status){case"notSupported":this.handlers.appController.noSupport(),console.log("no Websocket Support");break;case"opened":var b=this;console.log("Connection established to the server"),f=new b.handlers.views,h.prototype.appView=f,this.handlers.akpauth.subscribe("loggedOut",akp_ws.appView.showLogin),this.handlers.appController.loaded(),this.handlers.onready.call(this,this.appView);break;case"error":this.handlers.appController.notReachable(),console.log("Server throws Error.");break;case"closed":this.handlers.appController.notReachable(),console.log("Connection closed.");break;case"clientRegistered":break;case"svcupdate":try{akp_ws.handleServiceStatus(a)}catch(c){console.log(c.message)}break;case"unreg_err":console.log("service not registerd: "+a.service);break;case"svc_err":noty({layout:"bottomRight",theme:"default",type:"error",text:"we are sorry, one of our services is down at this moment.",timeout:5e3});break;case"notResponding":this.handlers.appController.loaded(),this.handlers.appController.notResponding(),console.log("server not responding");break;default:console.log("recieved an unknown message from socket handler")}},h}),define("akpauth",["jquery","underscore","backbone","akpcontacts","akpGroups","picUpdater","akpprofiles","akputils","plugins/jquery-ui","plugins/jquery-tmpl"],function(a,b,c,d,e,f,g,h){loader(20,"Authentication initializing");var i="css/images/user32.png",j=c.Model.extend({initialize:function(a){this.auth=a.auth},isAdmin:function(){return this.get("admin")==this.auth.loginuserid},setInfo:function(a){this.set(a),this.trigger("initialized",this.toJSON())}}),k=c.View.extend({initialize:function(){},render:function(){}}),l=function(){this.baseUser={},this.org=null,this.organization=new j({auth:this}),this.groups=e,this.contacts=d,this.URLQuery={},this.maptable={},this.mapCallbacks={},this.notifTable={},this.mapnotifier={},this.reqTable={},this.maprequests={},this.notificationStreams={},this.awayTimer,this.usersList={},this.membersCount=0,this.userFirstEntry=!1,this.fbusername,this.logout=!1,this.loginstatus=!1,this.activeuser,this.loginuserid,this.activegroup,this.cgd,this.isLoadFinish=!0,this.prflview=!1,this.picChanged=!1,this.events={authenticated:[],loadComplete:[],loggedout:[]},this.bbsub=new k,this.groups.bind("groupChange",this.setGroup,this),this.groups.bind("leaveGroup",this.groupLeave,this),this.groups.bind("deleteGroup",this.removeGroup,this),this.contacts.bind("approveUser",this.groupApprove,this),this.contacts.bind("declineUser",this.groupDecline,this),this.render()};l.prototype.render=function(){var b=this,c={obj:b};a(".stts_msg").bind("click",c,b.showStatusOptions),a("#status_opts li:not(.status_custom)").bind("click",c,b.activeUserStatusChange),a("#status_opts li.status_custom").bind("click",c,b.statusMsgChange)},l.prototype.statusMsgChange=function(b){var c=b.data.obj;b.stopPropagation();var d=a('<input type="text" placeholder="your message.." class="status_message" name="status_line" required style="margin-top:20px; margin-left:10px; border-radius:0px;" />').keyup(function(b){if(13==b.which){var d=a(this).val();if(!d)return;c.statusMsgUpdate(d.status_line),a(this).parent().dialog("close").remove()}}).attr("value",c.activeuser.status_line);a("<div/>").append(d).dialog({title:"Status message",modal:!0,open:this.dialogOpen,buttons:[{text:"Ok","class":"btn btn-primary",click:function(){var b=a(this).children("input").val();b&&(c.statusMsgUpdate(b),a(this).dialog("close").remove())}},{text:"Cancel","class":"btn btn-danger",click:function(){a(this).dialog("close").remove()}}]})},l.prototype.dialogOpen=function(){var b=a(this);b.closest(".ui-dialog").removeClass("ui-corner-all"),$dialogOverlay=a(".ui-widget-overlay").last(),$dialogOverlay.unbind(),$dialogOverlay.click(function(){b.dialog("close")})},l.prototype.updateStatusMsg=function(b){a(".status_opt.status_custom").html(b).append('<span class="edit-icon icon-pencil akp-close-icon"></span>'),this.activeuser.status_line=b},l.prototype.statusMsgUpdate=function(a){var b=akp_ws.createUUID(),c={mesgtype:"request",request:"set_status_line",service:"auth",cookie:b,status_line:a,uid:this.loginuserid};akp_ws.send(c),this.updateStatusMsg(a)},l.prototype.handleTabSwitch=function(){akp_ws.onHidden(this.handleUserAway,this),akp_ws.onVisible(this.handleUserAlive,this)},l.prototype.handleUserAway=function(){var a=this;this.awayTimer=setTimeout(function(){a.changeUserStatus("away")},18e4)},l.prototype.handleUserAlive=function(){clearTimeout(this.awayTimer),this.changeUserStatus("available")},l.prototype.changeUserStatus=function(b){var c=this;b!=c.activeuser.status&&(c.sendUserStatus(c,b),a(".stts_msg").attr("data-stts",b))},l.prototype.activeUserStatusChange=function(b){var c=b.data.obj,d=a(this).data("opt");a(".stts_msg").attr("data-stts",d),c.sendUserStatus(c,d)},l.prototype.showStatusOptions=function(b){b.stopPropagation();var c=a(this).attr("data-stts");a("#status_opts li").removeClass("current_status active"),a("#status_opts li[data-opt='"+c+"']").addClass("current_status active"),a("#status_opts").slideDown()},l.prototype.showActiveUserProfile=function(a){var b=a.data.obj;b.viewChange(b.usersList[b.loginuserid])},l.prototype.getuserinfo=function(a){return this.usersList[a]?this.usersList[a]:this.activeuser},l.prototype.sendUserStatus=function(a,b){var c=a,d={service:"auth",mesgtype:"event",eventtype:"status_update",user:c.loginuserid,status:b};akp_ws.send(d),c.activeuser.status=b},l.prototype.adduser=function(a,b,c,d){var e=akp_ws.createUUID(),f={mesgtype:"request",service:"auth",request:"adduser",cookie:e,oid:this.org.name,uname:a||this.baseUser.username,first_name:b,password:c};akp_ws.send(f),this.maptable[e]="adduser",this.mapCallbacks[f.cookie]=d},l.prototype.deleteUser=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"removeuser",cookie:c,oid:this.org.name,uid:a};akp_ws.send(d),this.maptable[c]="adduser",this.mapCallbacks[d.cookie]=b},l.prototype.loginuser=function(a,b,c){if(this.loginstatus)return console.log("user already logged in, you are trying to issue login request another time."),!1;var d=akp_ws.createUUID(),e={mesgtype:"request",request:"login",service:"auth",uname:a,password:b,cookie:d};return console.log("login request sent. waiting for Response...."),akp_ws.send(e),this.maptable[e.cookie]="activeuser",this.mapCallbacks[e.cookie]=c,!0},l.prototype.logoutuser=function(a){var b=akp_ws.createUUID(),c={mesgtype:"request",request:"logout",service:"auth",uid:this.loginuserid,cookie:b};this.loginstatus&&(akp_ws.send(c,!0),this.maptable[c.cookie]="logout",this.mapCallbacks[c.cookie]=a,this.logout=!1)},l.prototype.setuser=function(a,b){for(var c in a)a[c]||(a[c]="");var d=akp_ws.createUUID(),e={mesgtype:"request",service:"auth",request:"setuser",cookie:d,uid:this.loginuserid,user:a};akp_ws.send(e,!0),this.maptable[d]="setuser",this.mapCallbacks[d]=b},l.prototype.getuser=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"getuser",cookie:c,uid:a};return akp_ws.send(d,!0),this.maptable[c]="getuser",this.mapCallbacks[d.cookie]=b,w.bind({id:c,user:a})},l.prototype.changePswd=function(a,b,c,d){var e=akp_ws.createUUID(),f={mesgtype:"request",service:"auth",request:"change_password",cookie:e,uid:a||this.loginuserid,new_password:b,old_password:c};akp_ws.send(f,!0),this.maptable[e]="changePswd",this.mapCallbacks[e]=d},l.prototype.getgroup=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"getgroup",cookie:c,uid:this.loginuserid,gid:a};akp_ws.send(d,!0),this.maptable[d.cookie]="getgroup",this.mapCallbacks[d.cookie]=b},l.prototype.addGroup=function(a,b,c){var d=akp_ws.createUUID(),e={mesgtype:"request",service:"auth",request:"addgroup",cookie:d,gname:a,oid:this.org.name,uid:this.loginuserid,join_by_approval:b};akp_ws.send(e),this.maptable[e.cookie]="addGroup",this.mapCallbacks[e.cookie]=c},l.prototype.removeGroup=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"delgroup",cookie:c,uid:this.loginuserid,gid:a};akp_ws.send(d),this.maptable[d.cookie]="removeGroup",this.mapCallbacks[d.cookie]=b},l.prototype.updateGroup=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"setgroup",cookie:c,gid:a.gid,group:a,uid:this.loginuserid};akp_ws.send(d),this.maptable[d.cookie]="updateGroup",this.mapCallbacks[d.cookie]=b},l.prototype.groupJoin=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"add_member",cookie:c,gid:a,oid:this.org.name,uid:this.loginuserid};akp_ws.send(d,!0),this.maptable[d.cookie]="groupJoin",this.mapCallbacks[d.cookie]=b},l.prototype.groupLeave=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"rem_member",cookie:c,gid:a,oid:this.org.name,uid:this.loginuserid};akp_ws.send(d,!0),this.maptable[d.cookie]="groupLeave",this.mapCallbacks[d.cookie]=b},l.prototype.groupApprove=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"approve_user",cookie:c,gid:this.cgd,oid:this.org.name,uid:this.loginuserid,user:a};akp_ws.send(d,!0),this.maptable[d.cookie]="groupApprove",this.mapCallbacks[d.cookie]=b},l.prototype.groupDecline=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"disapprove_user",cookie:c,gid:this.cgd,oid:this.org.name,uid:this.loginuserid,user:a,reason:""};akp_ws.send(d,!0),this.maptable[d.cookie]="groupDecline",this.mapCallbacks[d.cookie]=b},l.prototype.createOrg=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"create_org",cookie:c,org:a,email:this.URLQuery.email};akp_ws.send(d),console.log(d),this.maptable[d.cookie]="createOrg",this.mapCallbacks[d.cookie]=b},l.prototype.removeOrg=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"removeorg",cookie:c,uid:this.loginuserid};akp_ws.send(d),this.maptable[d.cookie]="removeOrg",this.mapCallbacks[d.cookie]=b},l.prototype.getOrg=function(a){var b=akp_ws.createUUID(),c={mesgtype:"request",service:"auth",request:"get_org",cookie:b,uid:this.loginuserid,oid:this.activeuser.organization};akp_ws.send(c),this.maptable[c.cookie]="getOrg",this.mapCallbacks[c.cookie]=a},l.prototype.orgInvite=function(b,c,d){a.ajax({url:"php/appInvite.php",type:"post",data:{userProfile:JSON.stringify(b)},success:c,error:d})},l.prototype.invitationsDialog=function(a){return new t(a)},l.prototype.getRequests=function(a,b,c){var d=akp_ws.createUUID(),e={service:"auth",mesgtype:"request",request:"relay_pending_requests",category:a,cookie:d,uid:this.loginuserid,gid:this.cgd};"string"==typeof b&&(e.marker=b),akp_ws.send(e),this.maptable[e.cookie]="getrequests",this.reqTable[e.cookie]=a,"object"==typeof b?this.maprequests[e.cookie]=b:c&&(this.maprequests[e.cookie]=c)},l.prototype.handleGetRequests=function(a){a.service=this.notifTable[a.cookie],a.response="relay_request",this.maprequests[a.cookie]&&this.maprequests[a.cookie].attachRequest(a.result.invite),akp_ws.handleMessage(a)},l.prototype.notificationDialog=function(a){var b=new p(a);return this.notificationStreams[a.service]=b,b},l.prototype.getNotifications=function(a,b,c){var d=akp_ws.createUUID(),e={mesgtype:"request",service:"auth",request:"relay_notification",cookie:d,category:a,uid:this.loginuserid,gid:this.cgd};("string"==typeof b||"number"==typeof b)&&(e.marker=b),akp_ws.send(e),this.maptable[e.cookie]="getnotifications",this.notifTable[e.cookie]=a,"object"==typeof b?this.mapnotifier[e.cookie]=b:c&&(this.mapnotifier[e.cookie]=c)},l.prototype.getNotificationCount=function(a,b){var c=akp_ws.createUUID(),d={mesgtype:"request",service:"auth",request:"get_notification_count",cookie:c,category:a,uid:this.loginuserid,gid:this.cgd};akp_ws.send(d),this.maptable[d.cookie]="getnotificationscount",this.notifTable[d.cookie]=a,b&&(this.mapnotifier[d.cookie]=b)},l.prototype.checkAllNotification=function(a,b){var c=akp_ws.createUUID(),d={service:"auth",mesgtype:"request",request:"mark_all_read",cookie:c,uid:this.loginuserid,gid:this.cgd,category:a};akp_ws.send(d),this.maptable[d.cookie]="checkallnotifications",this.notifTable[d.cookie]=a,b&&(this.mapnotifier[d.cookie]=b)},l.prototype.checkNotification=function(a,b,c){var d=(akp_ws.createUUID(),{mesgtype:"request",request:"check_notification",service:"auth",id:b,uid:this.loginuserid,gid:this.cgd,category:a});akp_ws.send(d),this.maptable[d.cookie]="checknotification",this.notifTable[d.cookie]=a,c&&(this.mapnotifier[d.cookie]=c)},l.prototype.handleNotifications=function(a){console.log(a.result),a.service=this.notifTable[a.cookie],a.response="relay_notification",this.mapnotifier[a.cookie]&&this.mapnotifier[a.cookie].attachNotification(a.result),akp_ws.handleMessage(a)},l.prototype.handleNotifyCount=function(a){a.service=this.notifTable[a.cookie],a.response="notification_count",this.mapnotifier[a.cookie]&&this.mapnotifier[a.cookie].changeCount(a.count),akp_ws.handleMessage(a)},l.prototype.handleNotifyCheckAll=function(a){a.service=this.notifTable[a.cookie],a.response="notification_check_all",this.mapnotifier[a.cookie]&&this.mapnotifier[a.cookie].checkoutAll(a),akp_ws.handleMessage(a)},l.prototype.handleNotifyCheck=function(a){a.service=this.notifTable[a.cookie],a.response="notification_check",akp_ws.handleMessage(a)},l.prototype.routeNotification=function(a){try{this.notificationStreams[a.category].attachNotification(a)}catch(b){console.log(b.message)}},l.prototype.addBookmark=function(a){var b=akp_ws.createUUID(),c={uid:this.loginuserid,bookmark:a,service:"auth",mesgtype:"request",request:"add_bookmark",cookie:b};akp_ws.send(c)},l.prototype.removeBookmark=function(a){var b=akp_ws.createUUID(),c={uid:this.loginuserid,bookmark:a,service:"auth",mesgtype:"request",request:"delete_bookmark",cookie:b};akp_ws.send(c)},l.prototype.showProfile=function(a){this.profile.show(a)},l.prototype.viewChange=function(a){var b=a;for(var c in b)"undefined"==b[c]&&(b[c]=""),b[c]||(b[c]="")},l.prototype.handleLogoutResponse=function(a){console.log(a),"success"==a.status&&this.mapCallbacks[a.cookie].call(this,a)},l.prototype.updateUser=function(a){var b=JSON.parse(a);console.log(b.message.id)},l.prototype.fberror=function(a,b,c){console.log(c)},l.prototype.subscribe=function(a,b){this.events[a]||(this.events[a]=[]),this.events[a].push(b),this.bbsub.bind(a,b,this)},l.prototype.trigger=function(a,b){var c=this.events[a];if(c)for(var d=c.length,e=0;d>e;e++)c[e].apply(this,[b])},l.prototype.handleLoginResponse=function(b){if("function"==typeof this.mapCallbacks[b.cookie]&&this.mapCallbacks[b.cookie].call(this,b),b.user){if(console.log("user Logged in"),this.loginstatus=!0,this.logout)return;this.logout=!0,this.handleTabSwitch(),title="notifications",this.usersList[b.user.uid]=b.user,this.activeuser=b.user,this.loginuserid=this.activeuser.uid,this.userFirstEntry&&(this.prflview=!1,this.userFirstEntry=!1),this.org&&null!=this.org||this.getOrg(this.handleGroupsList),this.handleGroupsList(b.user),akp_ws.initModules(this.activeuser),a(".userModule").show(),this.updateUserInfoViews(this.activeuser),this.profile.show({id:b.user.uid,mode:"write"})}else b.error&&console.log(b.error)},l.prototype.updateUserInfoViews=function(b){var c={username:b.uname,uid:b.uid};
a("#uname").html(b.first_name||"no name").data(c),a(".active-name").append(b.first_name+" "+b.last_name),a(".status_opt.status_custom").html(b.status_line||"Custom..").append('<span class=" icon-pencil akp-close-icon edit-icon"></span>'),a(".active-img img").attr("src",b.image_large||"css/images/user128.png"),a("#activeuserimg").attr("src",b.image_small||"css/images/user32.png"),a("#user-std-pic").attr("src",b.image_large||"css/images/user128.png")},l.prototype.handleGroupObject=function(a){"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a);this.groups.add(a.group),a.group},l.prototype.setGroup=function(a){this.cgd=a.gid,this.activegroup=a,this.bbsub.trigger("groupInit",a)},l.prototype.getMembers=function(a){for(var b=a.length,c=0;b>c;c++){var d=a[c];if(!this.usersList[d]){var e=this.getuser(d);e.onError=function(a){console.log("error get user :"+a)}}}},l.prototype.handleAddUser=function(a){this.mapCallbacks[a.cookie].call(this,a),"success"==a.status?console.log(" User added successfully"):console.log(" user adding failed")},l.prototype.handleEvents=function(a){"new_user"==a.eventtype?(this.usersList[a.user.uid]=a.user,this.contacts.add(a.user)):"status_update"==a.eventtype&&(this.usersList[a.user]&&(this.usersList[a.user].status=a.status,this.usersList[a.user].status_line=a.status_line),this.contacts.changeStatus({uid:a.user,status:a.status,status_line:a.status_line}))},l.prototype.handleCreateGroup=function(a){"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a),this.groups.add(a.group)},l.prototype.handleGroupJoin=function(a){"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a)},l.prototype.handleGroupApprove=function(a){"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a)},l.prototype.handleNewOrg=function(a){console.log(a),a.error?console.log("failed to create new org"):(this.org=a.org,this.organization.setInfo(a.org),"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a))},l.prototype.handleOrgInfo=function(a){if(console.log(a),"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a.org),a.error)console.log("failed to get Organization Information.");else{var b=a.org.user_list;this.org=a.org,this.organization.setInfo(a.org),this.membersCount=b.length,this.getMembers(b)}},l.prototype.handleGroupsList=function(a){for(var b=a.group_list||a.groups,c=0;c<b.length;c++)this.getgroup(b[c])},l.prototype.handleCallback=function(a){"function"==typeof this.mapCallbacks[a.cookie]&&this.mapCallbacks[a.cookie].call(this,a)},l.prototype.handleMessage=function(a){var b=a;if(w.parse(a),"event"==b.mesgtype)this.handleEvents(b);else switch(this.maptable[b.cookie]){case"activeuser":this.handleLoginResponse(b);break;case"getuser":"function"==typeof this.mapCallbacks[b.cookie]&&this.mapCallbacks[b.cookie].call(this,b),"response"==b.mesgtype&&(this.usersList[b.user.uid]=b.user,b.user.uid==this.loginuserid&&this.updateUserInfoViews(b.user),b.user.uid!=this.loginuserid&&this.contacts.add(b.user));break;case"setuser":"success"==b.status?this.getuser(this.loginuserid,this.mapCallbacks[b.cookie]):(console.log("Failed to update user information"),"function"==typeof this.mapCallbacks[b.cookie]&&this.mapCallbacks[b.cookie].call(this,b));break;case"adduser":this.handleAddUser(b);break;case"logout":this.handleLogoutResponse(b);break;case"changePswd":this.handleCallback(b);break;case"getgroup":this.handleGroupObject(b);break;case"addGroup":this.handleCreateGroup(b);break;case"groupJoin":this.handleGroupJoin(b);break;case"updateGroup":case"groupLeave":case"groupApprove":case"groupDecline":case"removeGroup":this.handleGroupApprove(b);break;case"createOrg":this.handleNewOrg(b);break;case"getOrg":this.handleOrgInfo(b);break;case"picUpload":x.post(b);break;case"getrequests":this.handleGetRequests(b);break;case"getnotifications":this.handleNotifications(b);break;case"getnotificationscount":this.handleNotifyCount(b);break;case"checkallnotifications":this.handleNotifyCheckAll(b);break;case"checknotification":this.handleNotifyCheck(b);break;default:console.log("Request Timed out:"),console.log(b)}};var m=new l,n=c.Model.extend({notifier:"",description:"",active:!1,initialize:function(){this.bind("change",this.handleUpdates,this)},handleUpdates:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"active":break;default:this.trigger("updated")}},check:function(){if(this.get("active")){var a=this.get("id");m.checkNotification(this.get("service"),a,this),this.set({active:!1}),this.trigger("checked")}},formatTime:function(b){var c=new Date(b),d=new Date,e=Math.abs(d.getTime()-b),f=(Math.round(e/864e5),c.getFullYear()==d.getFullYear()?!0:!1),g=c.getMonth()==d.getMonth()?!0:!1;return c.getDate()==d.getDate()&&g&&f?a.fullCalendar.formatDate(c,"HH:mm"):d.getDate()-c.getDate()==1&&g&&f?"yesterday":a.fullCalendar.formatDate(c,"dd/MM/yyyy")},maskDescription:function(a){if(!a)return a;var b=a.lastIndexOf("@");if(0>=b)return a;var c=a.substr(0,b),d=a.substr(b+2,a.length),e=new Date(d),f=akp_ws.calendar.date2String(e,"hh:mmtt dd/MM/yy"),g=c+" @ "+f;return g},renderNotifiers:function(a,b){var c="";if(a.notifiers.length>1){for(var d=0;d<a.notifiers.length;d++)if(a.notifiers[d]!=m.loginuserid&&(c+=m.getuserinfo(a.notifiers[d]).first_name+", ",3==d)){c+=" and "+(a.notifiers.length-3)+" others";break}}else c=b;return c},getInfo:function(){var a=this.toJSON(),b=m.getuserinfo(a.notifiers[0]),c={img:b.image_small||i,name:this.renderNotifiers(a,b.first_name),description:"calendar"==this.service?this.maskDescription(a.description):a.description,timestamp:this.formatTime(1e3*a.timestamp)};return a.preview&&(c.preview=h.htmlUnescape(a.preview)),c}}),o=c.Collection.extend({model:n,mapNotificationCategory:{file:"container",kons:"kons",calendar:"planner"},changeCount:function(a){this.trigger("countChange",a)},checkAll:function(){m.checkAllNotification(this.settings.service,this)}}),p=c.View.extend({events:{"click .notify-no":"openNotifications","click .notification":"hideNotifications","scroll .notifications-list":"getMore","click .check-all":"checkoutAll"},defaults:{service:"kons",onNotificationClick:"",lastTop:0,timestamp:0,marker:null},settings:{lastTop:0,timestamp:0,marker:null},initialize:function(c){b.bindAll(this,"hideNotifications","getMore"),this.settings=a.extend({},this.defaults,c),this.collection=new o,this.collection.bind("add",this.addNotification,this),this.collection.bind("countChange",this.changeCount,this),a(document).bind("click",this.hideNotifications)},render:function(){return this},checkoutAll:function(){m.checkAllNotification(this.settings.service,this);var a=this.$(".notifications-list").children(".notification").attr("data-active",!1).find(".ntfy-status");a.removeClass("icon-radio-checked").addClass("icon-radio-unchecked"),this.changeCount(0)},getNotificationCount:function(){m.getNotificationCount(this.settings.service)},init:function(){var b=a("#notification-view-template").tmpl([{count:0,className:this.settings.className}]);this.$el.append(b),this.$(".notifications-list").bind("scroll",this.getMore),m.getNotifications(this.settings.service,this),m.getNotificationCount(this.settings.service,this)},getMore:function(){{var b=this.$(".notifications-list").scrollTop(),c=this.$(".notifications-list")[0].scrollHeight,d=this.$(".notifications-list")[0].offsetHeight,e=c-d;a(document).height()}if(b>this.settings.lastTop&&b+50>e){var f=this.$(".notification:last-child").attr("data-notifyid"),g=this.collection.get(f),h=g.toJSON().timestamp;h!=this.settings.marker&&(this.relayReq(h),this.settings.marker=h)}this.settings.lastTop=b},relayReq:function(a){m.getNotifications(this.settings.service,a,this)},hideNotifications:function(a){a.stopPropagation(),this.$(".notifications-pane").hide()},openNotifications:function(b){b.stopPropagation(),b.preventDefault(),a(".notifications-pane").hide(),this.collection.length&&this.$(".notifications-pane").show()},changeCount:function(a){var b=parseInt(this.$(".notify-no").html());"inc"==a?a=b+1:"dec"==a&&(a=b-1),parseInt(a)>=0&&this.$(".notify-no").html(a)},attachNotification:function(a,b){var c=this.collection.get(a.id);c?c.set(a):this.collection.add(a),b&&this.changeCount(b)},addNotification:function(a){var b=a.toJSON();if(1==b.notifiers.length&&b.notifiers[0]==m.loginuserid)return console.log(a.toJSON()),console.log("notifier is login user so that notification dropped."),void 0;var c=new q({model:a,collection:this.collection,service:this.settings.service,click:this.settings.onNotificationClick});a.toJSON().addTop?this.$(".notifications-list").prepend(c.render().$el):this.$(".notifications-list").append(c.render().$el)},clear:function(){this.collection.reset(),this.$(".notifications-list").empty(),this.settings=a.extend({},this.settings,{lastTop:0,timestamp:0,marker:null})}}),q=c.View.extend({events:{click:"checkNotification"},initialize:function(a){b.bindAll(this,"checkNotification"),this.service=a.service,this.callback=a.click,this.model.set({service:this.service}),this.model.bind("updated",this.showupdates,this),this.model.bind("checked",this.sendChecked,this)},showupdates:function(){this.render()},render:function(){var b=this.model.toJSON(),c=this.model.getInfo();this.$el=a("#notification-template").tmpl([c]);var d=1==b.active?"icon-radio-checked":"icon-checkmark-circle",e=a("<span>").addClass("ntfy-status").addClass(d);return this.$el.append(e).attr("data-active",b.active).bind("click",this.checkNotification).attr("data-notifyid",b.id),this},sendChecked:function(){var a=this.$el.attr("data-active",!1).find(".ntfy-status");a.removeClass("icon-radio-checked").addClass("icon-checkmark-circle"),this.collection.changeCount("dec")},checkNotification:function(){var a=this.model.toJSON();akp_ws.appView.navView.changeView(this.collection.mapNotificationCategory[a.category]),this.callback.call(void 0,a),this.model.check()}}),r=c.Model.extend({}),s=c.Collection.extend({model:r}),t=c.View.extend({events:{"click .evt-title":"showInvitation"},settings:{},defaults:{hasRequests:!1},initialize:function(c){b.bindAll(this,"addRequest"),this.collection=new s,this.settings=a.extend({},this.defaults,c),this.collection.bind("add",this.addRequest,this)},getInvitations:function(){},init:function(){m.getRequests(this.settings.service,this)},render:function(){},addRequest:function(b){var c=b.toJSON(),d=this.settings.onInvite(c),e=a("<li/>").append(d);this.$("ul").append(e).find(".empty-invite").parent("li").remove()},hideElement:function(){this.$el.hide()},showElement:function(){this.$el.show()},attachRequest:function(a){console.log(a),this.hasRequests||(this.hasRequests=!0),this.collection.add(a)},showInvitation:function(){},clear:function(){this.collection.reset(),this.$("ul").empty()}}),u=function(){this._mapQuery={}};u.prototype.parse=function(a){if(this._mapQuery[a.cookie]){var b=this._mapQuery[a.cookie];b.success(a)}},u.prototype.bind=function(a){var b=new v({user:a.user});return this._mapQuery[a.id]=b,b};var v=function(a){this.onError=null,this.onSuccess=null,this.done=!1;var b=this;return this.timer=setTimeout(function(){b.done=!0,b.onError&&b.onError.call(b,a.user)},5e3),this};v.prototype.success=function(a){clearTimeout(this.timer),this.done||this.onSuccess&&this.onSuccess.call(this,a)};var w=new u,x=new f({controller:m}),y=new g({controller:m,collection:m.contacts});return l.prototype.profile=y,l.prototype.picUpdater=x,m}),define("akpkons",["jquery","underscore","backbone","akpauth","akputils","akpcontacts","plugins/jquery.tagsinput.min","fullcalendar","plugins/jquery-tmpl"],function(a,b,c,d,e,f){function g(a){var c=a;if(!c)return this;switch(c.mesgtype){case"event":i[c.konv.category]?i[c.konv.category].call(void 0,c.eventtype,c.konv):this.handleEvents(c);break;case"response":if(z.get(c.cookie))z.get(c.cookie).call(void 0,c.result);else if(j[c.cookie])j[c.cookie].call(void 0,c.result);else if(C.map(c.cookie)&&b.contains(B.categories,c.result.category))B.byFilter=!1,B.add(c.konv||c.result);else if("relay_notification"==c.response)E.add(c.result);else if("notification_count"==c.response)E.trigger("countChange",c.count);else if("notification_check_all"==c.response)E.trigger("countChange",c.pending);else if("notifications_check"==c.response)E.trigger("countChange",c.count);else if(c.result){if(!b.contains(B.categories,c.result.category)&&!c.result.parent)return;B.byFilter=!0,B.add(c.result)}break;case"request":if("getRelay"==c.request)C.init();else if("queryLoad"==c.request)C.init(c);else{if("konsDialog"==c.request)return new x(c.settings);if("konsStream"==c.request)return new t(c.settings)}break;case"notification":console.log(c),"kons"==c.notification.category?(c.notification.addTop=!0,E.add(c.notification),E.trigger("countChange","inc")):d.routeNotification(c.notification);break;case"error":console.log("recieved Error Message Kons"),console.log(c),noty({text:c.error,type:"error",layout:"bottomRight",theme:"default",timeout:5e3});break;default:console.log("oops! undefined mesgtype recieved kons"),console.log(c)}}loader(40,"kons Loaded");var h="css/images/user32.png",i={},j={};g.prototype.start=function(){d.getNotifications("kons"),d.getNotificationCount("kons"),C.init()},g.prototype.konsDialog=function(a){return new x(a)},g.prototype.getKonsStream=function(a){return new t(a)},g.prototype.getCategoryUpdates=function(a,b){i[a]=b},g.prototype.clear=function(){B.clear()},g.prototype.changeGroup=function(){this.clear(),this.start()},g.prototype.handleEvents=function(a){if("new_konv"==a.eventtype)b.contains(B.categories,a.konv.category)?D.add(a.konv):D.add(a.konv);else if("update_konv"==a.eventtype){var c=B.get(a.konv.id);c&&c.set(a.konv)}else"delete_konv"==a.eventtype&&B.scrap(a.konv)};var k=c.Model.extend({notifier:"",description:"",active:!1}),l=c.Collection.extend({model:k}),m=c.View.extend({el:".mt-menu.kons-tab",events:{"click .notify-no":"openNotifications","click .notification":"hideNotifications","scroll .notifications-list":"getMore","click .check-all":"checkoutAll"},settings:{lastTop:0,timestamp:0,marker:null},initialize:function(c){b.bindAll(this,"hideNotifications","getMore"),this.posts=c.posts,this.collection.bind("add",this.addNotification,this),this.collection.bind("countChange",this.changeCount,this),this.posts.bind("clear",this.clear,this),a(document).bind("click",this.hideNotifications),a(".notifications-list").bind("scroll",this.getMore)},render:function(){},checkoutAll:function(){d.checkAllNotification("kons");var a=this.$(".notifications-list").children(".notification").attr("data-active",!1).find(".ntfy-status");a.removeClass("icon-radio-checked").addClass("icon-checkmark-circle"),this.changeCount(0)},getNotificationCount:function(){d.getNotificationCount("kons")},getMore:function(){{var b=this.$(".notifications-list").scrollTop(),c=this.$(".notifications-list")[0].scrollHeight,d=this.$(".notifications-list")[0].offsetHeight,e=c-d;a(document).height()}if(b>this.settings.lastTop&&b+50>e){var f=this.$(".notification:last-child").attr("data-notifyid"),g=this.collection.get(f),h=g.toJSON().timestamp;h!=this.settings.marker&&(this.relayReq(h),this.settings.marker=h)}this.settings.lastTop=b},relayReq:function(a){d.getNotifications("kons",a)},hideNotifications:function(){this.$(".notifications-pane").hide()},openNotifications:function(b){b.stopPropagation(),b.preventDefault(),a(".notifications-pane").hide(),this.collection.length&&this.$(".notifications-pane").show()},changeCount:function(a){var b=parseInt(this.$(".notify-no").html());"inc"==a?a=b+1:"dec"==a&&(a=b-1),parseInt(a)>=0&&(this.$(".notify-no").html(a),this.notificationCount=a)},addNotification:function(a){var b=new n({model:a,posts:this.posts,collection:this.collection});a.toJSON().addTop?this.$(".notifications-list").prepend(b.render().el):this.$(".notifications-list").append(b.render().el)},clear:function(){this.collection.reset(),this.$(".notifications-list").empty()}}),n=c.View.extend({events:{click:"getKons"},initialize:function(c){b.bindAll(this,"getKons"),this.posts=c.posts;var f=this.model.toJSON(),g=d.getuserinfo(f.notifiers[0]),i={img:g.image_small||h,name:g.first_name,description:f.description,timestamp:this.formatTime(1e3*f.timestamp)};if(f.notifiers.length>1){for(var j="",k=0;k<f.notifiers.length;k++)if(f.notifiers[k]!=d.loginuserid&&(j+=d.getuserinfo(f.notifiers[k]).first_name+", ",3==k)){j+=" and "+(f.notifiers.length-3)+" others";break}i.name=j}f.preview&&(i.preview=e.htmlUnescape(f.preview)),this.el=a("#notification-template").tmpl([i]);var l=1==f.active?"icon-radio-checked":"icon-checkmark-circle",m=a("<span>").addClass("ntfy-status").addClass(l);this.el.append(m).attr("data-active",f.active).bind("click",this.getKons).attr("data-notifyid",f.id)},formatTime:function(b){var c=new Date(b),d=new Date,e=Math.abs(d.getTime()-b),f=(Math.round(e/864e5),c.getFullYear()==d.getFullYear()?!0:!1),g=c.getMonth()==d.getMonth()?!0:!1;return c.getDate()==d.getDate()&&g&&f?a.fullCalendar.formatDate(c,"HH:mm"):d.getDate()-c.getDate()==1&&g&&f?"yesterday":a.fullCalendar.formatDate(c,"dd/MM/yyyy")},render:function(){return this},sendChecked:function(){var a=this.model.toJSON(),b=a.id;d.checkNotification("kons",b),this.model.set({active:!1});var c=this.el.attr("data-active",!1).find(".ntfy-status");c.removeClass("icon-radio-checked").addClass("icon-checkmark-circle"),this.collection.trigger("countChange","dec")},getKons:function(){var a=this.model.toJSON(),b=a.kons;1==a.active&&this.sendChecked();var c=a.hierarchy;c.length-1?(console.log(a.id),this.posts.showTreePost(c,b)):this.posts.showPost(b)}}),o=c.Model.extend({defaults:{rep:!1,hasChildren:!1,expand:!0},action:function(a){var b=this.get("owner_uid"),c=this.get("id");if(("like"==a||"dislike"==a)&&b==d.loginuserid)return this.errMsg(c,"like/dislike"),void 0;var e=akp_ws.createUUID(),f={service:"kons",mesgtype:"request",request:a,uid:d.loginuserid,cookie:e,id:c};akp_ws.send(f)},errMsg:function(b,c){var d=a("#sharedPosts").find('li[data-postid="'+b+'"]'),e=a("<div/>").addClass("konvmsg").append("<p>You can't "+c+" on this post.<br/> Click me to close.</P>").bind("click",function(){a(this).remove()});setTimeout(function(){e.remove()},5e3),d.append(e)},postComment:function(a){var b=(new Date).getTime(),c=akp_ws.createUUID(),e={service:"kons",mesgtype:"request",request:"new",uid:d.loginuserid,gid:d.cgd,cookie:c,parent:this.get("id"),root:this.get("root")||this.get("id"),edit_timestamp:b,create_timestamp:b,content:a,category:"",taglist:[]};return e}}),p=c.Collection.extend({model:o,byFilter:!1,categories:[],scrap:function(a){this.trigger("delete",a)},showPost:function(a){var b=this.where({id:a})[0];b?this.trigger("focus",a):this.trigger("getPost",a)},showTreePost:function(a,b){for(var c=!1,d=a.length;d>0;--d)c=!1,d==a.length&&(c=!0),this.trigger("getPost",a[d-1],c);this.trigger("focus",b)},clear:function(){this.reset(),this.trigger("clear")}}),q=c.View.extend({el:".konv-updlist",initialize:function(a){b.bindAll(this,"render","_renderPost"),this.posts=a.posts,this.posts.bind("clear",this.clear,this)},render:function(){},add:function(b){if(b.owner_uid==d.loginuserid)return this.update(b),void 0;if(b.parent){var c=this.posts.get(b.parent);if(c){var e=this.getInfo(b);a("<li/>").addClass("konv-update").append(e).bind("click",b,this._renderPost).prependTo(".konv-updlist")}}else{var e=this.getInfo(b);a("<li/>").addClass("konv-update").append(e).bind("click",b,this._renderPost).prependTo(".konv-updlist")}},getInfo:function(b){var c=a("<div/>").append(e.htmlUnescape(b.content)).text();b.sampleContent=c.substr(0,100)+"...",b.first_name=d.getuserinfo(b.owner_uid).first_name,b.image_small=d.getuserinfo(b.owner_uid).image_small||h,b.type=b.parent?"Comment":"Discussion";var f=a("#konv-update-template").tmpl([b]);return f},_renderPost:function(b){var c=b.data;a(b.currentTarget).attr("data-checked")||(this.update(c),a(b.currentTarget).attr("data-checked",1).remove())},update:function(a){this.posts.byFilter=!1,this.posts.add(a)},clear:function(){this.$el.empty()}}),r=c.View.extend({tagName:"li",settings:{},defaults:{conditionalLoading:!1,basic:!1,richText:!0,onKonvRecieved:"",strictCategory:!1,expanded:!1},events:{"click .comment":"readmore","click .commauthr":"showAuthr","click .commcategory":"filterByCategory","click .rep":"reply","click .commup":"like","click .commdown":"dislike","click .commlock ":"lock","click .communlock":"unlock","click .commcollapse ":"collapse","click .commedit":"edit","click .commdelete":"remove","click .commComments":"getChildren","click .commAttaches":"loadAttachments","click .hideActivity":"closeActivity","click .likecount":"loadLikers","click .dislikecount":"loadDislikers","click .commtag":"filterByTag","click .commaccess":"showFollowers"},initialize:function(c){b.bindAll(this,"render","refresh","loadDefault","postEdit","showUser","showAuthr"),this.settings=a.extend({},this.defaults,c),this.model.bind("change",this.refresh),this.model.bind("reload",this.reload),this.obj=this.model.toJSON(),a(this.el).attr("data-postid",this.obj.id)},render:function(){this.obj=this.model.toJSON();var b=this.obj,c=d.getuserinfo(b.owner_uid);b.img=c.image_medium||h,b.author=c.first_name,b.time=this.formatTime(b.create_timestamp),b.content=e.htmlUnescape(b.content),a(this.el).children(".comment").remove();a("#post-template").tmpl([b]).prependTo(this.el);return this.readmore(),this.checkCollapser(),this.FilterImages(),this},FilterImages:function(){},checkCollapser:function(){var a=this.$el.children("ul");if(a.length){var b="none"==a.css("display");b?this.showAsCollapsed():this.showAsExpanded()}},showAsExpanded:function(){this.comment(".commcollapse").removeClass("icon-minus-2 icon-plus-2").addClass("icon-minus-2")},showAsCollapsed:function(){this.comment(".commcollapse").removeClass("icon-minus-2 icon-plus-2").addClass("icon-plus-2")},refresh:function(a){if(!a.get("rep")){var b=a.changedAttributes();for(var c in b)switch(c){case"likecount":case"dislikecount":case"content":case"locked":case"child_count":case"attachments":case"taglist":case"category":case"followers":case"limited":this.render(),this.model.set({rep:!1});break;case"hasChildren":this.settings.expanded=this.model.get(c)?!0:!1}}},formatTime:function(b){var c=new Date(b),d=new Date,e=Math.abs(d.getTime()-b),f=(Math.round(e/864e5),c.getFullYear()==d.getFullYear()?!0:!1),g=c.getMonth()==d.getMonth()?!0:!1;return c.getDate()==d.getDate()&&g&&f?a.fullCalendar.formatDate(c,"HH:mm"):d.getDate()-c.getDate()==1&&g&&f?"yesterday":a.fullCalendar.formatDate(c,"dd/MM/yyyy")},formatTags:function(){},filterByTag:function(b){var c=a(b.currentTarget).text();this.collection.trigger("newFilter","tag",c)},filterByCategory:function(){this.collection.trigger("newFilter","category",this.obj.category)},getChildren:function(b){if("true"==a(b.currentTarget).attr("data-loaded"))return this.showComments(),void 0;if(a(b.currentTarget).attr("data-loaded","true"),this.obj.child_count){var c=this.obj.id,e=akp_ws.createUUID(),f={service:"kons",mesgtype:"request",request:"relay",query:"children",uid:d.loginuserid,cookie:e,id:c};akp_ws.send(f),this.settings.conditionalLoading&&z.set(e,this.settings.onKonvRecieved)}},closeActivity:function(){this.$el.children(".comment").find(".commActivity").slideUp("slow")},comment:function(a){return this.$el.children(".comment").find(a)},showAuthr:function(){this.showUser()},showUser:function(a){akp_ws.getProfile({id:a||this.obj.owner_uid,mode:"read"})},showFollowers:function(){if(this.obj.followers&&this.obj.followers.length&&(this.comment(".commAttachments,.commDislikers,.commLikers").hide(),this.comment(".commAccessers,.commActivity").show(),"true"!=this.comment(".commAccessers").attr("data-loaded"))){this.comment(".commAccessers").attr("data-loaded",!0);for(var b in this.obj.followers){var c=this.obj.followers[b];a("<li/>").addClass("flwr").append(this.getUser(c)).appendTo(this.comment(".commAccessers ul"))}}},loadLikers:function(){if(this.obj.likecount&&(this.comment(".commAttachments,.commDislikers,.commAccessers").hide(),this.comment(".commLikers,.commActivity").show(),"true"!=this.comment(".commLikers").attr("data-loaded"))){this.comment(".commLikers").attr("data-loaded",!0);for(var b in this.obj.likers){var c=this.obj.likers[b];a("<li/>").addClass("liker").append(this.getUser(c)).appendTo(this.$el.children(".comment").find(".commLikers ul"))}}},loadDislikers:function(){if(this.obj.dislikecount&&(this.comment(".commAttachments,.commLikers,.commAccessers").hide(),this.comment(".commDislikers,.commActivity").show(),"true"!=this.comment(".commDislikers").attr("data-loaded"))){this.comment(".commDislikers").attr("data-loaded",!0);for(var b in this.obj.dislikers){var c=this.obj.dislikers[b];a("<li/>").addClass("disliker").append(this.getUser(c)).appendTo(this.$el.children(".comment").find(".commDislikers ul"))}}},getUser:function(b){var c=d.getuserinfo(b),e=this,f=a("#activeUser-template").tmpl([c]);return f.find(".commusername").bind("click",function(){e.showUser(b)}),c.uid==d.loginuserid&&f.find(".commusername").append(" (you)"),f},loadAttachments:function(){var b=this.model.toJSON().attachments;if(b.length&&(this.comment(".commLikers,.commDislikers,.commAccessers").hide(),this.comment(".commAttachments,.commActivity").show(),"true"!=this.comment(".commAttachments").attr("data-loaded"))){this.comment(".commAttachments").attr("data-loaded",!0);for(var c in b){var d=b[c];a("<li/>").bind("click",{path:d.path},this.openFileBrowser).addClass("cattach").append(this.getFile(d)).appendTo(this.$el.children(".comment").find(".commAttachments ul"))}}},openFileBrowser:function(a){var b=a.data.path;akp_ws.openFileBrowser({file:b})},getFile:function(b){var c={};a.extend(c,b);var d=e.mime2class(c.type),f=e.convBytes(c.size,2);return c.mime="true"==c.isdir?"akorp-mime-directory":d,c.size=f,c.hasRemove=!1,a("#attachment-template").tmpl([c])},reload:function(){},reply:function(){if(!this.model.get("locked")&&!this.model.get("rep")){var b=new s({model:this.model,richText:this.settings.richText,onShare:this.postEdit});this.readmore(),a(this.el).children(".comment").append(b.render().el)}},loadDefault:function(){a(this.el).children(".comment").remove(),this.render()},edit:function(){this.readmore(),this.comment(".commedit").hide(),this.comment(".commAttaches").hide(),this.comment(".tagsSection").hide(),this.comment(".commaccess").hide(),this.comment(".commActivity").hide();{var a=this.comment(".original-comment"),b={el:a,model:this.model,type:"edit",onShare:this.postEdit,onCancel:this.loadDefault,basic:this.settings.basic,richText:this.settings.richText};new x(b)}},postEdit:function(a){this.settings.strictCategory&&(a.category=this.settings.strictCategory),akp_ws.send(a),console.log("sending kons:"),console.log(a),this.loadDefault()},remove:function(){this.model.action("delete")},like:function(){this.model.get("ilike")||this.model.get("idontlike")?this.model.get("ilike")?this.model.action("revert_like"):this.model.get("idontlike")&&this.model.errMsg(this.model.get("id")," like "):this.model.action("like")},dislike:function(){this.model.get("idontlike")||this.model.get("ilike")?this.model.get("idontlike")?this.model.action("revert_dislike"):this.model.get("ilike")&&this.model.errMsg(this.model.get("id")," dislike "):this.model.action("dislike")},lock:function(){this.model.action("lock")},unlock:function(){this.model.action("unlock")},showComments:function(){a(this.el).children("ul").slideDown("slow"),this.showAsExpanded(),this.settings.expanded=!0},hideComments:function(){this.$el.children("ul").slideUp("slow"),this.showAsCollapsed(),this.settings.expanded=!1},collapse:function(){if(this.model.get("hasChildren")){var a=this.settings.expanded;a?this.hideComments():this.showComments()}},readmore:function(a){a&&a.stopPropagation(),this.$(".comment").css("max-height","1000px")}}),s=c.View.extend({className:"commEntry",defaults:{richText:!0,onShare:""},events:{"click .commpost":"sendComment","click .commpostno":"remove","focus .commInput":"focus","click .commInput":"clear","click .intLink":"applyStyle","change .colorLink":"setColor"},initialize:function(b){this.settings=a.extend({},this.defaults,b),this.template=a("#reply-template").tmpl(),this.model.set({rep:!0})},applyStyle:function(b){var c=a(b.currentTarget).attr("data-cmd");this.formatDoc(c)},setColor:function(b){var c=a(b.currentTarget).val();this.formatDoc("forecolor",c)},formatDoc:function(a,b){document.execCommand(a,!1,b),this.$(".commInput").focus()},focus:function(){this.$(".commInput").css("border-color","#04bfbf")},render:function(){return a(this.el).append(this.template),this},validate:function(){return a(this.el).children(".commInput").text()?!0:void 0},sendComment:function(){if(this.validate()){var b=a(this.el).children(".commInput").html(),c=this.model.postComment(b);"function"==typeof this.settings.onShare&&this.settings.onShare.call(void 0,c),this.remove()}},clear:function(){this.$(".dfltcmttxt").remove()},remove:function(){a(this.el).remove(),this.model.set({rep:!1})}}),t=(c.View.extend({defaults:{itemClass:"",columnCount:0,container:""},settings:{},initialize:function(b){a("#sharedPosts").width();this.columnCount=2,this.settings=a.extend({},this.defaults,b),this.render()},render:function(){for(var b=0;b<this.columnCount;b++){var c=b+1,d=a("<div/>").addClass("column column"+c).css({"float":"left",width:"50%"});this.settings.container.append(d)}},addItem:function(a){var b=this.getColumn2InsertbyItemcount();b.append(a),a.find(".comment").css({width:"400px"})},getColumn2InsertbyColHeight:function(){var a=this.settings.container.find("column1"),b=this.settings.container.find("column12");return a.height()>b.height()?b:a},getColumn2InsertbyItemcount:function(){var a=this.settings.container.find(this.settings.itemClass).length,b=a%this.columnCount+1,c=".column"+b;return this.settings.container.find(c)},rearrange:function(){}}),c.View.extend({defaults:{basic:!1,richText:!0},settings:{},initialize:function(c){b.bindAll(this,"render","updates","hideControls","attachKonv","addKonv","deleteKons"),this.settings=a.extend({},this.defaults,c),this.collection=new p,this.collection.bind("add",this.addKonv,this),this.collection.bind("delete",this.removeKonv,this),a(document).bind("click",this.hideControls)},render:function(){return this},removeKonv:function(a){var b=this.$('li[data-postid="'+a.id+'"]');b&&b.remove(),a.root||(this.$(".post[data-konvid="+a.id+"]").remove(),this.trigger("rootRemoved"))},attachKonv:function(a){this.collection.add(a)},addKonv:function(a){var b=a.toJSON(),c=this,d=new r({model:a,collection:this.collection,conditionalLoading:!0,basic:!0,richText:!1,onKonvRecieved:function(a){c.collection.add(a)},strictCategory:this.settings.strictCategory});0==b.parent?this.addParent(d,b):this.addChildren(d,b)},addParent:function(b,c){var d=this,e=a('<ul class="comment-list"></ul>').append(b.render().el),f=c.muted?"icon-volume-mute":"icon-volume-medium",g=c.favourite?"icon-star-2":"icon-star",h=a("<div/>").append("Mute").click(function(a){d.handleMute(a,c)}).addClass(" "+f+" akorpddmenuitem ").attr({"data-muted":c.muted}),i=a("<div/>").append("Favourite").click(function(a){d.handleFavorite(a,c)}).addClass(" "+g+" akorpddmenuitem").attr({"data-fav":c.favorite}),j=a("<div/>").append("Link Post").click(function(a){d.showLink(a,c)}).addClass("icon-link akorpddmenuitem"),k=a("<div/>").addClass("akorpddmenulist controlslist").append(h).append(i).append(j),l=a("<span/>").addClass("icon-angle-down ").css({color:"#555","font-weight":"bold"}).click(this.showControls),m=a("<div/>").addClass("post-notify-btn").append(l).append(k),n=a('<div class="post"></div>').attr({"data-konvid":c.id,"data-edit_timestamp":c.edit_timestamp}).append(m).append(e).hide();this.collection.byFilter?this.$el.append(n):this.$el.prepend(n),n.slideDown("slow")},addChildren:function(b,c){var d=this.$('li[data-postid="'+c.parent+'"]');
if(d){var e=this.collection.get(c.parent);if(!e)return;e.set({hasChildren:!0});var f=d.children("ul.commSubList").length?d.children("ul.commSubList"):a("<ul/>").addClass("commSubList").appendTo(d),g=a(b.render().el).hide();f.append(g),g.slideDown("slow")}else console.log("konversation parent id not found")},handleMute:function(b,c){var d=a(b.currentTarget).attr("data-muted");"false"==d?(this.changeNotify(c,"unfollow"),a(b.currentTarget).removeClass("icon-volume-medium").addClass("icon-volume-mute").attr({title:"Mute","data-muted":"true"})):(this.changeNotify(c,"follow"),a(b.currentTarget).removeClass("icon-volume-mute").addClass("icon-volume-medium").attr({title:"Notify","data-muted":"false"}))},changeNotify:function(a,b){var c=akp_ws.createUUID(),e={service:"kons",mesgtype:"request",request:b,uid:d.loginuserid,cookie:c,id:a.id};akp_ws.send(e)},handleFavorite:function(b,c){var d=a(b.currentTarget).attr("data-fav");"false"==d?(this.changeNotify(c,"unmark_favourite"),a(b.currentTarget).removeClass("icon-star-2").addClass("icon-star").attr({title:"Favourite","data-fav":"true"})):(this.changeNotify(c,"mark_favourite"),a(b.currentTarget).removeClass("icon-star").addClass("icon-star-2").attr({title:"Favourite","data-fav":"false"}))},showControls:function(b){b.preventDefault(),b.stopPropagation(),a(b.currentTarget).parent().find(".controlslist").show()},hideControls:function(){this.$(".controlslist").hide()},showLink:function(b,c){var d=window.location,e=new String(d.origin+d.pathname+"?konvid="+c.id+"&action=vevent_kons"+d.hash);a("<div/>").addClass("dialogClass").append("<p><input type='text' class='link' value='"+e+"' /></p>").dialog({resizable:!1,title:"Post Link",height:170,modal:!0,buttons:{OK:function(){a(this).dialog("close").remove()}},open:function(){a(this).closest(".ui-dialog").find(".ui-button:nth-child(1)").addClass("btn blue")}})},getKonv:function(a,b){var c=akp_ws.createUUID(),e={id:a,mesgtype:"request",request:"get",service:"kons",cookie:c,uid:d.loginuserid};akp_ws.send(e),j[c]=this.attachKonv,b||this.clear()},loadKonvTree:function(){},updates:function(a,b){if(console.log(a),"new_konv"==a)b.parent||this.clear(),this.collection.add(b);else if("update_konv"==a){var c=this.collection.get(b.id);c&&c.set(b)}else if("delete_konv"==a)return this.collection.scrap(b),void 0;this.settings.onUpdates.call()},deleteKons:function(a){this.collection.get(a).action("delete")},clear:function(){this.$el.empty(),this.collection.reset()}})),u=c.View.extend({el:"#sharedPosts",events:{"click .post":"expandPost","click .goTop":"scrollTop"},settings:{lastTop:0,byFilter:!1},initialize:function(){b.bindAll(this,"getMore","hideControls"),B.bind("add",this.newpost,this),this.collection.bind("delete",this.removeNode,this),this.collection.bind("newFilter",this.sendRelay,this),this.collection.bind("getPost",this.exclusive,this),this.collection.bind("focus",this.focusPost,this),this.collection.bind("traverseTree",this.loadHierarchy,this),this.collection.bind("clear",this.clear,this);a(".kons-container").bind("scroll",this.getMore)},_mapReq:{},map:function(a,b){return b?(this._mapReq[a]=b,void 0):this._mapReq[a]?!0:!1},init:function(a){if(a)this.parseQuery(a);else{this.sendRelay("recent")}},focusPost:function(b){var c=this.$('li[data-postid="'+b+'"]');if(!c.length)return!1;var d=c.children(".comment");return a(".kons-container").animate({scrollTop:d.offset().top},1e3),a(d).effect("highlight",4e3),!0},loadHierarchy:function(a,b){console.log(b)},parseQuery:function(a){a.konvid&&this.exclusive(a.konvid)},exclusive:function(a,b){if(!a||null==a)return console.log("requested kons id is empty or null."),!1;console.log("requested Kons ID:"+a);var c=akp_ws.createUUID(),e={id:a,mesgtype:"request",request:"get",service:"kons",cookie:c,uid:d.loginuserid};akp_ws.send(e),this.map(c,"exclusive"),b||this.clear()},getMore:function(){var b=a(".kons-container").scrollTop(),c=a(".kons-container").height(),d=a(document).height();if(b>this.settings.lastTop){if(!this.$el.hasClass("faraway")&&b>300&&this.$el.addClass("faraway"),b+c>d-100){var e=this.$(".post:last-child").attr("data-konvid"),f=this.collection.get(e);if(!f)return;var g=f.toJSON().edit_timestamp;g!=this.settings.marker&&(this.relayReq(this.settings.query,this.settings.subquery,g),this.settings.marker=g)}}else this.$el.hasClass("faraway")&&300>b&&this.$el.removeClass("faraway");this.settings.lastTop=b},sendRelay:function(a,b){this.relayReq(a,b),this.clear(),this.showInstantMsg()},relayReq:function(a,b,c){var e=akp_ws.createUUID(),f={service:"kons",cookie:e,mesgtype:"request",request:"relay",query:a,uid:d.loginuserid,gid:d.cgd};this.settings.query=a,"tag"==a&&b?(f.tag=b,this.settings.subquery=b):"category"==a&&b&&(f.category=b,this.settings.subquery=b),c?f.marker=c:this.settings.marker=void 0,akp_ws.send(f)},showLoading:function(){var b=a("<div/>").addClass("post konsLoadingMsg").append("<span class='preloader icon-spinner-2'> </span> Loading...");this.$el.append(b)},showInstantMsg:function(){this.hasInstantMsg=!0,this.showLoading();var b=a("<div />").addClass("post konsInstantMsg").append("start sharing, be the first to make discussion ...").hide(),c=this;this.instantMsgTimer=setTimeout(function(){c.clearStatusMsgs(),c.$el.append(b),b.show("fade")},2e3)},clearInstantMsg:function(){this.hasInstantMsg&&(this.hasInstantMsg=!1,clearTimeout(this.instantMsgTimer),this.$(".post.konsInstantMsg").remove())},removeNode:function(a){var b=this.$('li[data-postid="'+a.id+'"]');b&&b.remove(),a.root||this.$(".post[data-konvid="+a.id+"]").remove()},newpost:function(a){var b=a.toJSON(),c=new r({model:a,collection:this.collection});0==b.parent?(this.clearInstantMsg(),this.attachAsParent(c,a)):this.attachAsChild(c,a)},handleMute:function(b,c){var d=a(b.currentTarget).attr("data-muted");"false"==d?(this.changeNotify(c,"unfollow"),a(b.currentTarget).removeClass("icon-volume-medium").addClass("icon-volume-mute").attr({title:"Mute","data-muted":"true"})):(this.changeNotify(c,"follow"),a(b.currentTarget).removeClass("icon-volume-mute").addClass("icon-volume-medium").attr({title:"Notify","data-muted":"false"}))},changeNotify:function(a,b){var c=akp_ws.createUUID(),e={service:"kons",mesgtype:"request",request:b,uid:d.loginuserid,cookie:c,id:a.id};akp_ws.send(e)},handleFavorite:function(b,c){var d=a(b.currentTarget).attr("data-fav");"false"==d?(this.changeNotify(c,"unmark_favourite"),a(b.currentTarget).removeClass("icon-star-2").addClass("icon-star").attr({title:"Favourite","data-fav":"true"})):(this.changeNotify(c,"mark_favourite"),a(b.currentTarget).removeClass("icon-star").addClass("icon-star-2").attr({title:"Favourite","data-fav":"false"}))},showControls:function(b){b.preventDefault(),b.stopPropagation(),a(b.currentTarget).parent().find(".controlslist").show()},hideControls:function(){this.$(".controlslist").hide()},showLink:function(b,c){var d=window.location,e=new String(d.origin+d.pathname+"?konvid="+c.id+d.hash);a("<div/>").addClass("dialogClass").append("<p><input type='text' class='link' value='"+e+"' /></p>").dialog({resizable:!1,title:"Post Link",height:170,modal:!0,buttons:{OK:function(){a(this).dialog("close").remove()}},open:function(){a(this).closest(".ui-dialog").find(".ui-button:nth-child(1)").addClass("btn blue")}})},expandPost:function(b){a(b.currentTarget).addClass("expand")},scrollTop:function(){a(".kons-container").animate({scrollTop:0},1e3)},attachAsParent:function(b,c){this.clearStatusMsgs();var d=c.toJSON(),e=a('<ul class="comment-list"></ul>').append(b.render().el),f=new v({model:c}),g=f.render().$el,h=a('<div class="post"></div>').click(this.expandPost).attr({"data-konvid":d.id,"data-edit_timestamp":d.edit_timestamp}).append(g).append(e).hide();this.collection.byFilter?a(this.el).append(h):a(this.el).prepend(h),h.slideDown("slow")},attachAsChild:function(b,c){var d=c.toJSON(),e=this.$('li[data-postid="'+d.parent+'"]');if(e){var f=B.get(d.parent);if(!f)return;f.set({hasChildren:!0});var g=e.children("ul.commSubList").length?e.children("ul.commSubList"):a("<ul/>").addClass("commSubList").appendTo(e),h=a(b.render().el).hide();g.append(h),h.slideDown("slow")}else console.log("konversation parent id not found")},clear:function(){this.$(".post").remove(),this.collection.reset()},clearStatusMsgs:function(){this.$(".post.konsInstantMsg").remove(),this.$(".post.konsLoadingMsg").remove()}}),v=c.View.extend({className:"post-notify-btn",events:{"click .postmute":"handleMute","click .postfav":"handleFavorite","click .postlink":"showLink","click .showPostCntrls":"showControls"},initialize:function(){var c=this.obj=this.model.toJSON();b.bindAll(this,"hideControls");var d=c.muted?"icon-volume-mute":"icon-volume-medium",e=c.favourite?"icon-star-2":"icon-star",f=a("<li/>").append("Mute").addClass(" "+d+" akorpddmenuitem postmute").attr({"data-muted":c.muted}),g=a("<li/>").append("Favourite").addClass(" "+e+" akorpddmenuitem postfav").attr({"data-fav":c.favorite}),h=a("<li/>").append("Link Post").addClass("icon-link akorpddmenuitem postlink"),i=a("<ul/>").addClass("akorpddmenulist controlslist dropdown-menu").append(f).append(g).append(h),j=a("<span/>").addClass("icon-angle-down showPostCntrls").css({color:"#555","font-weight":"bold"});this.$el.append(j).append(i),a(document).bind("click",this.hideControls)},render:function(){return this},handleMute:function(b){var c=this.obj,d=a(b.currentTarget).attr("data-muted");"false"==d?(this.changeNotify(c,"unfollow"),a(b.currentTarget).removeClass("icon-volume-medium").addClass("icon-volume-mute").attr({title:"Mute","data-muted":"true"})):(this.changeNotify(c,"follow"),a(b.currentTarget).removeClass("icon-volume-mute").addClass("icon-volume-medium").attr({title:"Notify","data-muted":"false"}))},changeNotify:function(a,b){var c=akp_ws.createUUID(),e={service:"kons",mesgtype:"request",request:b,uid:d.loginuserid,cookie:c,id:a.id};akp_ws.send(e)},handleFavorite:function(b){var c=this.obj,d=a(b.currentTarget).attr("data-fav");"false"==d?(this.changeNotify(c,"unmark_favourite"),a(b.currentTarget).removeClass("icon-star-2").addClass("icon-star").attr({title:"Favourite","data-fav":"true"})):(this.changeNotify(c,"mark_favourite"),a(b.currentTarget).removeClass("icon-star").addClass("icon-star-2").attr({title:"Favourite","data-fav":"false"}))},showControls:function(b){b.preventDefault(),b.stopPropagation(),a(b.currentTarget).parent().find(".controlslist").show()},hideControls:function(){this.$(".controlslist").hide()},showLink:function(){var b=this.obj,c=window.location,d=new String(c.origin+c.pathname+"?konvid="+b.id+c.hash);a("<div/>").addClass("dialogClass").append("<p><input type='text' class='link' value='"+d+"' /></p>").dialog({resizable:!1,title:"Post Link",height:170,modal:!0,buttons:{OK:function(){a(this).dialog("close").remove()}},open:function(){a(this).closest(".ui-dialog").find(".ui-button:nth-child(1)").addClass("btn btn-primary")}})}}),w=c.View.extend({el:a("#kons_sidebar"),defaults:{activeFilter:"recent",categoryFilter:{discussion:!0,share:!0,question:!0}},open:!1,settings:{},events:{"click .filtertype":"_filterByType"},initialize:function(c){b.bindAll(this,"render","loadCategories"),this.settings=a.extend({},c,this.defaults),this.collection.bind("newFilter",this.chooseFilter,this),this.collection.bind("clear",this.resetView,this),d.subscribe("groupInit",this.loadCategories)},render:function(){},resetView:function(){this.showActive(this.defaults.activeFilter)},showMenu:function(){this.open||(this.open=!0,this.$(".kons_filters_list").addClass("kfl-open"))},hideMenu:function(a){this.open&&(a.stopPropagation(),this.$(".kons_filters_list").removeClass("kfl-open"),this.open=!1)},chooseFilter:function(a,b){"tag"==a?this.makeInActive():this.settings.categoryFilter[b]&&this.showActive(b)},_filterByType:function(b){var c=a(b.currentTarget).attr("data-filter");this.relayRequest(c)},relayRequest:function(a){this.settings.activeFilter!=a&&(this.settings.categoryFilter[a]?this.collection.trigger("newFilter","category",a):this.collection.trigger("newFilter",a),this.showActive(a))},showActive:function(a){this.settings.activeFilter=a,this.$(".filtertype[data-filter = "+a+"]").siblings().removeClass("active").end().addClass("active")},makeInActive:function(){this.$(".filtertype").removeClass("active"),this.settings.activeFilter=""},loadCategories:function(b){this.$(".filtertype.konv_category").remove(),this.collection.categories=b.categories;for(var c=0;c<b.categories.length;c++){var d=a("<li/>").addClass("filtertype konv_category").attr("data-filter",b.categories[c]).append(b.categories[c]);this.$(".kons_filters_list ul").append(d)}this.$(".kons_filters_list").height()}}),x=c.View.extend({className:"konsEntry",events:{"click .commpost":"share","click .commpostno":"cancel","focus .commInput":"focus","click .commInput":"clear","mouseup .commInput":"checkCommands","paste .commInput":"checkURL","keyup .commInput":"checkContent","click .linkURLbtn":"showLinkInput","paste .postURL":"checkURL","click .addURL":"loadURL","click .addTag":"showTaginput","click .attach":"showFileSelector","click .postCategories":"showCategories","click .postcategory":"selectCategory","click .intLink":"applyStyle","change .colorLink":"setColor","click .commflw":"showModeOptions","click .opt":"selectMode","click .ubrowser":"userBrowser"},defaults:{attachments:[],onShare:"",onCancel:"",type:"new",maxTags:5,maxAttachments:5,mode:"public",tagInput:!0,fileBrowser:!0,linkInput:!0,membersInput:!0,basic:!1,richText:!0,defaultCategory:"discussion",allowImages:!0,autoFocus:!1,enableCategories:!1},settings:{},initialize:function(c){b.bindAll(this,"render","selectedFile","removeAttachment","selectMode","hideModeOptions","setUsers","loadLinkPreview","removeLink","loadURL"),this.settings=a.extend({},this.defaults,c),this.settings.attachments=[],this.render(),this.$el.attr("data-expanded","false"),this.$(".tagData").hide(),this.$(".linkData").hide(),this.$(".postCategories").hide(),this.$(".postcategorieslist").hide(),this.$(".tagInput").val(""),this.$(".postUsers").hide(),this.$(".postLinkPreview").hide(),this.$(".tagInput").tagsInput({height:"auto",width:"auto"}),this.userInput=f.selector({el:this.$(".userData")}).render(),a(document).click(this.hideModeOptions),this.settings.autoFocus&&this.clear(),this.settings.enableCategories&&this.showCategory(),this.model&&this.loadValues()},render:function(){return this.template=a("#kons-entry-template").tmpl([this.settings]),a(this.el).html(this.template).addClass(this.className),this},checkContent:function(b){var c=a(b.currentTarget).text().length;0>=c?this.disableShare():this.activateShare()},activateShare:function(){this.$(".commpost").removeAttr("disabled")},disableShare:function(){this.$(".commpost").attr("disabled","disabled")},loadValues:function(){var a=this.model.toJSON();this.clear(),a.taglist.length&&!this.settings.basic&&(this.showTaginput(),this.loadTags(a.taglist)),a.attachments.length&&!this.settings.basic&&(this.showFileList(),this.loadFiles(a.attachments)),a.parent||this.settings.basic?this.hideInactive():(this.settings.isRoot=!0,this.showCategory(),this.setCategory(a.category)),a.followers&&!this.settings.basic&&(this.switchMode("private"),this.userInput.addUsers(a.followers)),this.loadContent(a.content)},showLinkInput:function(b){a(b.currentTarget).hide(),this.$(".linkData").show()},hideLinkInput:function(){this.$(".linkData").hide()},checkURL:function(a){{var b=a.originalEvent.clipboardData.getData("Text");this.parseURL(b)}},loadURL:function(){{var a=this.$(".postURL").val();this.parseURL(a)}},validateURL:function(){this.$(".addURL").children("span").removeClass("icon-checkmark").addClass("icon-spinner-2").end().removeClass(" greenbtn").unbind(),this.$(".postURL").attr("disabled",!0)},resetLinkInput:function(){this.$(".addURL").children("span").removeClass("icon-spinner-2").addClass("icon-checkmark").end().addClass("btn greenbtn btn-icon ").bind("click",this.loadURL),this.$(".postURL").attr("disabled",!1)},parseURL:function(a){var b=e.isURL(a);if(!b)return!1;this.validateURL(),this.settings.state="edit";var c=e.youtubeURL(a);return c?(this.loadVideoPreview(c),this.hideLinkInput(),!0):(this.getURLPreview(a),void 0)},getURLPreview:function(a){var b=akp_ws.createUUID(),c={service:"kons",url:a,mesgtype:"request",request:"create_thumbnail",cookie:b,uid:d.loginuserid,gid:d.cgd};akp_ws.send(c),z.set(b,this.loadLinkPreview)},onPaste:function(a){var b=a.originalEvent.clipboardData.getData("Text"),c=e.isURL(b);if(c){var d=e.youtubeURL(b);d&&this.loadVideoPreview(d)}},loadLinkPreview:function(b){if("edit"==this.settings.state){var c=this.$(".postLinkPreview").attr("data-Loaded");if("true"!=c&&b.title){this.$(".postLinkPreview").attr("data-Loaded",!0);var d="",e="",f="",g="",h="",i="";b.image&&(d=a("<img/>").attr("src",b.image).addClass("thumbnail")),e=a("<span><a href='"+b.url+"' target='_blank'>"+b.title+"</a></span>").addClass("title"),g=a("<span/>").append(b.url).addClass("link"),f=a("<p/>").append(b.description),i=a("<span />").addClass("icon-cross linkRemove").bind("click",this.removeLink);var h=a("<div/>").append(e).append(g).append(f),j=a("<div/>").append(d).append(h).append(i).addClass("webthumbnail");this.$(".postLinkPreview").append(j).show(),this.settings.hasPreview=!0,this.$(".linkURLbtn").hide(),this.resetLinkInput(),this.hideLinkInput()}}},loadVideoPreview:function(b){if("edit"==this.settings.state){var c=this.$(".postLinkPreview").attr("data-Loaded");if("true"!=c){this.$(".postLinkPreview").attr("data-Loaded",!0);var d=a('<iframe width="560" height="315" src="http://www.youtube.com/embed/'+b+'?wmode=transparent&rel=0" frameborder="0" allowfullscreen></iframe>').css({width:"100%"}),e=a("<span />").addClass("icon-cross linkRemove").bind("click",this.removeLink),f=a("<div/>").addClass("vidthumbnail").append(d).append(e);this.$(".postLinkPreview").append(f).show(),this.settings.hasPreview=!0,this.$(".linkURLbtn").hide(),this.resetLinkInput(),this.hideLinkInput()}}},loadPreviewAttachment:function(a){this.$(".postLinkPreview").attr("data-Loaded",!0),this.$(".postLinkPreview").append(a).show(),this.settings.hasPreview=!0,this.$(".linkURLbtn").hide(),this.resetLinkInput(),this.hideLinkInput()},removeLink:function(){this.$(".postLinkPreview").empty().attr("data-Loaded",!1).hide(),this.settings.hasPreview=!1,this.$(".linkURLbtn").hide(),this.resetLinkInput()},showModeOptions:function(a){a.preventDefault(),a.stopPropagation(),this.$(".flwOpt").show()},hideModeOptions:function(){this.$(".flwOpt").hide()},selectMode:function(b){this.hideModeOptions();var c=a(b.currentTarget).attr("data-mode");c!=this.settings.mode&&this.switchMode(c)},switchMode:function(a){this.setMode(a),"private"==a?this.showUserSelector():this.hideUserSelector()},setMode:function(a){this.settings.mode=a;var b="public"==a?"icon-earth":"icon-users-2";this.$(".follow-mode").removeClass("icon-earth icon-users-2").addClass(b)},showUserSelector:function(){this.$(".postUsers").show(),this.userInput.getFocus()},hideUserSelector:function(){this.$(".postUsers").hide(),this.userInput.reset()},userBrowser:function(){var a=f.browser({onFinish:this.setUsers}),b=this.userInput.getSelected();a.selectUsers(b)},setUsers:function(a){this.userInput.reset().addUsers(a)},hideInactive:function(){this.$(".commfollowers").hide(),this.$(".attach").hide(),this.$(".addTag").hide(),this.$(".addPic").hide()},loadContent:function(b){var c=e.htmlUnescape(b),d=a("<div/>").append(c),f=d.filter(function(){return a(this).hasClass("vidthumbnail")||a(this).hasClass("webthumbnail")});f.length&&(this.model.set({hasPreview:!0}),this.loadPreviewAttachment(f));var g=d.not(".vidthumbnail,.webthumbnail");this.$(".commInput").empty().html(g)},applyStyle:function(b){var c=a(b.currentTarget).attr("data-cmd");this.formatDoc(c),this.toggleCommand(c)},checkCommands:function(){this.toggleCommand("bold"),this.toggleCommand("italic"),this.toggleCommand("underline")},toggleCommand:function(a){document.queryCommandState(a)?this.$(".intLink[data-cmd="+a+"]").addClass("active"):this.$(".intLink[data-cmd="+a+"]").removeClass("active")},setColor:function(b){var c=a(b.currentTarget).val();this.formatDoc("forecolor",c)},formatDoc:function(a,b){document.execCommand(a,!1,b),this.$(".commInput").focus()},focus:function(){this.$(".commInput").css("border-color","#04bfbf")},showTaginput:function(){a(".addTag").hide(),this.$(".tagData").show()},loadTags:function(a){if(a instanceof Array)for(var b="",c=0;c<a.length;c++)b+=a[c]+",";this.$(".tagInput").importTags(b)},showFileSelector:function(){akp_ws.fileSelector(this.selectedFile)},showCategory:function(){this.$(".postCategories").show()},showCategories:function(){this.$(".postCategories").focus(),this.$(".postcategorieslist").show()},selectedFile:function(a){if(a.length){var b=this.models2data(a);this.loadFiles(b)}},showFileList:function(){this.$(".postAttachments").show()},loadFiles:function(b){for(file in b){var c=b[file];this.settings.attachments.push(c);var d=this.getFile(c);d.find(".rmAttach").bind("click",{file:c},this.removeAttachment),a("<li/>").addClass("semAttach").append(d).appendTo(this.$(".postAttachments ul"))}},removeAttachment:function(b){for(var c=b.data.file,d=this.settings.attachments.length,e=this.settings.attachments,f=0;d>f;f++){var g=e[f];if(g.path==c.path){a(b.currentTarget).parents("li.semAttach").remove(),this.settings.attachments.splice(f,1);break}}},getFile:function(b){var c={};a.extend(c,b);var d=e.mime2class(c.type),f=e.convBytes(c.size,2);return c.mime="true"==c.isdir?"akorp-mime-directory":d,c.size=f,c.hasRemove=!0,a("#attachment-template").tmpl([c])},selectCategory:function(b){this.$(".postcategorieslist").hide();var c=a(b.currentTarget).text(),d=a(b.currentTarget).attr("data-name");this.$(".selectedCTG").children(".CTGname").html(c).attr("data-name",d)},setCategory:function(a){this.$(".selectedCTG").children(".CTGname").html(a).attr("data-name",a)},getTags:function(){var a=this.$(".tagInput").val();return a?a.split(","):[]},models2data:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=d.toJSON();b.push({isdir:e.isdir,path:e.path,type:e.type,size:e.size,fname:e.fname})}return b},formatContent:function(a){return e.htmlEscape(a.find("a[href]").attr("target","_blank").end().html())},share:function(){if(this.$(".commInput").text().length){var a=this.formatContent(this.$(".commInput"));this.settings.hasPreview&&(a+=this.$(".postLinkPreview").html());var b=this.getTags(),c=new Date,d=this.$(".selectedCTG").children(".CTGname").attr("data-name"),e=this.settings.attachments;if(this.model){var f=this.model.toJSON();this.sendreq(a,f.id,f.parent,f.root,this.settings.type,f.create_timestamp,c.getTime(),b,d,e)}else this.sendreq(a,0,0,0,"new",c.getTime(),c.getTime(),b,d,e);this.settings.attachments=[],this.blur()}},sendreq:function(a,b,c,e,f,g,h,i,j,k){var l=akp_ws.createUUID(),m={service:"kons",mesgtype:"request",request:f,uid:d.loginuserid,cookie:l,parent:c,content:a,create_timestamp:g,gid:d.cgd,edit_timestamp:h,root:e,taglist:i,attachments:k};this.settings.enableCategories&&(m.category=j),"edit"==this.settings.type&&(m.id=b),"private"==this.settings.mode&&(m.followers=this.userInput.getSelected(),m.followers.push(d.loginuserid)),"function"==typeof this.settings.onShare&&this.settings.onShare.apply(this,[m])},blur:function(){this.$(".postcancel").fadeOut(),this.$(".postcategorieslist").hide(),this.$(".postUsers").hide(),this.$(".postLinkPreview").hide(),this.$(".tagData").hide(),this.$(".linkData").hide(),this.settings.autoFocus||this.$(".post-action").hide("slow","swing"),this.settings.enableCategories||this.$(".postCategories").hide(),this.reset()},reset:function(){this.settings.autoFocus||this.$el.attr("data-expanded","false").removeClass("editing");var b=a("<span/>").addClass("dfltcmttxt").append("What's up...");this.$(".commInput").empty().append(b).blur(),this.$(".postAttachments").hide().children("ul").empty();var c=this.$(".postcategorieslist").children(".postcategory:first").text();this.$(".selectedCTG").children(".CTGname").html(c),this.$(".addTag").show(),this.$(".tagInput").importTags(""),this.setMode("public"),this.userInput.reset(),this.settings.attachment=[],this.$(".postLinkPreview").empty().attr("data-Loaded",!1),this.$(".postURL").val(""),this.$(".linkURLbtn").show(),this.resetLinkInput(),this.$(".selectedCTG").children(".CTGname").html(c),this.settings.hasPreview=!1,this.$(".follow-mode").removeClass("icon-earth icon-users-2").addClass("icon-earth"),this.settings.state="mute",this.disableShare()},cancel:function(){this.blur(),"function"==typeof this.settings.onCancel&&this.settings.onCancel.apply(this)},clear:function(){this.$(".dfltcmttxt").remove(),this.$el.addClass("editing")},remove:function(){a(this.el).remove()}}),y=function(){this.Queries={}};y.prototype.set=function(a,b){this.Queries[a]=b},y.prototype.get=function(a){return this.Queries[a]};{var z=new y,A=c.View.extend({el:a("#userDefaultNewPost"),defaults:{},settings:{attachments:[],mode:"public",hasPreview:!1,state:"mute",images:[],hasImage:!1},events:{"click #defltPostCnt":"ready","contextmenu #defltPostCnt":"ready","paste #defltPostCnt":"checkURL","keyup  #defltPostCnt":"checkContent","click #addTag":"showTaginput","click .linkURLbtn":"showLinkInput","paste .postURL":"checkURL","click .addURL":"loadURL","click #attachFiles":"showFileSelector","click #postCategories":"showCategories","click .postcategory":"selectCategory","click .intLink":"applyStyle","change .colorLink":"setColor","mouseup  #defltPostCnt":"checkCommands","click .commflw":"showModeOptions","click .opt":"selectMode","click .ubrowser":"userBrowser","click #shareSubmit":"share","click #postcancel":"blur","click .pickPic":"callFileInput","change .fpicselector":"showPics"},initialize:function(){b.bindAll(this,"selectedFile","selectMode","hideModeOptions","removeAttachment","setUsers","callFileInput","loadLinkPreview","removeLink"),this.collection.bind("clear",this.blur,this),this.$el.attr("data-expanded","false"),this.$("#tagData").hide(),this.$(".linkData").hide(),this.$("#postCategories").hide(),this.$("#postcategorieslist").hide(),this.$(".postUsers").hide(),this.$(".postLinkPreview").hide(),this.$("#tagInput").val(""),this.$("#tagInput").tagsInput({height:"auto",width:"auto"}),this.userInput=f.selector({el:this.$(".userData")}).render(),a(document).click(this.hideModeOptions)},clearView:function(){},checkContent:function(b){var c=a(b.currentTarget).text().length;0>=c?this.disableShare():this.activateShare()},activateShare:function(){this.$("#shareSubmit").removeAttr("disabled")},disableShare:function(){this.$("#shareSubmit").attr("disabled","disabled")},callFileInput:function(){this.$(".fpicselector").click()},showLinkInput:function(b){a(b.currentTarget).hide(),this.$(".linkData").show()},hideLinkInput:function(){this.$(".linkData").hide()},checkURL:function(a){{var b=a.originalEvent.clipboardData.getData("Text");this.parseURL(b)}},loadURL:function(){{var a=this.$(".postURL").val();this.parseURL(a)}},validateURL:function(){this.$(".addURL").removeClass(" greenbtn  icon-checkmark").addClass("icon-spinner-2").unbind(),this.$(".postURL").attr("disabled",!0)},resetLinkInput:function(){this.$(".addURL").addClass("btn greenbtn btn-icon icon-checkmark").removeClass("icon-spinner-2").bind("click",this.loadURL),this.$(".postURL").attr("disabled",!1)},parseURL:function(a){var b=e.isURL(a);if(!b)return!1;this.validateURL();var c=e.youtubeURL(a);return c?(this.loadVideoPreview(c),this.hideLinkInput(),!0):(this.getURLPreview(a),void 0)},getURLPreview:function(a){var b=akp_ws.createUUID(),c={service:"kons",url:a,mesgtype:"request",request:"create_thumbnail",cookie:b,uid:d.loginuserid};akp_ws.send(c),z.set(b,this.loadLinkPreview)},onPaste:function(a){var b=a.originalEvent.clipboardData.getData("Text"),c=e.isURL(b);if(c){var d=e.youtubeURL(b);d&&this.loadVideoPreview(d)}},loadLinkPreview:function(b){if("edit"==this.settings.state){var c=this.$(".postLinkPreview").attr("data-Loaded");if("true"!=c&&b.title){this.$(".postLinkPreview").attr("data-Loaded",!0);var d="",e="",f="",g="",h="",i="";b.image&&(d=a("<img/>").attr("src",b.image).addClass("thumbnail")),e=a("<span><a href='"+b.url+"' target='_blank'>"+b.title+"</a></span>").addClass("title"),g=a("<span/>").append(b.url).addClass("link"),f=a("<p/>").append(b.description),i=a("<span />").addClass("icon-cross linkRemove").bind("click",this.removeLink);var h=a("<div/>").append(e).append(g).append(f),j=a("<div/>").append(d).append(h).append(i).addClass("webthumbnail");this.$(".postLinkPreview").append(j).show(),this.settings.hasPreview=!0,this.$(".linkURLbtn").hide(),this.resetLinkInput(),this.hideLinkInput()}}},loadVideoPreview:function(b){if("edit"==this.settings.state){var c=this.$(".postLinkPreview").attr("data-Loaded");if("true"!=c){this.$(".postLinkPreview").attr("data-Loaded",!0);var d=a('<iframe width="560" height="315" src="http://www.youtube.com/embed/'+b+'?wmode=transparent&rel=0" frameborder="0" allowfullscreen></iframe>').css({width:"100%"}),e=a("<span />").addClass("icon-cross linkRemove").bind("click",this.removeLink),f=a("<div />").addClass("vidthumbnail").append(d).append(e);this.$(".postLinkPreview").append(f).show(),this.settings.hasPreview=!0,this.$(".linkURLbtn").hide(),this.resetLinkInput(),this.hideLinkInput()}}},removeLink:function(){this.$(".postLinkPreview").empty().attr("data-Loaded",!1).hide(),this.settings.hasPreview=!1,this.$(".linkURLbtn").hide(),this.resetLinkInput()},getYouTubeInfo:function(b){a.ajax({url:"http://gdata.youtube.com/feeds/api/videos/"+b+"?v=2&alt=json",dataType:"jsonp",success:function(a){parseresults(a)}})},parseresults:function(b){var c=b.entry.title.$t,d=b.entry.media$group.media$description.$t,e=b.entry.yt$statistics.viewCount,f=b.entry.author[0].name.$t;a("#title").html(c),a("#description").html("<b>Description</b>: "+d),a("#extrainfo").html("<b>Author</b>: "+f+"<br/><b>Views</b>: "+e),getComments(b.entry.gd$comments.gd$feedLink.href+"&max-results=50&alt=json",1)},showPics:function(a){if(!this.settings.hasImage){var b=a.currentTarget.files[0];this.preResizeImg(b),this.settings.hasImage=!0}},loadImg:function(a){var b=this;if(a.type.match(/image.*/)){var c=document.createElement("img");c.file=a,c.height=300,c.width=500;var d=new FileReader;d.onload=function(a){c.onload=function(){b.displayImage(c)},c.src=a.target.result},d.readAsDataURL(a)}},preResizeImg:function(a){var b=document.getElementById("postImgCanvas"),c=document.createElement("img"),d=new FileReader;d.onload=function(a){c.src=a.target.result},d.readAsDataURL(a),c.onload=function(){var a=b.getContext("2d");a.drawImage(c,0,0);var d=500,e=400,f=c.width,g=c.height;f>g?f>d&&(g*=d/f,f=d):g>e&&(f*=e/g,g=e),b.width=f,b.height=g;var a=b.getContext("2d");a.drawImage(c,0,0,f,g)}},getImageData:function(){var b=document.getElementById("postImgCanvas"),c=a("<img/>").attr("src",b.toDataURL("image/png"));return a("<div/>").append(c).html()},displayImage:function(a){this.$("#defltPostCnt").append(a)},showModeOptions:function(a){a.preventDefault(),a.stopPropagation(),this.$(".flwOpt").show()},hideModeOptions:function(){this.$(".flwOpt").hide()},selectMode:function(b){this.$(".flwOpt").hide();var c=a(b.currentTarget).attr("data-mode");c!=this.settings.mode&&(this.settings.mode=c,this.switchMode(c))},switchMode:function(a){var b="public"==a?"icon-earth":"icon-users-2";this.$(".follow-mode").removeClass("icon-earth icon-users-2").addClass(b),"private"==a?this.showUserSelector():this.hideUserSelector()},showUserSelector:function(){this.$(".postUsers").show()},hideUserSelector:function(){this.$(".postUsers").hide(),this.userInput.reset()},userBrowser:function(){var a=f.browser({onFinish:this.setUsers}),b=this.userInput.getSelected();a.selectUsers(b)},setUsers:function(a){this.userInput.reset().addUsers(a)},applyStyle:function(b){var c=a(b.currentTarget).attr("data-cmd");this.formatDoc(c),this.toggleCommand(c)},checkCommands:function(){this.toggleCommand("bold"),this.toggleCommand("italic"),this.toggleCommand("underline")
},toggleCommand:function(a){document.queryCommandState(a)?this.$(".intLink[data-cmd="+a+"]").addClass("active"):this.$(".intLink[data-cmd="+a+"]").removeClass("active")},setColor:function(b){var c=a(b.currentTarget).val();this.formatDoc("forecolor",c)},formatDoc:function(a,b){document.execCommand(a,!1,b),this.$("#defltPostCnt").focus()},ready:function(){"false"==this.$el.attr("data-expanded")&&(this.$el.addClass("maxView"),this.$(".post-action").show("slow","swing"),this.$("#dpt-text").remove(),this.$("#defltPostCnt").empty().parent().parent().css("min-height","60px"),this.$("#postcancel").fadeIn(),this.$("#postCategories").fadeIn(),this.$el.attr("data-expanded","true"),this.settings.state="edit")},showTaginput:function(b){a(b.currentTarget).hide(),this.$("#tagData").show()},showFileSelector:function(){akp_ws.fileSelector(this.selectedFile)},showCategories:function(){this.$("#postCategories").focus(),this.$("#postcategorieslist").show()},selectedFile:function(b){if(b.length){this.settings.attachments.push.apply(this.settings.attachments,this.models2data(b)),this.$("#postAttachments").show();for(file in b){var c=b[file],d=c.toJSON(),e=this.getFile(d);e.find(".rmAttach").bind("click",{file:d},this.removeAttachment),a("<li/>").addClass("pstAttach").append(e).appendTo("#postAttachments ul")}}},removeAttachment:function(b){for(var c=b.data.file,d=this.settings.attachments.length,e=this.settings.attachments,f=0;d>f;f++){var g=e[f];if(g.path==c.path){a(b.currentTarget).parents("li.pstAttach").remove(),this.settings.attachments.splice(f,1);break}}},getFile:function(b){var c=e.mime2class(b.type),d=e.convBytes(b.size,2);return b.mime="true"==b.isdir?"akorp-mime-directory":c,b.size=d,b.hasRemove=!0,a("#attachment-template").tmpl([b])},selectCategory:function(b){this.$("#postcategorieslist").hide();var c=a(b.currentTarget).text(),d=a(b.currentTarget).attr("data-name");this.$(".selectedCTG").children(".CTGname").html(c).attr("data-name",d)},getTags:function(){var a=this.$("#tagInput").val();return a?a.split(","):[]},share:function(){var a=this.formatContent(this.$("#defltPostCnt"));this.settings.hasPreview&&(a+=this.$(".postLinkPreview").html()),this.settings.hasImage&&(a+=this.getImageData());var b=this.getTags(),c=new Date,d=this.$(".selectedCTG").children(".CTGname").attr("data-name"),e=this.settings.attachments;this.$("#defltPostCnt").text().length&&this.sendreq(a,0,"post",c.getTime(),b,d,e),this.settings.attachments=[],this.blur()},models2data:function(a){for(var b=[],c=0;c<a.length;c++){var d=a[c],e=d.toJSON();b.push({isdir:e.isdir,path:e.path,type:e.type,size:e.size,fname:e.fname})}return b},formatContent:function(a){return e.htmlEscape(a.find("a[href]").attr("target","_blank").end().html())},sendreq:function(a,b,c,e,f,g,h){var i=akp_ws.createUUID(),j={service:"kons",mesgtype:"request",request:"new",uid:d.loginuserid,cookie:i,parent:b,content:a,create_timestamp:e,gid:d.cgd,edit_timestamp:e,root:b,category:g,taglist:f,attachments:h};return"private"==this.settings.mode&&(j.followers=this.userInput.getSelected(),j.followers.push(d.loginuserid)),this.isValid(a)?(akp_ws.send(j),void 0):(alert("Invalid Text. Please Enter Plain text only."),void 0)},isValid:function(a){try{{JSON.parse(JSON.stringify({content:a}))}return!0}catch(b){return!1}},blur:function(){this.$el.removeClass("maxView"),this.$("#postcancel").fadeOut(),this.$(".post-action").hide("slow","swing"),this.$("#tagData").hide(),this.$(".linkData").hide(),this.$("#postCategories").hide(),this.$("#postcategorieslist").hide(),this.$(".postUsers").hide(),this.$(".postLinkPreview").hide(),this.reset()},reset:function(){this.$el.attr("data-expanded","false"),this.$("#defltPostCnt").empty().append("<p id='dpt-text'>What's up...</p>").blur().parent().parent().css("min-height","40px"),this.$("#postAttachments").hide().children("ul").empty();var a=this.$("#postcategorieslist").children(".postcategory:first").text();this.$(".postLinkPreview").empty().attr("data-Loaded",!1),this.$("#postImgCanvas").attr({height:0,width:0}),this.$(".postURL").val(""),this.$(".linkURLbtn").show(),this.resetLinkInput(),this.$(".selectedCTG").children(".CTGname").html(a),this.$("#addTag").show(),this.$("#tagInput").importTags(""),this.userInput.reset(),this.settings.attachments=[],this.settings.mode="public",this.settings.hasPreview=!1,this.settings.hasImage=!1,this.$(".follow-mode").removeClass("icon-earth icon-users-2").addClass("icon-earth"),this.settings.state="mute",this.disableShare()}}),B=new p,C=(new A({collection:B}),new u({collection:B})),D=(new w({collection:B}),new q({posts:B})),E=new l;new m({collection:E,posts:B})}return g}),define("akpvault",["require","jquery","underscore","backbone","akpauth","akputils","pdfOpener","appViews","plugins/gettheme","plugins/jqxcore","plugins/jqxwindow","plugins/jqxtree","plugins/FileSaver","plugins/jquery.percentageloader-01a","plugins/jquery-tmpl","plugins/noty_full","plugins/jquery.tagsinput.min"],function(a,b,c,d,e,f,g){loader(10,"vault Loaded");var h=d.Model.extend({defaults:{service:"fmgr"}}),i=d.Collection.extend({model:h,home:null,mapReq:{},initialized:!1,settings:{clientCWD:"",groupCWD:"",viewState:"home"},initialize:function(){this.isVisible=!1,this.maxUploadLimit="524288000",c.bindAll(this,"dwmessage","downloadPost","handleViewChange","download_msg"),this.bind("add",this.routeReq,this),this.bind("newwnd",this.getNewWindow,this),this.bind("download",this.handleFileWrite,this),this.bind("changeFolder",this.changeHome,this),this.Dworker=new SharedWorker("Download_worker.js"),this.Dworker.onerror=this.werror,this.Dworker.port.start(),this.Dworker.port.onerror=this.werror,this.Dworker.port.onmessage=this.dwmessage,this.Dworker.port.postMessage({obj:{mesgtype:"clearFS"}}),this.downloads=new w,this.downloadsView=new x({collection:this.downloads,controller:this}),this.downloads.bind("removeDownload",this.downloadPost,this)},handleViewChange:function(a){"container"!=a.title||this.isVisible?this.isVisible&&(this.isVisible=!1,this.trigger("hidden")):(this.isVisible=!0,this.trigger("shown"))},start:function(a){akp_ws.appView.navView.bind("viewChange",this.handleViewChange,this),this.gohome(a.homedir),this.addBookmarks(a.bookmarks)},meta:function(a,b){return void 0===b?this._meta[a]:(this._meta[a]=b,void 0)},clipboardData:null,dwmessage:function(a){var b=a.data;if(b.file){if("ack"==b.file.mesgtype||"request"==b.file.mesgtype||"cancel"==b.file.mesgtype)b.file.uid=e.loginuserid,this.send(b.file,this.download_msg),this.downloadsView.updateProgress(b.percent,b.progressed);else if("save"==b.file.mesgtype){this.trigger("downloads_update",b.percent);var c=b.file.dfname.substring(b.file.dfname.lastIndexOf("/")+1,b.file.dfname.length);saveAs(b.file.fl,c),this.downloads.trigger("fileCompleted")}}else;},werror:function(a){consloe.log("ERROR: Line ",a.lineno," in ",a.filename,": ",a.message)},download_msg:function(a){{var b;a.data}if(a.error)return console.log(a.error),!1;try{b=window.atob(a.data)}catch(c){return console.log("unable decode base64 data, NOT BASE64 DATA"),!1}a.data=b,this.downloadPost({obj:a})},downloadPost:function(a){this.Dworker.port.postMessage(a)},handleFileWrite:function(a){var c=a,d=this;this.trigger("downloadPush"),b.each(c,function(a,b){var c=b.toJSON(),f=c.path,g=c.size,h=f.substring(f.lastIndexOf("/")+1,f.length);if("true"!=c.isdir){var i=akp_ws.createUUID(),j={mesgtype:"request",service:"fmgr",request:"read",cookie:i,fname:f,size:1024,uid:e.loginuserid};d.downloadPost({obj:j,siz:g}),d.downloads.add({name:h,size:g})}else d.trigger("downloadErr",h)})},showSelector:function(a){var b=new q({onSelected:a,CWD:this.groupHome,home:this.groupHome});return b},FSDialog:function(a){return new o(a)},FVDialog:function(a){return new n(a)},gohome:function(a){this.cwd=a,this.cleintHome=a,this.settings.clientCWD=a,this.trigger("setHome",a)},setGHome:function(a){this.groupHome=a,this.settings.groupCWD=a,this.trigger("setGroup",a)},addBookmarks:function(a){this.bookmarks=a},changeHome:function(a){"phome"==a&&this.home==this.cleintHome||"ghome"==a&&this.home==this.groupHome||("phome"==a?(this.home=this.cleintHome,this.trigger("switchHome",this.settings.clientCWD,this.home),this.settings.viewState="home"):"ghome"==a&&(this.home=this.groupHome,this.trigger("switchHome",this.settings.groupCWD,this.home),this.settings.viewState="group"))},getViewState:function(){return this.settings.viewState},handleMessage:function(a){akp_ws.getMap(a);var b=this.mapReq[a.cookie];b?b.apply(this,[a]):this.handleMsg(a)},routeReq:function(a){var b=a.toJSON();this.handleMessage(b)},picUpdate:function(a){this.send(a,this.picResp)},picResp:function(a){akp_ws.picUpdate(a)},handleMsg:function(a){"error"==a.mesgtype?this.trigger("error",a):"notification"==a.mesgtype&&this.trigger("notification",a.notification)},send:function(a,b){akp_ws.send(a),this.mapReq[a.cookie]=b},getNewWindow:function(a,b){new r({dir:a,home:b||this.home})},getUserHome:function(){return this.cleintHome},FileBrowser:function(a){a.home||(a.home=this.groupHome);new r(a)},clear:function(){},changeGroup:function(a){this.trigger("clear"),this.initialized||(this.trigger("initialized"),this.trigger("bookmarks",this.bookmarks),this.initialized=!0),this.setGHome(a.homedir)}}),j=d.Model.extend({idAttribute:"path",defaults:{isSelected:!1,isOpened:!1,isByView:!1}}),k=d.Collection.extend({model:j,initialize:function(){this.context={},this._meta={filesCopied:!1,copiedList:[]},c.bindAll(this,"loadFiles","update","handleResponse","handleFileOperationResponse"),this.bind("change",this.update,this),this.bind("goHome",this.setHome,this),this.bind("goPath",this.goPath,this),this.bind("refresh",this.refresh,this),this.bind("cut",this.cutaction,this),this.bind("copy",this.copyaction,this),this.bind("paste",this.pastefiles,this),this.bind("delete",this.remove,this),this.bind("search",this.makeSearch,this),this.bind("add",this.addFiles,this)},meta:function(a,b){return void 0===b?this._meta[a]:(this._meta[a]=b,void 0)},refresh:function(){this.unselect(),this.closeOpened()},openGtkFile:function(a,b){var c=akp_ws.createUUID(),d={uid:e.loginuserid,dname:a,cookie:c,mesgtype:"request",request:"open",service:"fmgr"};J.send(d,b)},cutaction:function(){var a={filesCopied:!0,action:"move",actionSource:this.meta("cwd"),copiedList:this.getSelected()};J.clipboardData=a},copyaction:function(){var a={filesCopied:!0,action:"copy",actionSource:this.meta("cwd"),copiedList:this.getSelected()};J.clipboardData=a},pastefiles:function(a){if(J.clipboardData){for(var b=J.clipboardData,c=b.action,d=b.actionSource,e=b.copiedList,f=[],g=akp_ws.createUUID(),h=0;h<e.length;h++)f.push(e[h].get("fname"));a||(a=this.meta("cwd"));var i={mesgtype:"request",service:"fmgr",request:c,cookie:g,source:d,destination:a,srcargs:f};J.send(i,this.handleFileOperationResponse),"move"==c&&this.emptyClipboard()}},remove:function(){var a=this.getSelected(),c=[];b.each(a,function(a,b){c.push(b.get("fname"))});var d=akp_ws.createUUID(),e={mesgtype:"request",service:"fmgr",request:"remove",cookie:d,source:this.meta("cwd"),srcargs:c};J.send(e,this.handleResponse)},replaceRootInPath:function(a){var b=a,c=new RegExp(J.cleintHome,"gi"),d=a.match(c),e=a.match(new RegExp(J.groupHome,"gi"));return null!=d?d.length&&(b=b.replace(J.cleintHome,"Home")):null!=e&&e.length&&(b=b.replace(J.groupHome,"Group")),b},getHomeFromPath:function(a){var b=new RegExp(J.cleintHome,"gi"),c=a.match(b),d=a.match(new RegExp(J.groupHome,"gi"));if(null!=c){if(c.length)return J.cleintHome}else if(null!=d&&d.length)return J.groupHome;return!1},getFileNameFromPath:function(){},cancelSearch:function(){if(this.meta("search_id")){var a={service:"fmgr",cookie:this.meta("search_id"),mesgtype:"request",request:"cancel"};this.meta("search_id",!1),J.send(a)}},makeSearch:function(a){if(this.cancelSearch(),a.length<3)return this.trigger("noSearch"),void 0;var b=akp_ws.createUUID(),c={service:"fmgr",mesgtype:"request",request:"search",cookie:b,dname:this.meta("cwd"),key:a};this.meta("search_id",c.cookie),J.send(c,this.handleSearchResults)},handleSearchResults:function(a){K.trigger("addResult",a)},emptyClipboard:function(){J.clipboardData=null},handleFileOperationResponse:function(a){a.status?this.trigger("refresh"):this.handleOperationMsg(a)},handleOperationMsg:function(a){this.trigger("question",a)},handleResponse:function(){this.trigger("refresh")},update:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"isOpened":var d=a.get(c);d&&(this.meta("cwd",a.get("path")),this.getTree())}},sendQuestionResponse:function(a,b){var c={mesgtype:"answer",service:"fmgr",cookie:a.cookie,answer:b};J.send(c,this.handleFileOperationResponse)},setHome:function(){this.unselect(),this.closeOpened(),this.meta("cwd",this.meta("home"))},goPath:function(){this.unselect(),this.closeOpened(),this.getTree()},getParent:function(){this.meta("cwd",this.context.parent),this.getTree()},getTree:function(){var a=akp_ws.createUUID(),b=this.meta("cwd"),c={mesgtype:"request",service:"fmgr",request:"getdir",cookie:a,dname:b};J.send(c,this.loadFiles),this.trigger("showPath",b),this.trigger("inHome",this.meta("cwd")==this.meta("home"));try{var d=this.where({path:b})[0];this.context=d?d.toJSON():{parent:this.meta("home"),path:this.meta("home"),home:this.meta("home"),isdir:"true"}}catch(e){console.log(e.message)}this.reset()},returnAsEmptyFolder:function(){this.isEmptyCheck=!0;var a=this,c=b('<span class="loadpercentage icon-spinner-3"></span> ').css({"font-size":"16px",width:"16px",color:"inherit","line-height":"15px"}),d=b("<div/>").append(c).append(" Loading...").html();this.trigger("itemsCount",d),this.isEmptyCheckTimer=setTimeout(function(){a.showCount(),a.trigger("isEmptyFolder",!0)},1)},addFiles:function(){this.isEmptyCheck&&(isEmptyCheck=!1,clearTimeout(this.isEmptyCheckTimer),this.trigger("isEmptyFolder",!1))},createFile:function(a,b){var c=akp_ws.createUUID(),d=this.meta("cwd"),e={mesgtype:"request",service:"fmgr",request:"create_file",cookie:c,source:d,srcargs:a};J.send(e,b)},createFolder:function(a,b){var c=akp_ws.createUUID(),d=this.meta("cwd"),e={mesgtype:"request",service:"fmgr",request:"create_dir",cookie:c,source:d,srcargs:a};J.send(e,b)},loadFiles:function(a){var b=a.direlements.length;if(!b)return this.returnAsEmptyFolder(),void 0;for(var c=0;b>c;c++){var d=a.direlements[c];d.path=this.meta("cwd")+"/"+d.fname,d.parent=this.meta("cwd"),d.home=this.meta("home"),d.formatedSize=f.convBytes(d.size,2),this.add(d)}this.showCount(b)},showCount:function(){var a=this.where({isdir:"true"}).length+" Folder(s), "+this.where({isdir:"false"}).length+" File(s)";this.trigger("itemsCount",a)},closeOpened:function(){this.filter(function(a){1==a.get("isOpened")&&a.set({isOpened:!1,isByView:!1})})},getRoots:function(a){for(var b,c=a.split("/"),d=[],e=!1,f=this.meta("home"),g="",h=0;h<c.length;h++)if(c[h]&&(g+="/"+c[h],g==f&&(e=!0),e)){b=g==f?this.replaceRootInPath(g):c[h];var i={name:b,path:g};d.push(i)}return d},getSelected:function(){var a=[];return a=this.where({isSelected:!0})},unselect:function(){this.filter(function(a){1==a.get("isSelected")&&a.set({isSelected:!1})})},clear:function(){this.trigger("clear")}}),l=d.View.extend({el:b(".searchResults"),initialize:function(){c.bindAll(this,"render","removeOldResults","insertResult"),this.collection.bind("search",this.removeOldResults,this),this.collection.bind("addResult",this.insertResult,this),this.collection.bind("noSearch",this.hide,this),this.collection.bind("clear",this.clear,this)},render:function(){return this},show:function(){this.$el.is(":visible")||this.$el.show()},hide:function(){this.$el.hide()},insertResult:function(a){this.show();var b=new m({model:a,collection:this.collection});this.$el.append(b.render().el)},removeOldResults:function(){this.show(),this.$el.empty().append("Searching..")},clear:function(){this.$el.empty(),this.hide()}}),m=d.View.extend({className:"resultItem",events:{click:"openNewWnd"},initialize:function(){var a=this.model,b=("true"==a.isdir?a.fpath+"/"+a.fname:a.fpath,"true"==a.isdir?"css/images/folder.png":"css/images/mimes/undefined.png");this.$el.append("<img src='"+b+"' height=48 width=48 alt='file' />").append("<span>"+this.collection.replaceRootInPath(a.fname)+"</span>")},render:function(){return this},openNewWnd:function(){console.log("path:"+this.model.fpath),J.trigger("newwnd",this.model.fpath)}}),n=d.View.extend({events:{},initialize:function(a){this.files=a.files,this.collection=new A,this.collection.bind("add",this.addFile2Container,this),this.addFiles(this.files)},render:function(){return this},addFiles:function(a){c.each(a,function(a){a.hasRemove=!1});this.collection.add(a)},addFile2Container:function(a){var b=new p({model:a});this.$el.append(b.render().el)}}),o=d.View.extend({events:{click:"openSelector"},initialize:function(a){c.bindAll(this,"selectedFile"),a.onAdd&&(this.onAdd=a.onAdd),this.$container=a.container,this.collection=new A,this.collection.bind("add",this.addFile2Container,this)},openSelector:function(){J.showSelector(this.selectedFile)},selectedFile:function(a){this.onAdd.call(),this.collection.add(a)},addFile2Container:function(a){var b=new p({model:a});this.$container.append(b.render().el)},addFiles:function(){},getFileList:function(){return this.collection.map(function(a){return c.pick(a.toJSON(),["isdir","path","type","size","fname"])})},render:function(){},reset:function(){this.collection.reset()}}),p=d.View.extend({events:{"click .rmAttach":"removeEl"},initialize:function(){this.model.bind("remove",this.remove,this)},render:function(){var a=this.model2Obj(),b=this.getFile(a);return this.$el.append(b),this},getFile:function(a){var c={};b.extend(c,a);var d=f.mime2class(c.type),e=f.convBytes(c.size,2);return c.mime="true"==c.isdir?"akorp-mime-directory":d,c.size=e,c.hasRemove=c.hasRemove?c.hasRemove:!0,b("#attachment-template").tmpl([c])},model2Obj:function(){var a=this.model.toJSON();return{isdir:a.isdir,path:a.path,type:a.type,size:a.size,fname:a.fname}},removeEl:function(){this.$el.remove()}}),q=d.View.extend({id:"vaultFileSelector",events:{"click .pathdir":"gopath","click .prv":"scrollPath","click .nxt":"scrollPath","click .wnd_parent":"goParent","click .fileselectbtn":"selectFile"},initialize:function(a){this.result=a.onSelected,this.finished=!1,c.bindAll(this,"render","refresh","selectFile","returnEmpty"),this.template=b("#fileSelector-template").tmpl(),this.render(),this.roots=[],this.collection=new k,this.collection.meta("cwd",a.CWD),this.collection.meta("home",a.home),this.collection.bind("showPath",this.showPath,this),this.collection.bind("refresh",this.refreshView,this),this.collection.getTree(),this.subView=new G({collection:this.collection,el:this.$("ul.wnd-file-list"),menu:!0})},render:function(){this.$el.append(this.template),this.$el.jqxWindow({closeButtonAction:"close",height:400,width:600,isModal:!0})},selectFile:function(){var a=this.collection.getSelected();a.length<10&&a.length>0&&(this.finished=!0,this.result.call(this,a),b("#"+this.el.id).jqxWindow("close"),this.$el.remove())},returnEmpty:function(){this.finished||this.result.call(this,[])},showFiles:function(a){var b=new H({model:a});this.$(".wndView ul").append(b.render().el)},refresh:function(){this.collection.trigger("refresh")},refreshView:function(){this.collection.getTree()},goParent:function(){if(this.collection.meta("cwd")!=this.collection.meta("home")){this.collection.trigger("goParent");var a=this.collection.meta("cwd"),b=a.substring(0,a.lastIndexOf("/"));this.collection.meta("cwd",b),this.collection.getTree()}},handleFolderResponse:function(){this.refresh()},handleDownloads:function(){var a=this.collection.getSelected();J.trigger("download",a)},scrollPath:function(a){var c;btn=c=b(a.target).hasClass("nxt")?"+":"-",b(a.target).closest(".wndpath").find(".pathdirs").stop().animate({scrollLeft:c+"=200"},1e3)},showPath:function(){var a=this.$(".wndpath ul.pathdirs"),c=this.collection.meta("cwd"),d=this.collection.getRoots(c);a.empty();for(var e=0;e<d.length;e++)a.append(b("<li/>").append(d[e].name).attr("data-pathid",d[e].path).addClass("pathdir"))},gopath:function(a){var c=b(a.target).attr("data-pathid");this.collection.meta("cwd",c),this.subView.render(),this.collection.getTree()}}),r=d.View.extend({events:{"click .pathdir":"gopath","click .prv":"scrollPath","click .nxt":"scrollPath","click .wnd_refresh":"refresh","click .wnd_parent":"goParent","click .wnd_newfolder":"createFolder"},initialize:function(a){c.bindAll(this,"render","refresh"),this.template=b("#window-template").tmpl(),this.render(),this.roots=[],this.collection=new k,this.setDefaults(a),this.collection.meta("home",a.home),this.collection.bind("showPath",this.showPath,this),this.collection.bind("refresh",this.refreshView,this),this.collection.bind("newfolder",this.createFolder,this),this.collection.bind("download",this.handleDownloads,this),this.collection.getTree(),this.subView=new G({collection:this.collection,el:this.$("ul.wnd-file-list"),menu:!1,selectFile:a.file})},setDefaults:function(a){if(a.dir)this.collection.meta("cwd",a.dir);else if(a.file){var b=a.file.substr(0,a.file.lastIndexOf("/"));this.collection.meta("cwd",b)}},render:function(){this.$el.append(this.template).jqxWindow({closeButtonAction:"close",height:400,width:600})},showFiles:function(a){var b=new H({model:a});this.$(".wndView ul").append(b.render().el)},refresh:function(){this.collection.trigger("refresh")},refreshView:function(){this.collection.getTree()},goParent:function(){if(this.collection.meta("cwd")!=this.collection.meta("home")){this.collection.trigger("goParent");var a=this.collection.meta("cwd"),b=a.substring(0,a.lastIndexOf("/"));this.collection.meta("cwd",b),this.collection.getTree()}},createFolder:function(){var a=this;b("<div/>").addClass("dialogClass").append("<p><span style='float:left; margin:0 7px 20px 0;'> </span>Enter The Folder Name:<input type='text' id='flname'></p>").dialog({resizable:!1,title:"Prompt",height:170,modal:!0,buttons:[{text:"Create","class":"btn btn-primary",click:function(){if(""!=b("input#flname").val()){var c=[b("input#flname").val()];a.collection.createFolder(c,a.refresh),b(this).dialog("close").remove()}}},{text:"Cancel","class":"btn btn-danger",click:function(){b(this).dialog("close").remove()}}]})},handleFolderResponse:function(){this.refresh()},handleDownloads:function(){var a=this.collection.getSelected();J.trigger("download",a)},scrollPath:function(a){var c;btn=c=b(a.target).hasClass("nxt")?"+":"-",b(a.target).closest(".wndpath").find(".pathdirs").stop().animate({scrollLeft:c+"=200"},1e3)},showPath:function(){var a=this.$(".wndpath ul.pathdirs"),c=this.collection.meta("cwd"),d=this.collection.getRoots(c);a.empty();for(var e=0;e<d.length;e++)a.append(b("<li/>").append(d[e].name).attr("data-pathid",d[e].path).addClass("pathdir"))},gopath:function(a){var c=b(a.target).attr("data-pathid");this.collection.meta("cwd",c),this.subView.render(),this.collection.getTree()}}),s=d.Model.extend({name:null,status:"",changeStatus:function(a){this.set({status:a})}}),t=d.Collection.extend({model:s,initialize:function(){this.bind("remove",this.check,this),this.bind("change",this.handleChange,this)},handleChange:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"cencel":this.cancel(a);break;case"status":}},cancel:function(a){if(!a){var b=this.getActiveUpload();if(!b)return!1;a=b}var c={mesgtype:"cancel",fname:a.get("name"),dname:a.get("dname"),cookie:a.get("id")};this.trigger("removeUpload",c),this.remove(a)},getActiveUpload:function(){return this.where({status:"uploading"})[0]},cancelAll:function(){},check:function(){this.isEmpty()&&this.trigger("uploadsCompleted")}}),u=d.View.extend({el:b("#uploadwindow"),events:{},initialize:function(a){this.controller=a.controller,this.controller.bind("hidden",this.hide,this),this.collection.bind("add",this.addUpload,this),this.collection.bind("fileCompleted",this.removeUpload,this),this.collection.bind("uploadsCompleted",this.hide,this),this.$el.jqxWindow({autoOpen:!1,showCloseButton:!1,showCollapseButton:!0,width:310,height:310,resizable:!1})},render:function(){},hide:function(){this.$el.jqxWindow("hide")},updateProgress:function(a,b,c){var d=this.collection.get(a);d&&d.trigger("update",{perc:b,size:c})},addUpload:function(a){var b=new v({model:a});this.$("#upload_status").append(b.render().el)},removeUpload:function(a){var b=this.collection.get(a);b&&(b.trigger("remove"),this.collection.remove(b))}}),v=d.View.extend({className:"upload_file",events:{"click .uc":"stopUpload"},initialize:function(){this.model.bind("remove",this.cancelUpload,this),this.model.bind("update",this.changeProgress,this);var a=this.model.get("name"),b=(this.model.get("type"),f.convBytes(this.model.get("size"),2));this.$el.append("<div> <span> "+a+' </span> <div class="up_pbar"><span class="up_progress" ></span></div></div>    <div> <span class="percMeter"> 0.00 % </span> | <span class="sizeOver"> 0B </span> / <span> '+b+' </span>  </div> <span class="cancel uc icon-remove-3"></span>')},render:function(){return this},changeProgress:function(a){this.model.changeStatus("uploading");var b=a.perc,c=a.size;this.$(".sizeOver").html(f.convBytes(c,2)),this.$(".percMeter").html(b+"%"),this.$(".up_progress").css({width:Math.round(b)+"%"}).attr("title",Math.round(b)+"%")},stopUpload:function(){this.model.set({cancel:!0})},cancelUpload:function(){this.$el.remove()}}),w=d.Collection.extend({model:s,initialize:function(){this.bind("remove",this.check,this),this.bind("change",this.cancel,this)},cancel:function(a){var b={obj:{mesgtype:"cancel",service:"fmgr",request:"read",fname:a.get("name")}};this.trigger("removeDownload",b),this.remove(a)},check:function(){this.isEmpty()&&this.trigger("downloadsCompleted")}}),x=d.View.extend({el:b("#downloads"),events:{},initialize:function(a){this.controller=a.controller,this.controller.bind("hidden",this.hide,this),this.collection.bind("add",this.addDownload,this),this.collection.bind("fileCompleted",this.removeDownload,this),this.collection.bind("downloadsCompleted",this.hide,this),this.dpr=b("#progress").percentageLoader({width:100,height:100,progress:0,position:{x:200,y:400},animationType:"slide"}),this.$el.jqxWindow({autoOpen:!1,showCloseButton:!1,showCollapseButton:!0,height:300,width:310})},render:function(){},hide:function(){this.$el.jqxWindow("hide")},updateProgress:function(a,b){this.dpr.setProgress(a.toFixed(2));var c=this.collection.first();c&&c.trigger("progress",{percentage:a,progress:b})},addDownload:function(a){var b=new y({model:a});this.$("#dloads").append(b.render().el)},removeDownload:function(){var a=this.collection.first();a&&(a.trigger("remove"),this.collection.remove(a))}}),y=d.View.extend({className:"download_file",events:{"click .dc":"stopDownload"},initialize:function(){this.model.bind("remove",this.cancelDownload,this),this.model.bind("progress",this.updateProgress,this);var a=this.model.get("name"),b=f.convBytes(this.model.get("size"));this.$el.append(a+'<span class="cancel dc icon-remove-3"></span><div class="progressInfo"><span class="progressPercentage">0%</span> | <span class="progressCompleted"> 0B </span>/<span class="progressLoad"> '+b+"  </span></div>")},render:function(){return this},updateProgress:function(a){this.$(".progressPercentage").html((Math.round(1e4*a.percentage)/100).toFixed(2)+"%"),this.$(".progressCompleted").html(f.convBytes(a.progress,2))},stopDownload:function(){this.model.set({cancel:!0})},cancelDownload:function(){this.$el.remove()}}),z=d.Model.extend({idAttribute:"path"}),A=d.Collection.extend({model:z,initialize:function(){},isBookmarked:function(a){return this.get(a)}}),B=d.View.extend({events:{"click .fmgr-add-bookmark":"saveBookmark","click .fmgr-bookmark-list":"showBookmarksList","click .fmgr-bookmark":"hideBookmarkList"},initialize:function(a){c.bindAll(this,"hideBookmarkList"),this.files=a.files,this.root=a.root,this.animation="stoppped",this.root.bind("bookmarks",this.addBookmarks,this),b(document).bind("click",this.hideBookmarkList),this.collection.bind("add",this.renderBookmark,this)},check:function(){this.$(".fmgr-add-bookmark").removeClass("icon-star").addClass("icon-star-2").data("ismarked",!0)},uncheck:function(){this.$(".fmgr-add-bookmark").removeClass("icon-star-2").addClass("icon-star").data("ismarked",!1)},getBookmarks:function(){},renderBookmark:function(a){var c=new C({model:a});b(c.render().el).appendTo(this.$(".fmgr-bm-listPanel"))},startAnimation:function(){this.animation="running";var a=document.querySelector("#akorp-anim-template");this.animTemp=b(a.content.cloneNode(!0)).appendTo(this.$(".fmgr-bm-listPanel"))},stopAnimation:function(){"running"==this.animation&&(this.animation="stopped",this.$(".fmgr-bm-listPanel").data("loaded",!0),this.animTemp.remove())},addBookmarks:function(a){for(var b in a){var c={};c.path=a[b],this.collection.add(c)}},removeBookmarks:function(a){for(var b in a){var c={};c.path=a[b],this.collection.remove(c.path)}},add2Bookmarks:function(){var a=this.files.meta("cwd");b(".fmgr-bm-newpanel").find(".bm-name").val(a).end().find(".bm-path").val(a),b(".fmgr-bm-newpanel").dialog({resizable:!1,height:200,modal:!0,title:"Add Folder Bookmark",buttons:{Save:function(){b(this).dialog("close")},Cancel:function(){b(this).dialog("close")}},open:function(){b(this).closest(".ui-dialog").find(".ui-button:nth-child(2)").addClass("btn redbtn"),b(this).closest(".ui-dialog").find(".ui-button:nth-child(1)").addClass("btn blue")}}),b(".fmgr-bm-newpanel").find(".bm-name")[0].select()},saveBookmark:function(){var a=this.files.meta("cwd");this.$(".fmgr-add-bookmark").data("ismarked")?(this.removeBookmarks([a]),this.uncheck(a)):(this.addBookmarks([a]),e.addBookmark(a),this.check(a))},showBookmarksList:function(a){a.preventDefault(),a.stopPropagation();var b=this.$(".fmgr-bm-listPanel").data("loaded");b?this.showBM_list():(this.getBookmarks(),this.showBM_list())},showBM_list:function(){this.collection.length&&this.$(".fmgr-bm-listPanel").show()},hideBookmarkList:function(){this.$(".fmgr-bm-listPanel").hide()},bookmarkAddResponse:function(){}}),C=d.View.extend({events:{click:"openWindow","click .bm-remove":"removeBookmark"},className:"resultItem",initialize:function(){this.model.bind("remove",this.removeBookmark,this),this.homeDir=this.getPathHome(this.model.get("path"))},render:function(){var a=this.model.toJSON(),c=(b("<div/>").addClass("akorp-mime-directory bm-mime-icon"),b("<span/>").append(this.maskPath(a.path))),d=(b("<span/>").append(this.getName(a.path)),b("<div/>").addClass("bm-info").append(),b("<span/>").addClass("icon-cross-2 akp-close-icon bm-remove"));return this.$el.append(c).addClass("bookmark").append(d),this},maskPath:function(a){var b=new RegExp(J.cleintHome,"gi"),c=a.match(b),d=a.match(new RegExp(J.groupHome,"gi"));return c.length?a=a.replace(J.cleintHome,"Home"):d.length&&(a=a.replace(J.groupHome,"Group")),a},getPathHome:function(a){var b=new RegExp(J.cleintHome,"gi"),c=a.match(b),d=a.match(new RegExp(J.groupHome,"gi"));return c.length?J.cleintHome:d.length?J.groupHome:!1},getName:function(a){return a==J.cleintHome||a==J.groupHome?"Home":a.substr(a.lastIndexOf("/")+1,a.length)},openWindow:function(){J.trigger("newwnd",this.model.toJSON().path,this.homeDir)},removeBookmark:function(a){a.stopPropagation&&a.stopPropagation(),this.$el.remove(),e.removeBookmark(this.model.toJSON().path)}}),D=d.View.extend({el:b("#container"),events:{"dragover #dropzone":"handleDragOver","drop #dropzone":"handleFileSelect","dragenter #dropzone":"handleDragEnter","dragleave #dropzone":"handleDragLeave","click #add_fldr":"createFolder","click #gettree":"flipTree","click #ghome":"toggleGroupFolder","click #phome":"toggleGroupFolder","click #refresh":"refreshView","click #home_folder":"gotoHome","click #parent":"gotoParent","click .pathdir":"gotoPath","click #fmgrUploadsBtn":"showUploads","click #fmgrDloadsBtn":"showDownloads","keyup #fmgrSearchBox":"searchFiles",contextmenu:"disablerightclick","click #upload_btn":"handleBtnUpload","change #upload_input":"handleFileSelect"},defults:{treeView:!1,viewId:"container"},settings:{},initialize:function(a){this.settings=b.extend({},this.defults,a),c.bindAll(this,"render","routeReq","gohome","gotoPath","tree","uwmessage","uploadPost","handleNewFolderResponse","disablerightclick","respondNotification","handleBtnUpload");
var d={el:b(".mt-menu.vault-tab"),service:"file",onNotificationClick:this.respondNotification,className:"blue"};this.notifications=e.notificationDialog(d),this.collection.bind("setHome",this.gohome,this),this.collection.bind("setGroup",this.handleGroupChange,this),this.collection.bind("switchHome",this.switchHome,this),this.collection.bind("downloadErr",this.downloadErr,this),this.collection.bind("downloadPush",this.showDownloadsBtn,this),this.collection.bind("error",this.handleError,this),this.collection.bind("initialized",this.oninit,this),this.collection.bind("notification",this.addNotification,this),this.collection.bind("clear",this.clear,this),this.files=a.files,this.files.bind("newfolder",this.createFolder,this),this.files.bind("alertRemove",this.alertRemove,this),this.files.bind("download",this.handleFileWrite,this),this.files.bind("showPath",this.checkBookmark,this),this.files.bind("showPath",this.showPath,this),this.files.bind("showPath",this.rememberCWD,this),this.files.bind("itemsCount",this.displayCount,this),this.files.bind("isEmptyFolder",this.toggleEmptyFolderMsg,this),this.files.bind("inHome",this.handleInHome,this),this.files.bind("block",this.blockUI,this),this.files.bind("unblock",this.unblockUI,this),this.files.bind("gtkViewer",this.handleGtkViewer,this),this.$el.bind("contextmenu",this.disablerightclick),this.worker=new SharedWorker("Upload_worker.js"),this.worker.port.start(),this.worker.port.onerror=this.werror,this.worker.port.onmessage=this.uwmessage,this.uploadManager={},jQuery.event.props.push("dataTransfer"),this.uploads=new t,this.uploadsView=new u({collection:this.uploads,controller:this.collection}),this.uploads.bind("removeUpload",this.uploadPost,this),this.uploads.bind("uploadsCompleted",this.handleUploadsCompleted,this),this.collection.downloads.bind("downloadsCompleted",this.handleDownloadsCompleted,this),this.gtkViewer=b(".gtkViewer").dialog({width:"100%",autoOpen:!1,modal:!0,minHeight:"800px",open:this.onOpen}),this.gtkViewerFrame=document.getElementById("gtk-vwr-frame").contentWindow,this.bookmarks=new A,this.bookmarksList=new B({el:this.$(".fmgr-bookmarkbar"),collection:this.bookmarks,files:this.files,root:this.collection}),b("#nodes").hide()},handleDownloadsCompleted:function(){b("#fmgrDloadsBtn").hide()},handleUploadsCompleted:function(){b("#fmgrUploadsBtn").hide(),this.refreshView()},handleBtnUpload:function(){var a=this.$("#upload_input");a.click()},rememberCWD:function(){var a=this.files.meta("cwd");this.files.meta("home")==this.collection.cleintHome?this.collection.settings.clientCWD=a:this.collection.settings.groupCWD=a},showPath:function(){var a=this.$(".vaultPath ul.pathdirs"),c=this.files.meta("cwd"),d=this.files.getRoots(c);a.empty();for(var e=0;e<d.length;e++)a.append(b("<li/>").append(d[e].name).attr("data-pathid",d[e].path).addClass("pathdir")).append("<li>/ </li>")},handleGroupChange:function(a){"group"==this.collection.getViewState()&&this.switchHome(a,a)},clear:function(){this.notifications.clear(),"group"==this.collection.getViewState()&&this.files.clear()},oninit:function(){this.notifications.init()},respondNotification:function(a){akp_ws.appView.navView.changeView(this.settings.viewId),this.collection.FileBrowser({file:a.file,home:this.files.getHomeFromPath(a.file)})},addNotification:function(a){a.addTop=!0,this.notifications.attachNotification(a,"inc")},onOpen:function(){var a=b(this);a.closest(".ui-dialog").find(".ui-dialog-titlebar").remove(),a.css({padding:"0"}).closest(".ui-dialog").css({padding:"0","border-radius":"0px"}),$dialogOverlay=b(".ui-widget-overlay").last(),$dialogOverlay.unbind(),$dialogOverlay.click(function(){a.dialog("close")})},handleGtkViewer:function(a){a.data&&(this.gtkViewer.dialog("isOpen")||this.gtkViewer.dialog("open"),this.gtkViewerFrame.postMessage(a.data,"http://www.antkorp.in/"))},blockUI:function(){b("<div/>").append('<span class="loadpercentage icon-spinner-3" style="color:#FFF" ></span>').addClass("blocker blocker-anim").append("Loading..").appendTo(this.$el),b("<div/>").appendTo(this.$el).addClass("blocker blocker-overlay")},unblockUI:function(){this.$(".blocker").remove()},handleInHome:function(a){a?(this.$("#home_folder").attr("disabled",""),this.$("#parent").attr("disabled","")):(this.$("#home_folder").removeAttr("disabled"),this.$("#parent").removeAttr("disabled"))},toggleEmptyFolderMsg:function(a){if(a){var c=b("<div/>").addClass("fmgrInstantMsg").append("Empty Folder").hide();this.$("#dropzone").prepend(c),c.show("slide",{direction:"left"})}else this.$(".fmgrInstantMsg").remove()},displayCount:function(a){this.$(".countbar").html(a)},checkBookmark:function(a){var b=this.bookmarks.isBookmarked(a);b?this.bookmarksList.check():this.bookmarksList.uncheck()},disablerightclick:function(a){return a.preventDefault(),a.stopPropagation(),!1},setRow:function(){var a=this.$("#dropzone").width(),b=Math.floor(a/102),c=b+"n + "+b;this.$("#file-list li:nth-child("+c+")").css({clear:"both"})},render:function(){},showTrash:function(){},routeReq:function(a){console.log(a.toJSON())},handleError:function(a){noty({layout:"bottomRight",theme:"default",type:"error",text:a.estring,timeout:5e3,animation:{easing:"easeOutElastic"}})},searchFiles:function(a){a.stopPropagation();var c=b(a.currentTarget).val();this.files.trigger("search",c),13==a.which&&b(a.currentTarget).select()},switchHome:function(a,b){this.$("#home").attr("data-path",a),this.files.meta("home",b),this.files.meta("cwd",a),this.files.trigger("goPath"),this.collection.home=b},gohome:function(a){this.$("#home").attr("data-path",a),this.files.meta("home",a),this.files.meta("cwd",a),this.files.trigger("goHome"),this.collection.home=a},showUploads:function(){b("#uploadwindow").jqxWindow("isOpen")?b("#uploadwindow").jqxWindow("hide"):b("#uploadwindow").jqxWindow("show")},showDownloads:function(){b("#downloads").jqxWindow("isOpen")?b("#downloads").jqxWindow("hide"):b("#downloads").jqxWindow("show")},showDownloadsBtn:function(){b("#fmgrDloadsBtn").show()},handleDragOver:function(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"},handleDragEnter:function(){this.$(".fmgr-drop-highlight").addClass("active")},handleDragLeave:function(){this.$(".fmgr-drop-highlight").removeClass("active")},tree:function(a){for(var b=a.direlements.length,c=0;b>c;c++)this.files.add(a.direlements[c])},updateLoadEngine:function(a){this.downloadsView.updateProgress(a)},werror:function(a){consloe.log("ERROR: Line ",a.lineno," in ",a.filename,": ",a.message)},uploadPost:function(a){"error"==a.mesgtype?this.handleDenyMsg(a):this.worker.port.postMessage(a)},handleDenyMsg:function(){var a=this;b("<div/>").append("There is not enough space to upload file(s)").dialog({height:150,title:"Error",modal:!0,resizable:!1,buttons:[{text:"Skip","class":"btn btn-danger",click:function(){a.uploads.cancel(),b(this).dialog("close").remove()}}]})},uwmessage:function(a){var b=a.data.obj;if(a.data.obj)if("request"==b.mesgtype||"cancel"==b.mesgtype){var c=a.data.prct;this.uploadsView.updateProgress(b.cookie,parseFloat(100*c).toFixed(2),a.data.lastByte),b.uid=e.loginuserid,this.collection.send(b,this.uploadPost)}else"complete"==b.mesgtype&&this.uploads.trigger("fileCompleted",b.cookie);else;},handleFileWrite:function(){var a=this.files.getSelected();this.collection.trigger("download",a)},downloadErr:function(a){var c="<strong>Directory is not supported!</strong><br><b>"+a+"</b> cannot be download.";b("<div/>").attr("id","dlt_dialog").append('<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>'+c+"</p>").dialog({resizable:!1,height:140,position:["right","bottom"],buttons:{OK:function(){b(this).dialog("close")}}})},handleFileSelect:function(a){a.stopPropagation(),a.preventDefault(),this.handleDragLeave();var b,c=this.files.meta("cwd");if(a.dataTransfer){b=a.dataTransfer.items.length;for(var d=0;b>d;d++){var e=a.dataTransfer.items[d].webkitGetAsEntry();this.traverseFileTree(e)}}else if(a.target){b=a.target.files.length;for(var d=0;b>d;d++){var e=a.target.files[d];this.uploadFile(e,c+"/")}}},traverseFileTree:function(a,b){var c=this,d=c.files.meta("cwd");return b=b||"/",a.name.indexOf(".")?(a.isFile?a.file(function(a){c.uploadFile(a,d+b)}):a.isDirectory&&this.handleFolderUpload(a,b,d),void 0):!1},checkLimits:function(a){return a.size>this.collection.maxUploadLimit?(this.handleMaxSizeExceeds(a),!1):!0},handleMaxSizeExceeds:function(a){b("<div/>").append("<strong>"+a.name+"</strong> of <strong>"+f.convBytes(a.size)+"</strong> is exceeds max upload limit.<br/>* you can upload max 500MB file only.").dialog({title:"Error",resizable:!0,modal:!0,height:200,buttons:[{text:"Skip","class":"btn btn-primary",click:function(){b(this).dialog("close").remove()}}]})},uploadFile:function(a,b){var c=this;if(!a.name.indexOf("."))return!1;if(!this.checkLimits(a))return!1;var d=akp_ws.createUUID(),f={mesgtype:"file_list",files:a,dname:b+a.name,cookie:d,uid:e.loginuserid};c.uploadPost(f),c.uploads.add({id:d,name:a.name,dname:f.dname,type:a.type,size:a.size}),this.$("#fmgrUploadsBtn").show()},handleFileUpload:function(){},handleFolderUpload:function(a,b,c){var d=this,e=akp_ws.createUUID(),f={mesgtype:"request",service:"fmgr",request:"create_dir",cookie:e,source:c},g=a.fullPath,h=g.lastIndexOf("/"),i=g.substring(0,h);f.source=c+i,f.srcargs=[g.substring(h+1,g.length)],d.collection.send(f,function(){d.handleRecursiveEntries(d,a,b)})},handleRecursiveEntries:function(a,b,c){var d=b.createReader();d.readEntries(function(d){for(var e=0;e<d.length;e++)a.traverseFileTree(d[e],c+b.name+"/")})},handleNewFolderResponse:function(a){console.log(a),this.files.trigger("refresh")},alertRemove:function(){var a=this;b("<div/>").attr("id","dlt_dialog").append('<p><span class="ui-icon ui-icon-alert" style="float:left; margin:0 7px 20px 0;"></span>These items will be permanently deleted and cannot be recovered. Are you sure?</p>').dialog({resizable:!1,height:140,modal:!0,buttons:{"Delete all items":function(){a.trigger("remove"),b(this).dialog("close").remove()},Cancel:function(){b(this).dialog("close").remove()}}})},createFile:function(){var a=this;b("<div/>").addClass("dialogClass").append('<p><span style="float:left; margin:0 7px 20px 0;"> </span>Enter The File Name:<input type="text" id="flname"></p>').dialog({resizable:!1,title:"Prompt",height:170,modal:!0,buttons:[{text:"Create",click:function(){if(""!=b("input#flname").val()){var c=[b("input#flname").val()];a.files.createFile(c,a.handleNewFileResponse),b(this).dialog("close").remove()}},"class":"btn-btn-success"},{text:"Cancel",click:function(){b(this).dialog("close").remove()},"class":"btn btn-danger"}]})},createFolder:function(){var a=this;b("<div/>").addClass("dialogClass").append("<p><span style='float:left; margin:0 7px 20px 0;'> </span> Folder Name:<input type='text' id='flname'></p>").dialog({resizable:!1,height:170,modal:!0,buttons:[{text:"Create",click:function(){if(""!=b("input#flname").val()){var c=[b("input#flname").val()];a.files.createFolder(c,a.handleNewFolderResponse),b(this).dialog("close").remove()}},"class":"btn btn-success"},{text:"Cancel",click:function(){b(this).dialog("close").remove()},"class":"btn btn-danger"}],open:function(){b(this).closest(".ui-dialog").find(".ui-button:nth-child(2)").addClass("btn redbtn"),b(this).closest(".ui-dialog").find(".ui-button:nth-child(1)").addClass("btn blue")}})},toggleGroupFolder:function(a){b("#phome,#ghome").removeClass("btn-active active"),b(a.currentTarget).addClass("btn-active active");var c=b(a.currentTarget).attr("id");this.collection.trigger("changeFolder",c)},refreshView:function(){this.files.trigger("refresh")},gotoPath:function(a){var c=b(a.target).attr("data-pathid");this.files.meta("cwd",c),this.files.trigger("goPath")},gotoHome:function(){this.files.trigger("goHome")},gotoParent:function(){this.files.meta("cwd")!=this.files.meta("home")&&(this.files.context.parent&&(this.files.meta("cwd",this.files.context.parent),this.files.getTree()),this.files.trigger("goParent"))},flipTree:function(){this.$("#nodes").fadeToggle()}}),E=d.View.extend({el:b("#nodes"),initialize:function(){this.isparentSource=!1,c.bindAll(this,"render","update","selectItem"),this.collection.bind("add",this.list,this),this.collection.bind("goParent",this.getParent,this),this.collection.bind("goHome",this.getHome,this),this.collection.bind("refresh",this.refresh,this),this.$el.bind("select",this.selectItem)},render:function(){},update:function(a){console.log(a)},refresh:function(){var a=b("#nodes").jqxTree("selectedItem");null!=a?this.removeTreeItems(a.element):this.removeTreeItems(b("#home")[0]),this.collection.getTree()},getHome:function(){this.removeTreeItems(b("#home")[0]),this.collection.getTree()},getParent:function(){this.isparentSource=!0;var a=b("#nodes").jqxTree("selectedItem");a?b("#nodes").jqxTree("selectItem",a.parentElement):b("#nodes").jqxTree("selectItem",b("#home")[0])},getHtml:function(a){return b("<p/>").append(b(a).clone()).html()},selectItem:function(a){if(this.isparentSource)return this.isparentSource=!1,void 0;var c=a.args,d=b(this.el).jqxTree("getItem",c.element);if(d){var e=b(d.element).find("span.dirnode").attr("data-cid"),f=this.collection.get(e);f?f.get("isByView")||(this.collection.closeOpened(),f.set({isOpened:!0})):this.collection.trigger("goHome")}},removeTreeItems:function(a){if(null!=a)for(var c=b(a).find("li"),d=c.length,e=0;d>e;e+=1)d-1>e?b("#nodes").jqxTree("removeItem",c[e],!1):b("#nodes").jqxTree("removeItem",c[e],!0)},getSelectedItem:function(){var a=b("#nodes").jqxTree("selectedItem");if(null!=a)return a.element;var c=b("#nodes").jqxTree("getItems");if(c){c[0]}return b("#home")[0]},list:function(a){if("true"==a.get("isdir")){var c=new F({model:a}),d=this.getHtml(c.render().el),e=this.getSelectedItem();b("#nodes").jqxTree("addTo",{html:d,cid:a.cid},e),b("#nodes").jqxTree("expandItem",e)}}}),F=d.View.extend({tagName:"span",className:"ndelem dirnode",events:{click:"selectNode"},initialize:function(){c.bindAll(this,"render","getChange","selectNode"),this.model.bind("change",this.getChange,this),b(this.el).append(this.model.get("fname")).attr({"data-cid":this.model.cid})},render:function(){return this.delegateEvents(),this},getChange:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"isOpened":this.handleIsOpenedChange(a,c)}},handleIsOpenedChange:function(a,c){if(a.get(c)){var d=b("#nodes").find("span[data-cid="+a.cid+"]").parent()[0]?b("#nodes").find("span[data-cid="+a.cid+"]").parent()[0].parentElement:"";if(!d)return;b("#nodes").jqxTree("selectItem",d),this.clearOld(d)}},selectNode:function(a){a.stopPropagation(),this.model.set({isOpened:!0})},clearOld:function(a){if(null!=a)for(var c=b(a).find("li"),d=c.length,e=0;d>e;e+=1)d-1>e?b("#nodes").jqxTree("removeItem",c[e],!1):b("#nodes").jqxTree("removeItem",c[e],!0)}}),G=d.View.extend({events:{},defaults:{fileOpen:!0,contextMenu:!0,_fileSelected:!1,selectFile:""},settings:{},initialize:function(a){this.settings=b.extend({},this.defaults,a),this.isSelector=a.menu,c.bindAll(this,"render","update","cmenu"),a.menu||this.$el.bind({contextmenu:this.cmenu}),this._makeSelectable(),this.collection.bind("add",this.list,this),this.collection.bind("change",this.update,this),this.collection.bind("goHome",this.render,this),this.collection.bind("goParent",this.render,this),this.collection.bind("goPath",this.render,this),this.collection.bind("refresh",this.render,this),this.collection.bind("itemsCount",this.displayCount,this),this.collection.bind("question",this.handleQuestionMsg,this),this.collection.bind("clear",this.clear,this)},_makeSelectable:function(){var a=this.collection;this.$el.selectable({filter:"li",cancel:".fsdiv,.fname, .akorp-mime",selected:function(c,d){b(d.selected).each(function(){cid=b(this).data("cid");var c=a.get(cid);c.set({isSelected:!0})})},unselected:function(c,d){b(d.unselected).each(function(){cid=b(this).data("cid");var c=a.get(cid);c.set({isSelected:!1})})}}).sortable()},unselectFiles:function(){this.collection.unselect()},clear:function(){this.$el.empty()},render:function(){return this.$el.empty(),this},displayCount:function(a){this.$(".countbar").html(a)},update:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"isOpened":a.get(c)&&this.render()}},handleQuestionMsg:function(a){var c=this.collection,d=b('<label for="check"><input type="checkbox" id="check" />Apply this answer for all</label>'),e=b("<p/>").css({"word-wrap":"break-word"}).append(a.estring).after("<br/>");b("<div/>").append(e).append(d).dialog({resizable:!1,height:"auto",modal:!0,title:"File Operation",closeOnEscape:!1,open:function(a,c){b(".ui-dialog-titlebar-close",c.dialog||c).hide()},buttons:[{text:"Yes","class":"btn btn-primary",click:function(){var d=b("#check").is(":checked")?"yesall":"yes";c.sendQuestionResponse(a,d),b(this).dialog("close")}},{text:"No","class":"btn btn-danger",click:function(){var d=b("#check").is(":checked")?"noall":"no";c.sendQuestionResponse(a,d),b(this).dialog("close")}}]})},list:function(a){var b=new H({model:a,collection:this.collection,menu:this.isSelector}),c=a.toJSON();"true"==c.isdir?this.$el.prepend(b.render().el):this.$el.append(b.render().el),this.settings.selectFile&&!this.settings._fileSelected&&c.path==this.settings.selectFile&&(b.select({}),this.settings._fileSelected=!0)},cmenu:function(a){return a.preventDefault(),a.stopPropagation(),N.render({type:"workspace",model:this.model,collection:this.collection,psX:a.pageX,psY:a.pageY-50}),!1}}),H=d.View.extend({tagName:"li",ClassName:"file-div",events:{click:"select",dblclick:"open"},defaults:{allowFileOpen:!0,contextMenu:!0,showInfo:!0},settings:{},initialize:function(a){c.bindAll(this,"render","getChange","cmenu","handleGtkOpen"),this.model.bind("change",this.getChange,this),this.model.bind("open",this.open,this),this.settings=b.extend({},this.defaults,a),a.menu||(this.$el.bind("contextmenu",this.cmenu),this.bindFeatures());var d=this.model.toJSON();b(this.el).attr("data-cid",this.model.cid);var e=f.mime2class(d.type);d.mime="true"==d.isdir?"akorp-mime-directory":e,d.size=f.convBytes(d.size),this.template=b("#file-template").tmpl([d])},render:function(){return b(this.el).addClass(this.ClassName).append(this.template),this},bindFeatures:function(){var a=this;b(this.el).draggable({revertDuration:10,revert:!0,start:function(b){a.model.get("isSelected")||a.select(b)},stop:function(){b(this).parent().children("li.selected").css({top:0,left:0})},drag:function(a,c){b(this).parent().children("li.selected").css({top:c.position.top,left:c.position.left})}}).droppable({accept:".file-div",greedy:!0,drop:function(){a.model.get("isdir")&&(a.collection.trigger("cut"),a.collection.trigger("paste",a.model.get("path")))}})},select:function(a){if(a.ctrlKey){var b=this.model.get("isSelected");this.model.set({isSelected:!b})}else this.collection.unselect(),this.model.set({isSelected:!0})},getChange:function(a){var c=a.changedAttributes();for(var d in c)switch(d){case"isSelected":a.get(d)?b(this.el).toggleClass("selected ui-selected"):b(this.el).removeClass("selected ui-selected")}},open:function(){this.collection.unselect(),"true"==this.model.get("isdir")?this.model.get("isOpened")||(this.collection.closeOpened(),this.model.set({isByView:!0}),this.model.set({isOpened:!0})):this.handleReadableFileOpen()},handleReadableFileOpen:function(){var a=this.model.toJSON(),c=b.trim(a.type);"image"==c.split("/")[0]?this.showImagePreview(a):"application/pdf"==c?this.handlePDFFileOpen(a):"video/mp4"==c||"video/webm"==c||("application/javascript"==c||"application/json"==c||"text"==c.split("/")[0]||"application/x-sh"==c?this.handleTextFilesOpen(a):("application/vnd.oasis.opendocument.presentation"==c||"application/vnd.oasis.opendocument.text"==c||"application/vnd.oasis.opendocument.graphics"==c)&&this.handleOpenDocumentFilesOpen(a))},handleOpenDocumentFilesOpen:function(a){this.collection.openGtkFile(a.path,this.handleGtkOpen)},handleGtkOpen:function(a){this.collection.trigger("gtkViewer",a)},handlePDFFileOpen:function(a){var b=this;this.collection.trigger("block");var c=new FileReader;c.onload=function(a){var c=a.target.result,d=new Uint8Array(c);b.collection.trigger("unblock"),g.open(d)};var d=akp_ws.get({fname:a.path,service:"fmgr",request:"read",mesgtype:"request",size:1024});d.oncomplete=function(a,b){c.readAsArrayBuffer(b)}},handleTextFilesOpen:function(a){var c=this,d=b("<div/>").append('<span class=" loadpercentage icon-spinner-3"></span>').append("Loading..").addClass("loadspan"),e=b("<div/>").append(d).attr("data-loaded","false").dialog({modal:!0,height:"600",width:"700",open:c.dialogOpenWithoutTitle,close:function(){b(this).remove()}}),g=new FileReader;g.onload=function(b){var c;c=f.htmlEscape(b.target.result);var d=new I({entry:a,result:c});e.attr("data-loaded","true").find(".loadspan ").remove().end().append(d.render().$el)};var h=akp_ws.get({fname:a.path,service:"fmgr",request:"read",mesgtype:"request",size:1024});h.oncomplete=function(a,b){g.readAsText(b)}},handleVideoFileOpen:function(a){var b=a.type,c=this,d=document.createElement("video"),e=new MediaSource;d.controls=!0,d.src=window.URL.createObjectURL(e),e.addEventListener("webkitsourceopen",function(){var f=e.addSourceBuffer(b+'; codecs="vorbis,vp8"'),g=akp_ws.get({fname:a.path,service:"fmgr",request:"read",mesgtype:"request",size:1024});g.onstarted=function(a){c.showVideo(d,a)},g.onBlobRecieved=function(a){a.type=b,f.append(new Uint8Array(a))},g.oncomplete=function(){d.play()}},!1)},showImagePreview:function(a){var c=this,d=akp_ws.get({fname:a.path,service:"fmgr",request:"read",mesgtype:"request",size:1024}),e=b("<div/>").append('<span class=" loadpercentage icon-spinner-3"></span>').append("Loading..").addClass("loadspan"),f=b("<div/>").append(e).attr("data-loaded","false").dialog({modal:!0,title:a.fname,open:this.dialogOpen,close:function(){b(this).remove()}});d.oncomplete=function(a){var d,e=new Image,g=setTimeout(function(){var a=b("<div/>").css({"text-align":"center","line-height":"25px",color:"orange","font-size":"20px"}).append("Oops! something wrong. The file you are trying to access is currepted.");f.attr("data-loaded","true").find(".loadspan ").remove().end().append(a)},5e3);e.onload=function(){clearTimeout(g),d=c.calculateAspectRatioFit(e.width,e.height,500,500),b(e).css({height:d.height,width:d.width});var a=b("<div/>").addClass("akp-center").append(e).css({padding:"10px "});f.attr("data-loaded","true").find(".loadspan ").remove().end().append(a),f.dialog({width:d.width+40,height:d.height+60})},e.src=a}},imgLoadErr:function(){},calculateAspectRatioFit:function(a,b,c,d){var e=[c/a,d/b];return e=Math.min(e[0],e[1]),{width:a*e,height:b*e}},scaleImage:function(a){return b(a).each(function(){var a=500,c=500,d=0,e=this.width,f=this.height;e>a&&(d=a/e,b(this).css("width",a),b(this).css("height",f*d),f*=d,e*=d),f>c&&(d=c/f,b(this).css("height",c),b(this).css("width",e*d),e*=d)})},dialogOpenWithoutTitle:function(){var a=b(this);a.closest(".ui-dialog").find(".ui-dialog-titlebar").remove(),a.css({padding:"0"}).closest(".ui-dialog").css({padding:"0"}),$dialogOverlay=b(".ui-widget-overlay").last(),$dialogOverlay.unbind(),$dialogOverlay.click(function(){a.dialog("close")})},dialogOpen:function(){var a=b(this);a.css({padding:"0"}).closest(".ui-dialog").css({padding:"0"}),$dialogOverlay=b(".ui-widget-overlay").last(),$dialogOverlay.unbind(),$dialogOverlay.click(function(){a.dialog("close")})},showVideo:function(a){b("<div/>").append(a).dialog({modal:!0,height:"500",width:"500",buttons:{close:function(){b(this).dialog("close").remove()}}})},cmenu:function(a){a.preventDefault(),a.stopPropagation(),this.model.get("isSelected")||this.select(a);var b=this.model.get("isdir"),c="true"==b?"folder":"file";return N.render({type:c,model:this.model,collection:this.collection,psX:a.pageX,psY:a.pageY-40}),!1}}),I=d.View.extend({events:{"click .tv-zoom-plus":"zoomIn","click .tv-zoom-minus":"zoomOut","click .text-edit":"enableEdit","click .text-save":"saveFile"},defaults:{zoomValue:13,maxZoomVal:20,minZoomVal:9},settings:{},initialize:function(a){this.settings=b.extend({},this.defaults,a),this.$el=b("#text-viewer-template").tmpl([{fname:a.entry.fname,text:a.result}]),this.$(".edit-saveOptions").hide()},render:function(){return this},discardChanges:function(){this.$(".tv-body").attr("contentEditable","false"),this.enableZoom(),this.hideActions()},saveFile:function(){this.$(".tv-body").attr("contentEditable","false"),this.enableZoom(),this.hideActions()},enableEdit:function(){this.$(".tv-body").attr("contentEditable","plaintext-only"),this.changeZoom(this.defaults.zoomValue),this.disableZoom(),this.showActions()},hideActions:function(){this.$(".text-edit").show(),this.$(".edit-saveOptions").hide()},showActions:function(){this.$(".text-edit").hide(),this.$(".edit-saveOptions").show()},disableZoom:function(){this.$(".tv-zoom-plus").attr("disabled","disabled"),this.$(".tv-zoom-minus").attr("disabled","disabled")},enableZoom:function(){this.$(".tv-zoom-plus").removeAttr("disabled"),this.$(".tv-zoom-minus").removeAttr("disabled")},zoomIn:function(){this.settings.zoomValue++,this.changeZoom(this.settings.zoomValue)},zoomOut:function(){this.settings.zoomValue--,this.changeZoom(this.settings.zoomValue)},changeZoom:function(a){this.$(".tv-body pre").css("font-size",a),this.$(".tv-zoom-input").val(a),a<this.settings.maxZoomVal&&a>this.settings.minZoomVal?(this.$(".tv-zoom-minus").removeAttr("disabled"),this.$(".tv-zoom-plus").removeAttr("disabled")):a==this.settings.maxZoomVal?this.$(".tv-zoom-plus").attr("disabled","disabled"):a==this.settings.minZoomVal&&this.$(".tv-zoom-minus").attr("disabled","disabled")}}),J=(d.View.extend({events:{},defaults:{zoomValue:1,maxZoomVal:5,minZoomVal:1,minHeight:200,minWidth:200,maxHeight:500,maxWidth:500},settings:{},initialize:function(a){this.settings=b.extend({},this.defaults,a),this.$el=b("#image-viewer-template").tmpl([{fname:a.entry.fname,text:a.result}])},render:function(){return this},scaleImage:function(a){return b(a).each(function(){var a=500,c=500,d=0,e=this.width,f=this.height;e>a&&(d=a/e,b(this).css("width",a),b(this).css("height",f*d),f*=d,e*=d),f>c&&(d=c/f,b(this).css("height",c),b(this).css("width",e*d),e*=d)})}}),new i),K=new k,L=(new D({collection:J,files:K}),new G({el:b("#file-list"),collection:K,menu:!1}),new E({collection:K}),new l({collection:K}),d.View.extend({el:b("#cmenu"),fileList:["copy","cut","download","dlt","info"],folderList:["paste","open","copy","cut","dlt","newwnd","info"],workspace:["paste","create_folder"],events:{click:"hidemenu","click #create_folder":"createFolder","click #open":"open","click #newwnd":"newView","click #cut":"cut","click #copy":"copy","click #paste":"paste","click #download":"download","click #dlt":"distroy","click #info":"info",contextmenu:"disableContextMenu"},initialize:function(a){c.bindAll(this,"hidemenu"),b(document).bind("click",this.hidemenu),this.baseCollection=a.baseCollection,this.baseCollection.bind("clear",this.hidemenu,this)},render:function(a){this.viewtype=a.type,this.model=a.model,this.collection=a.collection,this.filterMenu(),f.inBox(this.el,{top:a.psY,left:a.psX},"#container"),b(this.el).show()},disableContextMenu:function(a){return a.preventDefault(),!1},filterMenu:function(){b(this.el).children().hide();for(var a=this.getlist(),c=a.length,d=0;c>d;d++)b(this.el).children("#"+a[d]).show();this.resetdefaults()},getlist:function(){var a;if(a="file"==this.viewtype?this.fileList:"folder"==this.viewtype?this.folderList:this.workspace,!J.clipboardData){var c=b.inArray("paste",a);-1!=c&&a.splice(c,1)}return a},resetdefaults:function(){this.fileList=["copy","cut","download","dlt","info"],this.folderList=["paste","open","copy","cut","dlt","newwnd","info"],this.workspace=["paste","create_folder"]},createFolder:function(){this.collection.trigger("newfolder")},open:function(){this.collection.getSelected().length>1?console.log("sorry unable to open multiple files"):this.model.trigger("open")},newView:function(){J.trigger("newwnd",this.model.get("path"))},cut:function(){this.collection.trigger("cut")},copy:function(){this.collection.trigger("copy")},paste:function(){var a=null;"workspace"!=this.viewtype&&(a=this.model.get("path")),this.collection.trigger("paste",a)},download:function(){this.collection.trigger("download")},distroy:function(){this.collection.trigger("delete")},info:function(){var a=this,b=akp_ws.createUUID(),c={mesgtype:"request",request:"getinfo",dname:this.model.get("path"),service:"fmgr",cookie:b,uid:e.loginuserid};J.send(c,function(b){return console.log(b),"error"==b.mesgtype?(noty({text:b.error,type:"error",layout:"bottomRight",theme:"default",timeout:5e3}),void 0):(O.render({model:a.model,info:b.info,collection:a.collection}),void 0)})},hidemenu:function(){b(this.el).hide()}})),M=d.View.extend({events:{"click .file-info-desc":"editDesc","click .file-info-tags":"showTagsInput","click .desc-edit":"editDesc","click .tag-edit":"showTagsInput","click .desc-save":"sendDescChange","click .tag-save":"sendTagChange","click .file-info-follow":"sendFollow","click .file-info-lock":"sendLock","click .file-info-download":"downloadFile","click .file-info-delete":"deleteFile"},initialize:function(a){c.bindAll(this,"render","close","shareKons"),this.baseCollection=a.baseCollection,this.infoObj={isPrivate:0,fqtn:"",oid:"",state:"",locked:0,kons:0,description:"",markedPrivateBy:"",lockedBy:0,ownerUid:e.loginuserid,ownerGid:e.cgd,followers:[],taglist:[]};var d=b("<div/>").addClass("vaultKonsEntry"),f=b("<div/>").addClass("vaultKonsStream"),g=b("<div/>").addClass("fileinfoside"),h=b("<div/>").addClass("file-info-kons").append(d).append(f),i=b("<div/>").append(g).append(h).css({height:"100%"});this.$el.append(i).dialog({autoOpen:!1,resizable:!1,draggable:!1,modal:!0,closeButtonAction:"close",minWidth:"1000",maxWidth:"80%",minHeight:"600",height:"600",maxHeight:"800",close:this.close,open:this.onOpen}),this.baseCollection.bind("initialized",this.getKonsDialog,this),this.baseCollection.bind("initialized",this.loadKonsStream,this),this.baseCollection.bind("clear",this.closeDialog,this)},closeDialog:function(){},downloadFile:function(){this.collection.trigger("download")},deleteFile:function(){this.collection.trigger("delete"),this.$el.dialog("close")},saveInfo:function(){this.collection.trigger("saveFileInfo",this.fileInfo)},sendLock:function(){var a=this.fileInfo.locked?"unlock":"lock";this.fileInfo.locked=this.fileInfo.locked?0:1,this.fileInfo.lockedBy="unlock"==a?0:e.loginuserid;var b=akp_ws.createUUID(),c={cookie:b,service:"fmgr",mesgtype:"request",request:a,info:this.fileInfo,uid:e.loginuserid,dname:this.model.get("path")};this.baseCollection.send(c,this.handleResponses),this.setLock()},setLock:function(){this.fileInfo.locked?this.fileInfo.lockedBy==e.loginuserid?this.$(".file-info-lock").children("span").removeClass().addClass("icon-unlocked"):this.$(".file-info-lock").attr("disabled","disabled"):this.$(".file-info-lock").children("span").removeClass().addClass("icon-lock")},sendFollow:function(){this.isFollowing?this.fileInfo.followers=c.without(this.fileInfo.followers,e.loginuserid):this.fileInfo.followers.push(e.loginuserid);var a=this.isFollowing?"unfollow":"follow",b=akp_ws.createUUID(),d={cookie:b,service:"fmgr",mesgtype:"request",request:a,info:this.fileInfo,uid:e.loginuserid,dname:this.model.get("path")};this.baseCollection.send(d,this.handleResponses),this.setFollow()},setFollow:function(){-1==c.indexOf(this.fileInfo.followers,e.loginuserid)?(this.$(".file-info-follow").html("Follow"),this.isFollowing=!1):(this.$(".file-info-follow").html("Unfollow"),this.isFollowing=!0),this.renderMembers({members:this.fileInfo.followers,el:this.$(".file-info-followers-list")})},sendTagChange:function(){this.$(".tag-edit").show(),this.$(".tag-save").hide(),this.fileInfo.taglist=this.$(".file-info-tags").val().split(",");var a=akp_ws.createUUID(),b={cookie:a,service:"fmgr",mesgtype:"request",request:"tagchange",info:this.fileInfo,uid:e.loginuserid,dname:this.model.get("path")};
this.baseCollection.send(b,this.handleResponses),this.renderTags()},renderTags:function(){this.$(".file-info-tags").show().next(".tagsinput").remove();var a=this.fileInfo.taglist,c=a.length;if(c){this.$(".file-info-tags").removeClass(".blur-msg").empty();for(var d=0;c>d;d++)b("<span/>").addClass("tag").appendTo(this.$(".file-info-tags")).append("#"+a[d])}},handleResponses:function(){},sendDescChange:function(){this.$(".file-info-desc").attr({contenteditable:"false",isEditing:"false"}).removeClass("akp-edit-content"),this.$(".desc-edit").show(),this.$(".desc-save").hide(),this.fileInfo.description=this.$(".file-info-desc").text();var a=akp_ws.createUUID(),b={cookie:a,service:"fmgr",mesgtype:"request",request:"setdesc",info:this.fileInfo,uid:e.loginuserid,dname:this.model.get("path")};this.baseCollection.send(b,this.handleResponses),this.setDesc()},setDesc:function(){this.fileInfo.description?this.$(".file-info-desc").html(this.fileInfo.description):this.$(".file-info-desc").html("Write Something to know whats in the file...")},editDesc:function(){this.$(".file-info-desc").attr({contenteditable:"true",isEditing:"true"}).empty().focus().addClass("akp-edit-content"),this.fileInfo.description&&this.$(".file-info-desc").html(this.fileInfo.description),this.$(".desc-edit").hide(),this.$(".desc-save").show()},showTagsInput:function(){this.$(".file-info-tags").attr("isEditing","true").tagsInput({height:"auto",width:"auto",onAddTag:function(a){console.log(a)}});var a=this,b=f.array2string(a.fileInfo.taglist);this.$(".file-info-tags").importTags(b),this.$(".tag-edit").hide(),this.$(".tag-save").show()},renderMembers:function(a){var c=a.members;a.el.empty();for(var d=0;d<c.length;d++){var f=e.getuserinfo(c[d]),g={userid:f.uid,img:f.image_small||"css/images/user32.png"},h=b("#user-template").tmpl([g]);h.attr("title",f.first_name),a.el.append(h)}},hideKonsEntry:function(){this.$(".vaultKonsEntry").hide(),this.$(".vaultKonsStream").show()},showKonsEntry:function(){this.$(".vaultKonsEntry").show(),this.$(".vaultKonsStream").hide()},getKonsDialog:function(){this.konsEntry=akp_ws.konsDialog({el:this.$(".vaultKonsEntry"),type:"standard",onShare:this.shareKons,onCancel:this.clearKonsEntry,basic:"true",richText:!1})},loadKonsStream:function(){this.konsStream=akp_ws.kons.getKonsStream({el:this.$(".vaultKonsStream"),basic:!0,richText:!1,strictCategory:"file",onUpdates:this.hideKonsEntry}),this.konsStream.bind("rootRemoved",this.showKonsEntry,this),akp_ws.kons.getCategoryUpdates("file",this.konsStream.updates)},getKonsStream:function(a){this.konsStream.getKonv(a)},shareKons:function(a){a.category="file",a.attached_object=this.model.get("path"),akp_ws.send(a),console.log("sending kons object"),console.log(a)},clearKonsEntry:function(){},onOpen:function(){var a=b(this);a.closest(".ui-dialog").find(".ui-dialog-titlebar").remove(),a.css({padding:"0"}).closest(".ui-dialog").css({padding:"0","border-radius":"0px"}),$dialogOverlay=b(".ui-widget-overlay").last(),$dialogOverlay.unbind(),$dialogOverlay.click(function(){a.dialog("close")}),b(".ui-dialog :button").blur()},render:function(a){a.model&&(this.model=a.model,this.fileInfo=a.info,this.collection=a.collection);var c=this.model.toJSON();c.size=f.convBytes(c.size,2),c.mime="true"==c.isdir?"akorp-mime-directory":f.mime2class(c.type),c.type="true"==c.isdir?"Directory":c.type,c.parent=c.parent.toString().replace(c.home,"Home");var d={last_modified:b.fullCalendar.formatDate(new Date(1e3*this.fileInfo.lastmodified),"dd MMM yy"),last_accessed:b.fullCalendar.formatDate(new Date(1e3*this.fileInfo.lastaccessed),"dd MMM yy")},e=b.extend({},c,this.infoObj,this.fileInfo,d),g=b("#fileInfo-template").tmpl([e]);return this.$(".fileinfoside").html(g),this.renderTags(),this.setFollow(),this.setLock(),this.setDesc(),this.renderMembers({members:this.fileInfo.followers,el:this.$(".file-info-followers-list")}),parseInt(this.fileInfo.kons)?(this.hideKonsEntry(),this.getKonsStream(this.fileInfo.kons)):this.showKonsEntry(),this.$el.dialog("open"),this},close:function(){this.$el.dialog("close")}}),N=new L({baseCollection:J}),O=new M({baseCollection:J});return J}),define("akprtc",["jquery","underscore","backbone","akpauth","akpmedia","akpcontacts","akputils","plugins/gettheme","plugins/jqxcore","plugins/jqxwindow","plugins/jquery-tmpl"],function(a,b,c,d,e,f,g){function h(a){var b=a.mesgtype;switch(b){case"event":"new_imsg"==a.eventtype?q.trigger("newmsg",a.imsg):"istatus"==a.eventtype?q.handleStatus(a.istatus):"new_chat"==a.eventtype?q.trigger("newchat",a.userid):"text_con_invite"==a.eventtype?q.trigger("confInvite",a.invite):"text_con_invite_accept"==a.eventtype?(console.log("conference request accepted by invitee."),console.log(a)):"user_join_text_con"==a.eventtype?q.trigger("confJoin",a.join):"offRecord"==a.eventtype?q.trigger("offRecord",a.offRecord):("bye"==a.eventtype||"drop"==a.eventtype||"candidate_event"==a.eventtype||"new_media"==a.eventtype)&&e.send(a);break;case"request":case"response":if("pickup"==a.response||"answer"==a.response||"call"==a.request||"offer"==a.request)e.send(a);else if(q.mapSession(a.cookie)){var c=q.mapSession(a.cookie),d=q.getModelBySessionId(c);d&&d.trigger("showHistory",a.result)}}}function i(){this.send=h,this.onmessage=null}loader(10,"rtc Loaded");var j="css/images/user32.png",k=c.Model.extend({offRecord:!1,defaults:{service:"rtc",isSelected:!1},initialize:function(){this.bind("select",this.select,this),this.bind("unselect",this.unselect,this),this.bind("addParticipants",this.addParticipants,this)},select:function(){q.unselect(),this.set({isSelected:!0})},unselect:function(){this.set({isSelected:!1})},addParticipants:function(a){var c=this.get("participants"),d=b.difference(a,c);this.set({participants:a}),d.length&&this.trigger("addParticipant",d)},changeStatus:function(a){this.trigger("changeStatus",a.status,a.statusType)}}),l=c.Collection.extend({model:k,maptable:{},initialize:function(){b.bindAll(this,"getModel"),this.bind("newmsg",this.handleNewMsg,this),this.bind("newchat",this.handleChatReq,this),this.bind("remove",this.handleChatClose,this),this.bind("change",this.handleSelect,this),this.bind("confJoin",this.handleConf,this)},handleSelect:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"distroy":a.get(c)&&this.remove(a.cid)}},unselect:function(){this.filter(function(a){1==a.get("isSelected")&&a.trigger("unselect")})},checklist:function(a,b){if(a.length!==b.length)return!1;var c=a.slice().sort().join(""),d=b.slice().sort().join("");return c===d},handleConf:function(a){var b=a.participants;b.push(a.invitee);var c={uid:a.participants[0],sessionid:a.sessionid,participants:b};this.handleNewMsg(c)},handleChatReq:function(a){var b={participants:[d.loginuserid,a],sessionid:akp_ws.createUUID()};this.handleNewMsg(b)},handleChatClose:function(){if(this.isEmpty())this.trigger("empty");else{var a=this.first();a.trigger("select")}},getSelectedModel:function(){var a=[];return a=this.where({isSelected:!0}),a[0]},getModel:function(a){var b,c=this,d=c.filter(function(b){return b.get("sessionid")===a.sessionid});if(d.length){b=d;var e=c.checklist(b[0].get("participants"),a.participants);e||b[0].trigger("addParticipants",a.participants)}else b=c.filter(function(b){return c.checklist(b.get("participants"),a.participants)});return b.length?b[0]:!1},handleNewMsg:function(a){var b=this.getModel(a);b?b.trigger("msgarrived",a):this.add(a)},mapReq:function(a,b){this.maptable[a]=b},mapSession:function(a){return this.maptable[a]?this.maptable[a]:!1},getModelBySessionId:function(a){var b=this.where({sessionid:a});return b[0]?b[0]:void 0},handleStatus:function(a){var b=this.getModel(a);b&&b.changeStatus(a)}}),m=c.View.extend({el:a(".chatwnd"),events:{"click .chatact":"toggleWindow","keypress .chatip":"sendMessage"},settings:{transporter:"webrtc",statusUpdated:!1},initialize:function(){b.bindAll(this,"setOffRecord"),this.collection.bind("add",this.newChatMsg,this),this.collection.bind("empty",this.hide,this),this.collection.bind("remove",this.decWidth,this),this.collection.bind("confInviteReq",this.handleConfInviteReq,this),this.collection.bind("confInvite",this.handleInvite,this),this.collection.bind("offRecord",this.setOffRecord,this),this.isOpen=!1,this.minimized=!1},render:function(){},setOffRecord:function(a){this.collection.handleNewMsg(a)},handleInvite:function(b){for(var c=d.usersList[b.inviter].first_name,e=a("<div>You have been invited to the conference by </div>").append(c).append(" .<br/> Members: <br/>"),f=a("<div/>").addClass("chatmembers").css({height:"auto","border-bottom":"none"}),g=0;g<b.participants.length;g++){var h=b.participants[g],i=a("<img />").attr({src:d.usersList[h].image_small||"css/images/user32.png",height:32,width:32});a("<div />").addClass("uimg").attr("data-uid",h).append(i).appendTo(f)}e.append(f).append("<br/>Would you like to join?");var j=this;noty({layout:"bottomRight",theme:"default",text:e,buttons:[{addClass:"btn btn-primary",text:"Yes",onClick:function(a){j.chatInviteResponse(b,!0,""),a.close()}},{addClass:"btn btn-danger",text:"No",onClick:function(a){j.chatInviteResponse(b,!1,""),a.close()}}]})},chatInviteResponse:function(a,b,c){var d={service:"rtc",mesgtype:"response",request:"text_con_invite_accept",accept:{sessionid:a.sessionid,participants:a.participants,inviter:a.inviter,invitee:a.invitee,accepted:b,reason:c}};if(this.useTransporter(d),b){var e={uid:a.participants[0],sessionid:a.sessionid,participants:a.participants};this.collection.handleNewMsg(e)}},handleSendFail:function(a){console.log("msg failed");var b=this.collection.getModel(a.orginalMsg.msg.imsg);b&&b.changeStatus({status:"Failed to send messages."})},handleSendSuccess:function(a){console.log("sendSuccess"),console.log(a)},sendMessage:function(b){if(13==b.which){this.settings.statusUpdated=!1,this.sendStatus(d.activeuser.first_name+" messaged.");var c=a(b.target).text(),e=this.collection.getSelectedModel(),f=e.get("sessionid"),h=e.get("participants"),i=new Date,j=i.getTime(),k={content:g.htmlEscape(g.linkify(c.replace(/[\x00-\x1F\x80-\xFF]/g,""))),sessionid:f,participants:h,timestamp:j},l={uid:d.loginuserid,service:"rtc",mesg_type:"request",request:"send_imsg",imsg:k},m=this.useTransporter(l,e);return m.onerror=this.handleSendFail,m.onsuccess=this.handleSendSuccess,a(b.target).empty(),m}this.settings.statusUpdated||(this.sendStatus(d.activeuser.first_name+" is typing..","typing"),this.settings.statusUpdated=!0)},sendStatus:function(a,b){var c=this.collection.getSelectedModel(),e=c.get("sessionid"),f=c.get("participants"),g={status:a.replace(/[\x00-\x1F\x80-\xFF]/g,""),sessionid:e,participants:f,statusType:b},h={uid:d.loginuserid,service:"rtc",mesgtype:"request",request:"send_istatus",istatus:g};this.useTransporter(h,c)},useTransporter:function(a,b){if("webrtc"==this.settings.transporter){if("request"==a.mesg_type&&"send_imsg"==a.request){var c=a,d=this.checkAvailable(a.imsg.participants),a=this.parseReq(a);a.offRecord=b.get("offRecord");var e={to:d,mesgtype:"peerEvent",eventtype:"IMmsg",msg:a};if(h(a),b.get("offRecord")||(c.request="im_log",akp_ws.send(c)),!d.length)return!1;var f=akp_ws.sendPeer(e);return f}if("request"==a.mesgtype&&"send_istatus"==a.request){var c=a,d=this.checkAvailable(a.istatus.participants),a=this.parseReq(a),e={to:d,mesgtype:"peerEvent",eventtype:"IMmsg",msg:a};if(!d.length)return!1;var f=akp_ws.sendPeer(e)}else if("request"==a.mesgtype&&"text_con_invite"==a.request){var d=this.checkAvailable(a.invite.participants),a=this.parseReq(a),e={to:a.invite.invitee,mesgtype:"peerEvent",eventtype:"IMmsg",msg:a};if(!d.length)return;var f=akp_ws.sendPeer(e)}else if("response"==a.mesgtype&&"text_con_invite_accept"==a.request){var d=this.checkAvailable(a.accept.participants),a=this.parseReq(a),e={to:a.accept.inviter,mesgtype:"peerEvent",eventtype:"IMmsg",msg:a};if(!d.length)return;var f=akp_ws.sendPeer(e);if(a.accept.accepted){var g={mesgtype:"event",eventtype:"user_join_text_con",join:{invitee:a.accept.invitee,participants:a.accept.participants,sessionid:a.accept.sessionid}},i={to:g.join.participants,mesgtype:"peerEvent",eventtype:"IMmsg",msg:g};akp_ws.sendPeer(i)}}}else"server"==this.settings.transporter&&akp_ws.send(a)},parseReq:function(a){return"request"==a.mesg_type&&"send_imsg"==a.request?(delete a.mesg_type,delete a.request,a.mesgtype="event",a.eventtype="new_imsg",a.imsg.sender=d.loginuserid,a.checked=!0,a):"request"==a.mesgtype&&"send_istatus"==a.request?(delete a.mesg_type,delete a.request,a.mesgtype="event",a.eventtype="istatus",a):"request"==a.mesgtype&&"text_con_invite"==a.request?(delete a.request,a.mesgtype="event",a.eventtype="text_con_invite",a):"response"==a.mesgtype&&"text_con_invite_accept"==a.request?(delete a.request,a.mesgtype="event",a.eventtype="text_con_invite_accept",a):void 0},checkAvailable:function(a){for(var b=[],c=0;c<a.length;c++){var e=d.getuserinfo(a[c]);("online"==e.status||"available"==e.status)&&b.push(e.uid)}return b},handleConfInviteReq:function(a,b,c){var e={service:"rtc",mesgtype:"request",request:"text_con_invite",invite:{sessionid:a,participants:c,inviter:d.loginuserid,invitee:b,desc:""}};this.useTransporter(e)},showStatus:function(){},newChatMsg:function(a){this.isOpen||this.open();var b=(a.toJSON(),new n({model:a,collection:this.collection})),c=new o({model:a,collection:this.collection});this.$(".chatlist").append(b.render().el),this.$("#chatroom").append(c.render().el),a.trigger("select"),this.incWnd()},incWnd:function(){var a=this.$el.width();this.$el.css("width",a+50+"px")},decWidth:function(){var a=this.$el.width();this.$el.css("width",a-50+"px")},open:function(){this.isOpen||(a(".chatwnd").show(),this.isOpen=!0),this.minimized||this.restore()},hide:function(){this.$el.hide(),this.isOpen=!1},toggleWindow:function(b){a(".chatwnd").toggleClass("chatwndmin"),a(".chatwnd").hasClass("chatwndmin")?this.minimize():this.restore(),a(b.target).toggleClass("chatactmax")},minimize:function(){a(".chatwnd").css("height","30px"),a(".chatwnd").children(".chatroom, .chatip").hide(),this.minimized=!0},restore:function(){a(".chatwnd").css("height","350px"),a(".chatwnd").children(".chatroom, .chatip").show(),this.minimized=!1}}),n=c.View.extend({tagName:"li",className:"chatter",events:{click:"getFocus","click .chatend":"closeChat"},initialize:function(){this.model.bind("chatEnd",this.distroy,this),this.model.bind("remove",this.remove,this),this.model.bind("select",this.select,this),this.model.bind("unselect",this.unselect,this);var a=this.model.toJSON(),b=this.getSender(a),c='<span class="chatname"> '+b.first_name+'</span><span class=" chatend akorp-icon akorp-icon-close"></span>';this.$el.append(c)},select:function(){this.$el.addClass("chatteractive")},unselect:function(){this.$el.removeClass("chatteractive")},getFocus:function(){this.model.trigger("select")},getSender:function(a){var b;if(a.sender)b=a.sender;else for(var c=a.participants,e=0;e<c.length;e++)if(c[e]!=d.loginuserid){b=c[e];break}return d.getuserinfo(b)},closeChat:function(a){a.stopPropagation(),this.model.trigger("chatEnd")},distroy:function(){this.model.set({distroy:!0})},remove:function(){this.$el.remove()},render:function(){return this}}),o=c.View.extend({className:"chatboard",settings:{lastTop:"",marker:"",autoload:!0,loadCount:0},events:{"click .chatinvite":"inviteMembers","click .chatOff":"offRecord","click .chatDel":"deleteMessages"},initialize:function(){b.bindAll(this,"onDropped","getMore","sendInvitations","offRecord"),this.settings.lastTop="",this.settings.marker="",this.settings.autoload=!0,this.settings.loadcount=0,this.model.bind("remove",this.remove,this),this.model.bind("select",this.select,this),this.model.bind("unselect",this.unselect,this),this.model.bind("msgarrived",this.addMessage,this),this.model.bind("showHistory",this.renderHistory,this),this.model.bind("addParticipant",this.appendMembers,this),this.model.bind("setOffRecord",this.goOffRecord,this),this.model.bind("change",this.updateRoom,this),this.model.bind("changeStatus",this.updateStatus,this),this.template=a("#chat-template").tmpl(),this.$el.droppable({accept:".user",drop:this.onDropped}),this.getHistory(),this.$(".chatcontent").bind("scroll",this.getMore)},updateStatus:function(b,c){var d=this,e=5e3;if(clearTimeout(this.updateTimer),this.updateTimer=setTimeout(function(){d.$(".chatStatus").empty()},e),d.$(".chatStatus").empty(),"typing"==c){var f=a("<span/>").addClass("preloader mini icon-spinner");d.$(".chatStatus").append(f)}d.$(".chatStatus").append(b)},updateRoom:function(a){var b=a.changedAttributes();for(var c in b)switch(c){case"offRecord":this.setOffRecordStatus(a.get(c))}},setOffRecordStatus:function(a){a?this.$(".chatOff").html("Revert to Record"):this.$(".chatOff").html("Go off Record")},goOffRecord:function(a){a!=this.model.get("offRecord")&&(a?this.addInfoMessage("This conversation is going off the record!"):this.addInfoMessage("This conversation is no longer off the record!"),this.model.set({offRecord:a}),this.setOffRecordStatus(a))},sendOffRecord:function(a){var b={service:"rtc",mesgtype:"event",eventtype:"offRecord",offRecord:{sessionid:this.model.get("sessionid"),participants:this.model.get("participants"),contentType:"infoMsg",contentObj:"offRecord",status:a}},c={to:this.model.get("participants"),mesgtype:"peerEvent",eventtype:"IMmsg",msg:b};akp_ws.sendPeer(c)},offRecord:function(){var a=this.model.get("offRecord");this.sendOffRecord(!a),this.goOffRecord(!a)},deleteMessages:function(){},inviteMembers:function(){var a=f.browser({onFinish:this.sendInvitations}),b=this.model.toJSON().participants;a.blockUsers(b)},sendInvitations:function(a){console.log(a);for(var b=0;b<a.length;b++)a[b]&&this.invite(a[b])},getHistory:function(a){var b=akp_ws.createUUID(),c=this.model.toJSON(),e={mesgtype:"request",request:"replay_log",uid:d.loginuserid,from:d.loginuserid==c.participants[1]?c.participants[0]:c.participants[1],service:"rtc",cookie:b};a&&(e.marker=a),akp_ws.send(e),this.collection.mapReq(b,this.model.toJSON().sessionid)},getMore:function(){{var b=this.$(".chatcontent").scrollTop();this.$(".chatcontent")[0].scrollHeight,this.$(".chatcontent")[0].offsetHeight,a(document).height()}if(b<this.settings.lastTop&&50>b){var c=this.$(".chatmsg:first-child").attr("data-timestamp");c!=this.settings.marker&&(this.getHistory(c),this.settings.marker=c)}this.settings.lastTop=b},renderHistory:function(a){if(!this.mergeHistoryMessage(a)){var b=this.renderMessage(a);b&&(this.$(".chatcontent").prepend(b),this.checkInitialLoad())}},checkInitialLoad:function(){return this.settings.autoload&&(this.toBottom(0),this.settings.loadcount++,10==this.settings.loadcount&&(this.settings.autoload=!1)),this.settings.autoload},select:function(){this.$el.show()},unselect:function(){this.$el.hide()},render:function(){var a=this.model.toJSON();return this.$el.append(this.template),this.$(".chatcontent").bind("scroll",this.getMore),this.appendMembers(this.model.get("participants")),a.content?this.addMessage(a):"infoMsg"==a.contentType&&this.handleInfoMsgs(a),this},handleInfoMsgs:function(a){"offRecord"==a.contentObj&&this.goOffRecord(a.status)},addMessage:function(a){if(akp_ws.isVisible||akp_ws.changeTitle("New chat Message"),this.goOffRecord(a.offRecord),!this.mergeMessage(a)){var b;"infoMsg"==a.contentType?this.handleInfoMsgs(a):b=this.renderMessage(a),b&&(this.$(".chatcontent").append(b),this.toBottom("slow"))}},toBottom:function(a){var b=this.$(".chatcontent")[0].scrollHeight,c=this.$(".chatcontent")[0].offsetHeight,d=b-c;this.$(".chatcontent").animate({scrollTop:d+10},a)},mergeMessage:function(a){var b=this.$(".chatcontent").children(".chatmsg:last-child");return parseInt(b.attr("data-sender"))==a.sender?(b.children(".chatdata").append("<br/>"+a.content),this.toBottom("slow"),!0):!1},mergeHistoryMessage:function(a){var b=this.$(".chatcontent").children(".chatmsg:first-child");return parseInt(b.attr("data-sender"))==a.sender?(b.children(".chatdata ").children(".chattime").after(a.content+"<br/>"),!0):!1},formatTime:function(b){var c=new Date(b),d=new Date,e=Math.abs(d.getTime()-b),f=(Math.round(e/864e5),c.getFullYear()==d.getFullYear()?!0:!1),g=c.getMonth()==d.getMonth()?!0:!1;return c.getDate()==d.getDate()&&g&&f?a.fullCalendar.formatDate(c,"HH:mm"):d.getDate()-c.getDate()==1&&g&&f?"yesterday "+a.fullCalendar.formatDate(c,"HH:mm"):a.fullCalendar.formatDate(c,"dd/MM/yyyy HH:mm")},renderMessage:function(b){if(!b.sender||!b.content)return!1;var c=d.getuserinfo(b.sender);if(!c)return!1;var e=b.sender==d.loginuserid?"me":c.first_name,f=g.htmlUnescape(b.content);if(0==b.checked){var h=a("<span/>").append(f).addClass("unchecked");f=a("<div/>").append(h).html()}var i=a("#chatmsg-template").tmpl([{name:e,data:f,img:c.image_small||j,uid:c.uid,time:this.formatTime(b.timestamp)}]),k=b.sender==d.loginuserid?"me":"he";return i.attr({"data-timestamp":b.timestamp,"data-sender":b.sender}).addClass(k),i},onDropped:function(a,b){a.stopPropagation(),a.preventDefault();var c=b.draggable,d=c.data("uid");this.invite(d)},invite:function(a){var b=d.getuserinfo(a);if("offline"==b.status)return noty({layout:"bottomRight",theme:"default",text:"failed to send invitation, "+b.first_name+" offline",type:"warning",timeout:3e3}),void 0;if(a!=d.loginuserid){var c=this.$el.children(".chatparticipants").find("div[data-uid="+a+"]").length;if(!c){var e=this.model.get("participants"),f=this.model.get("sessionid");this.confInvite(f,a,e);var g=d.usersList[a].first_name+" has been invited to chat.<br />";this.addInfoMessage(g)}}},addInfoMessage:function(b){var c=a("<span/>").append(b).addClass("chatInfoMsg");this.$(".chatcontent").append(c),this.toBottom("slow")},appendMembers:function(a){if(a.length)for(var b=0;b<a.length;b++)if(d.loginuserid!=a[b]){var c=(d.getuserinfo(a[b]),f.getModelByUid(a[b]));if(c){var e=new p({model:c,room:this});this.$(".chatparticipants").append(e.render().$el)}}},confInvite:function(a,b,c){this.collection.trigger("confInviteReq",a,b,c)},remove:function(){this.$el.remove()}}),p=c.View.extend({initialize:function(a){this.room=a.room,this.model.bind("statusChange",this.handleStatusChange,this)},render:function(){var b=this.model.toJSON(),c={userid:b.uid,img:b.image_small||"css/images/user32.png",name:b.first_name},d=a("#user-template").tmpl([c]);d.attr("title",b.first_name);a("<span />").addClass("ustatus").appendTo(d);return this.$el.attr("data-uid",b.uid).html(d),this.setStatus(b.status),"offline"==b.status&&this.room.updateStatus(b.first_name+" is  unavailable to chat. "),this},setStatus:function(a){this.$("span.ustatus").addClass(a)},handleStatusChange:function(a){this.room.updateStatus(this.model.get("first_name")+" is "+a.status+". "),this.render()}}),q=(c.View.extend({initialize:function(){this.recognition=new webkitSpeechRecognition,this.recognition.continuous=!0,this.recognition.interimResults=!0,this.recognition.onresult=function(a){console.log(a.results[a.results.length-1][0].transcript)},this.recognition.start()},render:function(){}}),new l),r=(new m({collection:q}),new i);return r}),define("akpmedia",["jquery","underscore","backbone","akpauth","akpcontacts","plugins/peer","plugins/gettheme","plugins/jqxcore","plugins/jqxwindow","plugins/jquery-tmpl","plugins/noty_full"],function(a,b,c,d,e){function f(a){var b=a.toJSON();if("offline"!=b.status){var c=h(b);c.sendCall()}}function g(a){if(U[a.uid]){if("offline"==a.status){var b=U[a.uid];b&&b.closePeerConnection(),U[a.uid]=null,console.log("peer connection removed for user :"+a.uid)}}else;}function h(a){if(U[a.uid])return U[a.uid];var b={homeId:d.loginuserid,id:a.uid,onAddStream:q,onRemoveStream:p,onPeerMessage:i};0==a.autoOffer&&(b.autoOffer=!0);var c=new Peer(b);return U[a.uid]=c,console.log("peer connection created for user :"+a.uid),c}function i(a,b){"fileXfer"==a.eventtype?SaveAs(a.file):"media"==a.eventtype?k(a.msg):"IMmsg"==a.eventtype&&akp_ws.send2Service("rtc",a.msg,b)}function j(a){if(a.to instanceof Array){var b=a.to;for(var c in b){var d=this.send2Peer(b[c],a);this.handleEvents(b[c],d,a)}}else{var d=this.send2Peer(a.to,a);this.handleEvents(b[c],d,a)}}function k(b){F=b.caller;var c,e=d.getuserinfo(F),f=b.audioonly;S="engaged",f?(P=!0,c=a("<div>You have been invited to Voice chat  by </div>").append(e.first_name)):(Q=!0,c=a("<div>You have been invited to Video chat by </div>").append(e.first_name));var g=a("<div/>").addClass("chatmembers").css({height:"auto","border-bottom":"none"}),h=a("<img />").attr({src:e.image_small||"css/images/user32.png",height:32,width:32});a("<div />").addClass("uimg").attr("data-uid",F).append(h).appendTo(g),c.append(g).append("Would you like to join?"),l(c,b,f)}function l(b,c,d){a(b).dialog({title:"Call",modal:!0,closeOnEscape:!1,resizable:!1,draggable:!1,buttons:[{"class":"btn btn-primary",text:"Accept",click:function(){o(c,d),a(this).dialog("close")}},{"class":"btn btn-danger",text:"Decline",click:function(){n(c.caller,d),a(this).dialog("close")}}]});m(c.caller)}function m(a){O=setTimeout(function(){n(a)},N)}function n(a,b){S="free";var c=U[a];c&&c.dropCall(b),clearTimeout(O)}function o(a,b){console.log("Accepted the video chat request."),clearTimeout(O),x("Please wait initializing ...",d.getuserinfo(a.caller));var c=U[a.caller];c&&(c.liftCall(b),P=b),M=a.caller;var f=e.getModelByUid(a.caller);if(f){new V({model:f})}}function p(){console.log("Remote stream removed"),J.src="",K=!0,closePeerconnectionbyRemote()}function q(b,c){S="inCall",console.log("Remote stream added");var e=b.stream,f=e.getVideoTracks().length;f?(console.log("this is video call"),J.src=window.webkitURL.createObjectURL(e),a("#rtcvideo").addClass("inProgress").jqxWindow("show"),a("#rtcvideo").jqxWindow({position:r()}),a("#rtcvideo").find(".actionSection").show("slideUp"),a("#rtcvideo").find(".rtcvidnotifier").hide("slideDown"),J.style.opacity=1):(console.log("this is audio call"),remoteVoice.src=window.webkitURL.createObjectURL(e),B(e),a("#rtcaudio").jqxWindow("show"),a("#rtcaudio").jqxWindow({position:r()}),a("#rtcaudio").find(".actionSection").show("slideUp"),a("#rtcaudio").find(".rtcvidnotifier").hide("slideDown"),a("#rtcaudio").find(".remoteauduser").attr("src",d.getuserinfo(c).image_large||T))}function r(){var b=a("body").offset();return{y:b.top+200,x:b.left+300}}function s(){L=!0,S="free",G=!1,H=!0,M="",K=!1,Q?(J.src="",I.src="",Q=!1):P&&(remoteVoice.src="",sourceVoice.src="",P=!1),a("#rtcaudio").find(".actionSection").hide().end().find(".rtcvidnotifier").show(),a("#rtcvideo").removeClass("inProgress").find(".actionSection").hide().end().find(".rtcvidnotifier").show().end().find("callStatus").hide()}function t(){K=!0,Q?a("#rtcvideo").jqxWindow("hide"):P&&a("#rtcaudio").jqxWindow("hide"),console.log("peer connection closed by peer. bye recieved"),v(M),s()}function u(){if("inCall"==S){var a=akp_ws.createUUID(),b={service:"rtc",mesgtype:"request",request:"bye",cookie:a,sndr:d.loginuserid,rcpt:M};akp_ws.send(b),console.log("peer connection closed. bye send"),v(M),s()}}function v(a){var b=U[a];b&&(b.isConnected=!1,b.removeMedia())}function w(b,c,d){function e(b){g.addMedia(b),d?(sourceVoice.src=window.webkitURL.createObjectURL(b),a("#rtcaudio").find(".actionSection").show("slideUp"),a("#rtcaudio").find(".rtcvidnotifier").hide("slideDown")):(I.style.opacity=1,I.src=window.webkitURL.createObjectURL(b),a("#rtcvideo").find(".actionSection").show("slideUp"),a("#rtcvideo").find(".rtcvidnotifier").hide("slideDown")),E=!0,"offer"==c?(g.sendCall(),console.log("offer send")):"answer"==c&&(g.answerCall(),console.log("answer send"))}function f(a){console.error("An error occurred: [CODE "+a.code+"]")}K=!1,S="inCall";var g=U[b],h={video:!0,audio:!0};h.video=d?!1:!0,navigator.webkitGetUserMedia(h,e,f)}function x(b,c){var d="";if(Q?d="#rtcvideo":P&&(d="#rtcaudio"),a(d).jqxWindow("show"),a(d).jqxWindow({position:r()}),c){var e=c.image_large||T;a(d).find(".rtcvidstillimg").attr("src",e)}b?a(d).find(".status").html(b):a(d).find(".status").html("calling..")}function y(a,b){var c=d.getuserinfo(a),e={layout:"bottomRight"};if("offline"!=c.status)if(L){L=!1,S="engaged",M=a,"audio"==b?P=!0:Q=!0,x("",c);var f=U[a];"audio"==b?f.makeCall({audio:!0}):f.makeCall()}else e.text="Please close existing conference. to make new call.",e.type="warning",e.timeout="3000",R=noty(e);else e.text=c.first_name+" is unavailable!. You cannot make call now...",e.type="information",e.timeout="3000",R=noty(e)}function z(){x("busy"),S="busy"}function A(a){var b=a.mesgtype;switch(b){case"event":if("new_media"==a.eventtype)a.audio?y(a.userid,"audio"):y(a.userid);else if("bye"==a.eventtype)t();else if("drop"==a.eventtype)z(a);else if("candidate_event"==a.eventtype)if(console.log("recvd candidate"),H)console.log("Cand dropped, reason: recvd before invite accept");else{var c=U[a.candobj.sndr];c&&c.addIceCandidate(a.candobj.label,a.candobj.cand)}break;case"request":if(console.log("recvng call"),"call"==a.request)k(a.call);else if("offer"==a.request){var c=U[a.offer.sndr];c||(c=h({uid:a.offer.sndr})),c.setRemoteDescription(a.offer.jsepdata),c.isConnected?(w(a.offer.sndr,"answer",P),M=a.offer.sndr,console.log("camera stream opened and answered")):c.answerCall()}break;case"response":if(console.log("recvd pickup"),"pickup"==a.response)x("Please accept to proceed!"),w(a.pickup.callee,"offer",a.pickup.audioonly);else if("answer"==a.response){var c=U[a.answer.sndr];c&&c.setRemoteDescription(a.answer.jsepdata)}break;case"peerEvent":return new j(a)}}function B(a){var b=Y.createMediaStreamSource(a);b.connect(Z),Z.connect(Y.destination),C()}function C(){window.webkitRequestAnimationFrame(C,W);var a=new Uint8Array(Z.frequencyBinCount);Z.getByteFrequencyData(a);var b=10,c=2,d=100,e=Math.round(_/b);X.clearRect(0,0,_,$),X.fillStyle="#F6D565",X.lineCap="round";for(var f=0;e>f;++f){var g=a[f+d];X.fillRect(f*b,$,c,-g-10)}}function D(){this.send=A,this.onmessage=null}loader(10,"media Loaded");var E=!1,F="",G=!1,H=!1,I=null,J=null,K=!1,L=!0,M=void 0,N=6e4,O="",P=!1,Q=!1,R="",S="",T="css/images/stock_people.png",U={};e.bind("add",f),e.bind("statusChange",g),j.prototype.handleEvents=function(a,b,c){var d=this;setTimeout(function(){b?"function"==typeof d.onsuccess&&d.onsuccess.call(this,{uid:a,status:b,originalMsg:c}):"function"==typeof d.onerror&&d.onerror.call(this,{uid:a,status:b,originalMsg:c})},500)},j.prototype.send2Peer=function(a,b){var c=U[a];return c?c.send(b):!1},j.prototype.peerErrorHandler=function(){var a="Sorry! unable to send Message. Please refresh..";noty({layout:"bottomRight",text:a,timeout:3e3,type:"information"})};var V=c.View.extend({initialize:function(){this.model.bind("statusChange",this.handleStatusChange,this)},render:function(){},handleStatusChange:function(a){"offline"==a.status&&this.userDisconnected()},userDisconnected:function(){Q&&(a("#rtcvideo").removeClass("inProgress"),this.setCallStatus("#rtcvideo",this.model.get("first_name")+" disconnected."))},setCallStatus:function(b,c){a(b).find(".callStatus").show("slideUp").html(c)},reset:function(){L=!0,S="free",G=!1,H=!0,M="",K=!1}});I=document.getElementById("sourcevid"),J=document.getElementById("remotevid"),a("#rtcvideo").jqxWindow({height:300,width:320,minHeight:100,maxHeight:600,maxWidth:500,theme:"darkblue",autoOpen:!1,showCollapseButton:!0,resizable:!0}),a("#rtcvideo").bind("close",function(){K||u()}),sourceVoice=document.getElementById("sourceVoice"),remoteVoice=document.getElementById("remoteVoice"),a("#rtcaudio").jqxWindow({height:300,width:320,minHeight:100,maxHeight:600,maxWidth:500,theme:"darkblue",autoOpen:!1,showCollapseButton:!0,resizable:!0}),a("#rtcaudio").bind("close",function(){K||u()}),a("#rtcaudio").find(".actionSection").hide(),a("#rtcvideo").find(".actionSection").hide();var W=document.getElementById("rtcaudvlzr"),X=W.getContext("2d");W.width=300;var Y=new webkitAudioContext,Z=Y.createAnalyser();const $=W.height,_=W.width;var ab=new D;return ab}),define("akpplanner",["jquery","underscore","backbone","akpauth","akpcontacts","akputils","plugins/jquery-ui","plugins/gettheme","plugins/jqxcore","plugins/jqxwindow","plugins/jquery-tmpl","plugins/fullcalendar.min"],function(a,b,c,d,e,f){loader(10,"planner Loaded");
var g=c.Model.extend({defaults:{service:"calendar"}}),h=c.Model.extend({defaults:{title:"",description:"",start:null,type:""}}),i=c.Collection.extend({model:h}),j=new i,k=c.Collection.extend({model:g,today:new Date,initialize:function(){b.bindAll(this,"onVisible"),this._map={},this._objCln={}},onVisible:function(){this.trigger("visible")},date2String:function(b,c){return a.fullCalendar.formatDate(b,c)},start:function(){this.trigger("init")},send:function(a){"response"==a.mesgtype?"delete"==this._map[a.cookie]?this.trigger("eventremove",this._objCln[a.cookie].id):"grant_request"==this._map[a.cookie]?this._objCln[a.cookie].hide():"decline_request"==this._map[a.cookie]?this._objCln[a.cookie].hide():"upcoming"==this._map[a.cookie]?this._objCln[a.cookie].attachEvent(a.result):"getVevent"==this._map[a.cookie]&&this._objCln[a.cookie].onResponse.call(this,new h(a.result)):"event"==a.mesgtype?"new_vevent"==a.eventtype?(this.add(a.vevent),j.add(a.vevent)):"edit_vevent"==a.eventtype?(this.add(a.vevent),j.add(a.vevent)):"delete_vevent"==a.eventtype?(console.log("delete event broadcast"),this.trigger("eventremove",a.vevent.id)):"vevent_invite"==a.eventtype?(console.log("New calendar invitation:"),this.trigger("addRequest",a.invite)):"vevent_reminder"==a.eventtype&&(console.log(a),this.trigger("alert",a.vevent)):"notification"==a.mesgtype&&this.trigger("notification",a.notification),a.result&&this.add(a.result),j.add(a.result)},map:function(a,b,c){this._map[a]=c,this._objCln[a]=b},clear:function(){},getEvents:function(a,b){var c=akp_ws.createUUID(),e={tstart:new Date(a).toISOString(),tend:new Date(b).toISOString(),mesgtype:"request",request:"get_vevents",cookie:c,uid:d.loginuserid,gid:d.cgd,personal:!1,service:"calendar"};akp_ws.send(e)},changeGroup:function(){this.trigger("clear"),j.reset(),this.reset(),this.start()}}),l=(c.Model.extend({update:function(){}}),c.View.extend({events:{"click .evt-go":"accept","click .evt-no":"deny","click .evt-title":"showFull"},initialize:function(b){this.request=b.invite,this.answer=b.invitations;var c=this.modObj(b.invite.vevent),d={title:c.title,id:c.id,description:c.summary,venue:c.location};c.allday?(d.day=a.fullCalendar.formatDate(new Date(c.start),"dd"),d.month=a.fullCalendar.formatDate(new Date(c.start),"MMM")):(d.day=a.fullCalendar.formatDate(new Date(c.start),"hh:mm"),d.month=a.fullCalendar.formatDate(new Date(c.start),"TT"),d.date=a.fullCalendar.formatDate(new Date(c.start),"dd-MMM-yyyy")),this.obj=d,this.setElement(a("#calEvent-invite-template").tmpl(this.obj))},modObj:function(a){var b=a;return b.start=new Date(b.tstart).toUTCString(),b.end=new Date(b.tend).toUTCString(),b.className=b.category,b},render:function(){return this},hide:function(){a(this.el).hide("fade")},accept:function(){var a=akp_ws.createUUID(),b={request:"grant_request",mesgtype:"request",uid:d.loginuserid,id:this.request.id,cookie:a,service:"calendar"};akp_ws.send(b),this.collection.map(a,this,"grant_request"),this.$(".evt-invite-respond").html("<span class=evt-invite-ask >updating..</span>")},deny:function(){var a=akp_ws.createUUID(),b={request:"decline_request",mesgtype:"request",uid:d.loginuserid,id:this.request.id,cookie:a,service:"calendar"};akp_ws.send(b),this.collection.map(a,this,"decline_request"),this.$(".evt-invite-respond").html("<span class=evt-invite-ask >updating..</span>")},showFull:function(){}})),m=c.View.extend({el:a(".cal_view"),settings:{isLoaded:!1},initialize:function(){b.bindAll(this,"render","handleCalEventSelect","handleViewChange","respondNotification","generateInvite","changeEvent","showEvent");var c={el:a(".mt-menu.calendar-tab"),service:"calendar",onNotificationClick:this.respondNotification,className:"yellow"};this.notifications=d.notificationDialog(c);var e={service:"calendar",el:a(".calmenu.invites"),onInvite:this.generateInvite,onInviteRespond:this.respondInvitation};this.invitations=d.invitationsDialog(e),this.nlist=new s({baseCollection:this.collection}),this.tlist=new r({collection:this.collection}),d.subscribe("groupInit",this.render),this.collection.bind("init",this.oninit,this),this.collection.bind("visible",this.render,this),this.collection.bind("add",this.addEvent,this),this.collection.bind("eventremove",this.removeEvent,this),this.collection.bind("refresh",this.refresh,this),this.collection.bind("notification",this.addNotification,this),this.collection.bind("showEvent",this.showEventById,this),this.collection.bind("addRequest",this.addInvitation,this),this.collection.bind("alert",this.alertEvent,this),this.collection.bind("clear",this.clearCalendar,this);this.show()},clearCalendar:function(){this.showView(),a(".cal_view").fullCalendar("removeEvents"),this.notifications.clear(),this.invitations.clear(),this.nlist.clear(),this.tlist.clear()},oninit:function(){this.notifications.init(),this.invitations.init(),this.nlist.render(),a(".cal_view").fullCalendar("today")},showView:function(){a(".event_mgr").hide("slide",{direction:"right"}),a(".cal_view").show("slide",{direction:"left"})},alertEvent:function(b){akp_ws.notifyOnHidden("Calendar Event Alert");var c=this,d=a("<div/>").append("Snooze For <select class='akp-input' ><option value='5'>5 Minutes</option><option value='10'>10 Minutes</option><option value='15'>15 Minutes</option></select>").addClass("snooze");d.children("select").bind("change",function(b){var c=b.currentTarget,d=c.options[c.selectedIndex].value;a(".snooze-dialog .ui-button-text:contains(SNOOZE)").text("SNOOZE("+d+")")}),a("<div/>").addClass("snooze-dialog").append(b.summary+"<br/>"+b.location+"<br/>is going to start now ... <br/>").append(d).dialog({title:b.title,modal:!0,height:"200",width:"350",closeOnEscape:!1,resizable:!1,draggable:!1,dialogClass:"snooze-dialog",buttons:[{text:"Ok",click:function(){a(this).dialog("close").remove()},"class":"btn btn-primary"},{"class":"btn btn-success",text:"SNOOZE(5)",click:function(){var e=d.children("select").val();c.snoozeAlert(e,b.id),a(this).dialog("close").remove()}}],close:function(){}})},snoozeAlert:function(a,b){console.log("sending snooze request");var c=akp_ws.createUUID(),e={cookie:c,service:"calendar",mesgtype:"request",request:"snooze",id:b,uid:d.loginuserid,snooze:a};akp_ws.send(e)},generateInvite:function(a){console.log(a);var a=new l({invite:a,collection:this.collection,invitations:this.invitations});return a.render().el},addInvitation:function(a){this.invitations.attachRequest(a)},respondInvitation:function(){},respondNotification:function(a){this.showEventById(a.vevent)},addNotification:function(a){this.notifications.attachNotification(a,"inc")},getEventObj:function(a){if(a){var b=a.toJSON();return b.start=new Date(b.tstart),b.end=new Date(b.tend),b.className=b.category,(1==b.allday||0==b.allday)&&(b.allDay=b.allday),b}},addEvent:function(b){var c=this;b.bind("change",function(){c.changeEvent(b)},this);var d=this.getEventObj(b);a(".cal_view").fullCalendar("renderEvent",d,!0)},changeEvent:function(b){var c=this.getEventObj(b);a(".cal_view").fullCalendar("renderEvent",c,!0)},removeEvent:function(b){a(".cal_view").fullCalendar("removeEvents",b),j.get(b).set({deleted:!0})},refresh:function(){this.handleViewChange(a(".cal_view").fullCalendar("getView"))},render:function(){return a(".cal_view").fullCalendar("render"),this},show:function(){{var b=a("#fcal").height(),c=new Date;c.getDate(),c.getMonth(),c.getFullYear()}this.calendar=a(".cal_view").fullCalendar({editable:!0,theme:!1,header:{center:"title",right:"prev,month,agendaWeek,agendaDay,next",left:"today,{team:"+this.handleCalShift+"}"},defaultView:"month",weekMode:"liquid",selectable:!0,selectHelper:!0,viewDisplay:this.handleViewChange,windowResize:this.render,eventClick:this.showEvent,disableDragging:!0,disableResizing:!0,select:this.handleCalEventSelect,eventRender:this.handleEventRender,height:b,ignoreTimezone:!1}),a(".cal_view").fullCalendar("today")},addCustomButtons:function(){var b='<span  class="fc-button fc-state-default fc-corner-left fc-state-active" unselectable="on">Group</span><span  class="fc-button fc-state-default  " unselectable="on" >Personal</span>';a(".fc-header-left").append(b)},handleCalShift:function(){},handleEventRender:function(){},handleViewChange:function(b){this.clearAll(),a(".cal_view").fullCalendar("renderEvents"),this.collection.getEvents(b.visStart,b.visEnd)},clearAll:function(){a(".cal_view").fullCalendar("removeEvents"),this.collection.reset()},handleCalWindowResize:function(){},showEventById:function(a){var b=j.get(a);b?v.render(b):this.getEvent(a).onResponse=function(a){j.add(a),v.render(a)}},getEvent:function(a){var b=akp_ws.createUUID(),c={cookie:b,mesgtype:"request",request:"get_vevent",id:a,uid:d.loginuserid,gid:d.cgd,personal:!1,service:"calendar"};return akp_ws.send(c),this.collection.map(c.cookie,c,"getVevent"),c},showEvent:function(a){this.showEventById(a.id)},handleCalEventSelect:function(b,c,d,e){a(".cal_view").fullCalendar("unselect");var f=new Date;f.setDate(f.getDate()-1);var g=new Date;if(g.setMinutes(g.getMinutes()),f>b&&d)return!1;if(g>b&&!d)return!1;var i=new h({start:b,end:c,allDay:d});u.render(i,e).show()}}),n=c.View.extend({initialize:function(){this.template=a("#timezone-template").tmpl(),this.$el.append(this.template);var b=(new Date).getTimezoneOffset(),c=f.min2hours(b),d=this.$(".akp-tzone-list-val:contains("+c+")").html();this.$(".akp-tzone-ivalue").val(d)},render:function(){return this},getTimeZone:function(){return this.$(".akp-tzone-ivalue").val()}}),o=c.View.extend({className:"showCalEvent",events:{"click .evtDelete":"eventRemove","click .evtEdit":"goEdit","click .closeIcon":"hidePanel","click .evtdrop":"renderModel","click .evtsave":"saveEvent"},initialize:function(){b.bindAll(this,"render","renderModel","shareEventKons","saveEvent");var c=a("<div />").addClass("calEventCard"),d=a("<div />").addClass("calKonsEntry"),e=a("<div />").addClass("calEventKons");this.$el.appendTo(".event_mgr").append(c).append(d).append(e).hide(),this.collection.bind("init",this.getKonsDialog,this),this.collection.bind("init",this.getKonsStream,this),this.collection.bind("clear",this.hidePanel,this),this.$el.dialog({modal:!0,resizable:!1,draggable:!1,open:this.dialogOpenWithoutTitle,autoOpen:!1,minWidth:600,position:["center",50]})},dialogOpenWithoutTitle:function(){var b=a(this);b.closest(".ui-dialog").find(".ui-dialog-titlebar").remove(),b.css({padding:"0"}).closest(".ui-dialog").css({padding:"0"}),$dialogOverlay=a(".ui-widget-overlay").last(),$dialogOverlay.unbind(),$dialogOverlay.click(function(){b.dialog("close")})},getKonsDialog:function(){this.konsEntry=akp_ws.konsDialog({el:this.$(".calKonsEntry"),type:"standard",onShare:this.shareEventKons,onCancel:this.clearKonsEntry,basic:"true",richText:!1})},hideKonsEntry:function(){this.$(".calKonsEntry").hide(),this.$(".calEventKons").show()},showKonsEntry:function(){this.$(".calKonsEntry").show(),this.$(".calEventKons").hide()},getKonsStream:function(){this.konsStream=akp_ws.kons.getKonsStream({el:this.$(".calEventKons"),basic:!0,richText:!1,strictCategory:"calendar",onUpdates:this.hideKonsEntry}),akp_ws.kons.getCategoryUpdates("calendar",this.konsStream.updates)},getEventKons:function(a){this.konsStream.getKonv(a)},render:function(a){a&&(this.model=a),this.renderModel()},renderModel:function(){return this.model?(this.model.bind("change",this.renderModel,this),this.mobj=this.model.toJSON(),this.mobj.start=new Date(this.mobj.tstart),this.mobj.end=new Date(this.mobj.tend),this.mobj.className=this.mobj.category,(1==this.mobj.allday||0==this.mobj.allday)&&(this.mobj.allDay=this.mobj.allday),this.mobj.startdate=a.fullCalendar.formatDate(this.mobj.start,"yyyy-MM-dd"),this.mobj.enddate=a.fullCalendar.formatDate(this.mobj.end,"yyyy-MM-dd"),this.mobj.starttime=a.fullCalendar.formatDate(this.mobj.start,"hh:mm TT"),this.mobj.endtime=a.fullCalendar.formatDate(this.mobj.end,"hh:mm TT"),this.mobj.viewtype=this.getViewType(this.mobj),this.mobj.isOwner=this.isOwner(this.mobj.owner_uid),this.mobj.venue=this.mobj.location,this.mobj.allDay=this.mobj.allday,this.renderEvent(this.mobj),this.mobj.kons?(this.hideKonsEntry(),this.getEventKons(this.mobj.kons)):this.showKonsEntry(),void 0):(noty({text:"Sorry! event data not available.",type:"error",timeout:5e3,layout:"bottomRight"}),void 0)},renderEvent:function(b){this.showPanel(),b.expired=b.start<new Date?!0:!1,b.hasAttachments=b.attachments?b.attachments.length?!0:!1:!1;var c=d.getuserinfo(b.owner_uid);b.userid=c.uid,b.img=c.image_medium||"css/images/user48.png",b.owner_name=c.first_name;var e=a("#showEvent-template").tmpl([b]);this.$(".calEventCard").removeClass("onfly editing").show().html(e),b.expired&&this.disableEdit(),b.hasAttachments&&this.renderAttachments(b.attachments),b.limited?this.renderMembers({el:this.$(".sevt-invite-stage"),members:b.invited}):this.$(".sevt-invite-stage").append("Group"),b.accepted.length?this.renderMembers({el:this.$(".sevt-accept-stage"),members:b.accepted}):this.$(".sevt-accept-stage").append("No one responded!"),this.$el.show()},saveEvent:function(){if(this.modelObj.title){var b=akp_ws.createUUID(),c={service:"calendar",mesgtype:"request",request:"edit_vevent",cookie:b,personal:!1,uid:d.loginuserid},e=a.extend({},this.modelObj,c);console.log(e),akp_ws.send(e),this.renderModel()}},disableEdit:function(){this.$(".evtcontrol").hide()},renderAttachments:function(a){this.attachments=akp_ws.FilesViewer({el:this.$(".sevt-attach-stage"),files:a})},renderMembers:function(b){for(var c=b.members,e=0;e<c.length;e++){var f=d.getuserinfo(c[e]),g={userid:f.uid,img:f.image_small||"css/images/user32.png"},h=a("#user-template").tmpl([g]);h.attr("title",f.first_name),b.el.append(h)}},isOwner:function(a){return a==d.loginuserid?!0:!1},getViewType:function(a){var b;return b=a.allDay?new Date(a.startdate)-new Date(a.enddate)?"period":"day":"hours"},showPanel:function(){this.$el.dialog("open")},eventRemove:function(){var a=this.model.toJSON();return a.original_event?(this.handleRecurEventRemove(a),void 0):("none"!=a.recurring,this.deleteReq(a,!1),void 0)},deleteReq:function(a,b){var c=akp_ws.createUUID(),e={mesgtype:"request",request:"delete_vevent",id:a.id,cookie:c,service:"calendar",uid:d.loginuserid};void 0!=b&&(e.recurring=b),akp_ws.send(e),this.collection.map(c,e,"delete"),a.kons&&this.konsStream.deleteKons(a.kons),this.hidePanel()},warnForNonRecurEventRemove:function(){},handleRecurEventRemove:function(b){var c=this;a("<div/>").addClass("snooze-dialog").append("<span>"+b.location+"</span><br/>is repeating event ...").dialog({title:b.title,modal:!0,height:"200",width:"350",buttons:[{text:"Delete All occurences",click:function(){c.deleteReq(b,!0),a(this).dialog("close").remove()},"class":"btn greenbtn"},{"class":"btn blue",text:"Delete just this occurence",click:function(){c.deleteReq(b,!1),a(this).dialog("close").remove()}},{text:"Cancel","class":"btn redbtn",click:function(){a(this).dialog("close").remove()}}],close:function(){},resizable:!1,draggable:!1,closeOnEscape:!1,dialogClass:"snooze-dialog"})},hidePanel:function(){this.model&&this.model.unbind("change",this.renderModel),this.$el.dialog("close")},shift2ReadView:function(){this.$(".calEventCard").removeClass("onfly editing")},goEdit:function(){this.shift2EditView()},shift2EditView:function(){var b=this.$(".calEventCard"),c=this.model.toJSON();this.modelObj=c,b.addClass("editing");var d=this;b.find(".evtfield-desc").attr("contentEditable",!0).keyup(function(b){d.modelObj.summary=a(b.currentTarget).text()}),b.find(".title").attr("contentEditable",!0).keyup(function(b){d.modelObj.title=a(b.currentTarget).text()});var e=a('<input type="text" value="'+c.location+'" class="" placeholder="Location" />').keyup(function(b){d.modelObj.location=a(b.currentTarget).val()});b.find(".sevtloc").children(".evtfield").remove().end().append(e),b.find(".sevttype").children(".evtfield-type").remove().end().append(this.getEvtType(c.category)),b.find(".sevtreminder").children(".evtfield-reminder").remove().end().append(this.getEvtRepeat(c.recurring))},getEvtType:function(b){var c=["Meeting","BirthDay"],d=this,e=a("<select/>").addClass("");for(var f in c)e.append("<option   value='"+c[f]+"'>"+c[f]+"</option>");return e.children("option[value='"+b+"']").attr("selected","selected"),e.bind("change",function(a){d.modelObj.category=a.currentTarget.options[a.currentTarget.selectedIndex].value}),e},getEvtRepeat:function(b){var c=this,d=["Never","Every Day","Every Week","Every Month"],e=["none","daily","weekly","monthly"],f=a("<select/>").addClass("");for(var g in d)f.append("<option value='"+e[g]+"' >"+d[g]+"</option>");return f.children("option[value='"+b+"']").attr("selected","selected"),f.bind("change",function(a){c.modelObj.recurring=a.currentTarget.options[a.currentTarget.selectedIndex].value}),f},shareEventKons:function(a){a.category="calendar",a.attached_object=this.model.get("id"),akp_ws.send(a)},clearKonsEntry:function(){}}),p=c.View.extend({className:"newCalEvent",initialize:function(){b.bindAll(this,"renderMax","hideAccessOpts","setUsers","saveEvent"),this.$el.appendTo(".event_mgr").hide(),this.collection.bind("clear",this.hide,this),a(document).click(this.hideAccessOpts)},events:{"click .savebtn":"saveEvent","click .cancelbtn":"hide","click .evtbig":"renderMax","click .accessChangeBtn":"showAccessOpts","click .opt":"selectMode","click .accessUserbrowser":"userBrowser"},render:function(b,c){return this.model=b,this.mobj=this.model.toJSON(),this.mobj.startdate=a.fullCalendar.formatDate(this.mobj.start,"yyyy-MM-dd"),this.mobj.enddate=a.fullCalendar.formatDate(this.mobj.end,"yyyy-MM-dd"),this.mobj.starttime=a.fullCalendar.formatDate(this.mobj.start,"hh:mm TT"),this.mobj.endtime=a.fullCalendar.formatDate(this.mobj.end,"hh:mm TT"),this.mobj.viewtype=this.getViewType(this.mobj),this.renderMax(this.mobj,c)},renderMin:function(b,c){this.$el.addClass("onfly").appendTo(".cal_view");var d=a("#newEventMin-template").tmpl([b]);return this.$el.show().html(d).css({top:c.pageY,left:c.pageX})},renderMax:function(b){this.showMax();var b=b.viewtype?b:this.mobj;this.$el.appendTo(".event_mgr");var c=a("#newEvent-template").tmpl([b]);return this.$el.removeClass("onfly").html(c),this.userInput=e.selector({el:this.$(".accessUsersList")}).render(),this.$(".accessUsers").hide(),this.timezone=new n({el:this.$(".evt-timezone")}),this.attachments=akp_ws.FSDialog({el:this.$(".evt-attach-btn"),container:this.$(".evt-attach-container"),onAdd:this.showAttachments}),this.selectType(b.className),this.selectReminder(b.reminder),this.showInvitees(b.invitees),this.$(".evtname").focus(),this.$el},selectType:function(a){a&&a.length&&this.$(".evttype option:contains("+a[0]+")").attr("selected","selected").siblings().removeAttr("selected")},selectReminder:function(a){a&&this.$('.evtreminder option:contains("'+a+'")').attr("selected","selected").siblings().removeAttr("selected")},showInvitees:function(a){a&&!a.length},showAttachments:function(){this.$(".evt-attachements").show()},showMax:function(){a(".cal_view").hide("slide",{direction:"left"}),a(".event_mgr").show("slide",{direction:"right"})},hide:function(){this.$el.hide(),a(".event_mgr").hide("slide",{direction:"right"}),a(".cal_view").show("slide",{direction:"left"})},saveEvent:function(){var a=this.validate();if(!a)return!1;this.hide();var b=akp_ws.createUUID(),c=a.end?new Date(a.end).toISOString():new Date(a.start).toISOString(),f={cookie:b,service:"calendar",mesgtype:"request",request:"add_vevent",personal:!1,uid:d.loginuserid,gid:d.cgd,category:this.$(".evttype").val(),recurring:this.$(".evtreminder").val(),tstart:new Date(a.start).toISOString(),tend:c,title:this.$(".eventname").val(),summary:this.$(".eventnote").text(),location:this.$(".eventloc").val(),invited:this.userInput.getSelected(),timezone:this.timezone.getTimeZone(),allday:a.allDay,attachments:this.attachments.getFileList()};f.invited.length?f.limited=!0:(f.invited=e.getGroupList(),f.limited=!1),console.log(f),akp_ws.send(f),this.collection.trigger("refresh")},validate:function(){var b=this.$(".eventname").val(),c=this.model.toJSON();return b?(c.title=b,c.className=a("#evttype").val(),c.venue=a(".eventloc").val(),c.description=a(".eventnote").text(),c.reminder=a(".evtreminder").val(),c.invitees=this.userInput.getSelected(),c):(this.$(".evtErrMsg").html("* Enter event name to save"),!1)},getViewType:function(a){var b;return b=a.allDay?new Date(a.startdate)-new Date(a.enddate)?"period":"day":"hours"},userBrowser:function(){var a=e.browser({onFinish:this.setUsers}),b=this.userInput.getSelected();a.selectUsers(b)},setUsers:function(a){this.userInput.reset().addUsers(a)},showAccessOpts:function(a){a.stopPropagation(),a.preventDefault(),this.$(".accessChangeOpts").show()},selectMode:function(b){this.hideAccessOpts();var c=a(b.currentTarget).attr("data-mode"),d=this.$(".accessChangeOpts").data("mode");c!=d&&this.switchMode(c)},switchMode:function(a){this.setMode(a),"private"==a?this.showUserSelector():this.hideUserSelector()},setMode:function(a){var b="public"==a?"icon-earth":"icon-users-2";this.$(".follow-mode").removeClass("icon-earth icon-users-2").addClass(b),this.$(".accessChangeOpts").data("mode",a)},hideAccessOpts:function(){this.$(".accessChangeOpts").hide()},showUserSelector:function(){this.$(".accessUsers").show(),this.userInput.getFocus()},hideUserSelector:function(){this.$(".accessUsers").hide(),this.userInput.reset()}}),q=c.Collection.extend({model:h,initialize:function(){}}),r=c.View.extend({el:a(".todayevents"),events:{"click .evt-title":"showEvent"},initialize:function(){b.bindAll(this,"render"),this.loaded=!1,this.collection.bind("add",this.render2dayEvent,this)},is2dayEvent:function(a){var b=new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate()),d=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1),e=new Date(a.start);return e>=c&&d>e},render:function(){for(event in events);},modObj:function(a){var b=a.toJSON();return b.start=new Date(b.tstart).toUTCString(),b.end=new Date(b.tend).toUTCString(),b.className=b.category,b},render2dayEvent:function(b){var c=this.modObj(b);if(this.is2dayEvent(c)&&!this.isExisting(c.id)){var d={title:c.title,day:a.fullCalendar.formatDate(new Date(c.start),"hh:mm "),month:a.fullCalendar.formatDate(new Date(c.start),"TT"),id:c.id,description:c.summary,venue:c.location},e=a("<li/>").append(a("#calEvent-template").tmpl(d));this.loaded||(this.loaded=!0,this.$("ul").empty()),this.$(".empty-evt").remove(),this.$("ul").append(e)}},isExisting:function(a){return this.$("li>div[data-evtid="+a+"]").length},showEvent:function(b){var c=a(b.currentTarget).closest("div.calevent").data("evtid");this.collection.trigger("showEvent",c)},showEmptyMsg:function(){a('<li class="empty-evt"><div class="calevent empty-invite" >No Events</div></li>').appendTo(this.$("ul"))},clear:function(){this.$("ul").empty(),this.showEmptyMsg()}}),s=c.View.extend({el:a(".calmenu.upcoming"),events:{"click .evt-title":"showEvent","scroll .calmenulist":"getMore"},settings:{marker:0,lastTimestamp:0,lastTop:0},initialize:function(a){b.bindAll(this,"render","attachEvent","showEvent","getMore"),this.baseCollection=a.baseCollection,this.collection=new q,this.collection.bind("add",this.renderNextdayEvent,this),this.$(".calmenulist").bind("scroll",this.getMore),this.loaded=!1},render:function(){return this.getRequestForUpcomingEvents(),this},renderEvent:function(){console.log("testing upcoming events")},getRequestForUpcomingEvents:function(a){var b=akp_ws.createUUID(),c={service:"calendar",mesgtype:"request",request:"get_upcoming",uid:d.loginuserid,cookie:b,personal:!1};a&&(c.marker=a),akp_ws.send(c),this.baseCollection.map(b,this,"upcoming")},getMore:function(){var a=this.$(".calmenulist").scrollTop(),b=this.$(".calmenulist")[0].scrollHeight,c=this.$(".calmenulist")[0].offsetHeight,d=b-c;if(a>this.settings.lastTop&&a+50>d){var e=this.$("li:last-child").children(".calevent").attr("data-evtid"),f=this.collection.get(e),g=f.toJSON().tstart;g!=this.settings.marker&&(this.getRequestForUpcomingEvents(g),this.settings.marker=g)}this.settings.lastTop=a},attachEvent:function(a){this.collection.add(a),j.add(a)},modObj:function(a){var b=a.toJSON();return b.start=new Date(b.tstart).toUTCString(),b.end=new Date(b.tend).toUTCString(),b.className=b.category,b},isNextdayEvent:function(a){var b=new Date(a.start);return b>=this.date1},renderNextdayEvent:function(b){var c=this.modObj(b);if(!this.isExisting(c.id)){var d={title:c.title,id:c.id,description:c.summary,venue:c.location};c.allday?(d.day=a.fullCalendar.formatDate(new Date(c.start),"dd"),d.month=a.fullCalendar.formatDate(new Date(c.start),"MMM"),d.date="Full Day"):(d.day=a.fullCalendar.formatDate(new Date(c.start),"dd"),d.month=a.fullCalendar.formatDate(new Date(c.start),"MMM"),d.date=a.fullCalendar.formatDate(new Date(c.start),"hh:mmTT "));var e=a("<li/>").append(a("#calEvent-template").tmpl(d));this.loaded||(this.$("ul").empty(),this.loaded=!0),this.$(".empty-evt").remove(),this.$("ul").append(e)}},showEvent:function(b){var c=a(b.currentTarget).closest("div.calevent").data("evtid");this.baseCollection.trigger("showEvent",c)},isExisting:function(a){return this.$("li>div[data-evtid="+a+"]").length},showEmptyMsg:function(){a('<li class="empty-evt"><div class="calevent empty-invite" >No Events</div></li>').appendTo(this.$("ul"))},clear:function(){this.collection.reset(),this.$("ul").empty(),this.showEmptyMsg()}}),t=new k,u=(new m({collection:t}),new p({collection:t})),v=new o({collection:t});return t}),define("akpTour",["jquery","underscore","backbone","akputils"],function(a,b,c){var d=c.View.extend({el:a(".tourcard"),events:{"click span.tourclsbtn":"close"},initialize:function(){this.firstVisit={container:!0,kons:!0,planner:!0,men:!0,pdt:!0},this.positions={container:{top:"20%",left:"30%"},kons:{top:"20%",left:"40%"},planner:{top:"50%",left:"20%"}},this.cards={container:".card1",kons:".card2",planner:".card5"}},render:function(b){a(".card").hide(),a(".tourcard").hide(),this.firstVisit[b]&&(a(".tourcard").css(this.positions[b]).show(),a(this.cards[b]).show("fade"))},close:function(){var b=a(".card:visible").data("cardid");this.firstVisit[b]=!1,a(".card").hide(),a(".tourcard").hide()}});return d}),define("appViews",["jquery","underscore","backbone","akputils","akpauth","akpGroups","feedback","plugins/jquery.steps.min","plugins/jquery.knob"],function(a,b,c,d,f,g,h){function i(a){var b=document.cookie,c=b.indexOf(" "+a+"=");if(-1==c&&(c=b.indexOf(a+"=")),-1==c)b=null;else{c=b.indexOf("=",c)+1;var d=b.indexOf(";",c);-1==d&&(d=b.length),b=unescape(b.substring(c,d))}return b}function j(){return i("username")}var k=c.View.extend({el:"#pricinglist",events:{"click a":"showView"},initialize:function(){},showView:function(b){a(a(b.currentTarget).attr("href")).show()}}),l=(new k,c.Model.extend({initialView:"kons",mainView:"",subView:"userprofile_view",onViewChange:{},initialize:function(){},showView:function(a){this.trigger("viewChange",a)}})),m=c.Model.extend({initialize:function(){},showView:function(a){this.trigger("viewChange",a)}}),n=c.View.extend({el:".userModule",events:{"click #userinfo":"showUserView","click #sobtn":"handleLogout","click .switchToGroups":"showGroups","click .showAdminSection":"showAdminView","click .showGroupsSection":"showGroupsView","click .groupItem":"switchGroup","click .shareKons_btn":"showShareDialog","click .globalShare":"handleShareDialog"},initialize:function(c){b.bindAll(this,"hideShare","shareKons"),this.authHandler=c.authHandler,this.authHandler.organization.bind("initialized",this.handleOrg,this),g.bind("add",this.handleAddGroup,this),g.bind("groupOut",this.handleGroupOut,this),g.bind("groupIn",this.handleGroupIn,this),g.bind("groupChange",this.handleGroupChange,this),this.model.bind("viewChange",this.handleViewChange,this),this.konsDialog=akp_ws.kons.konsDialog({el:this.$(".globalKonsEntry"),onShare:this.shareKons,onCancel:this.hideShare,autoFocus:!0,enableCategories:!0}),a(document).bind("click",this.hideShare)},handleOrg:function(){this.authHandler.organization.isAdmin()?this.$(".adminCog").show():this.$(".adminCog").hide()},showShareDialog:function(a){a.preventDefault(),a.stopPropagation(),this.$(".globalShare").show()},hideShare:function(){this.$(".globalShare").hide()},handleShareDialog:function(a){a.stopPropagation(),a.preventDefault()},shareKons:function(a){akp_ws.send(a),this.hideShare()},clearKonsEntry:function(){},handleGroupChange:function(a){this.$(".groupItem[data-gid="+a.gid+"]").addClass("active").siblings().removeClass("active")},handleAddGroup:function(b){if(b.isMember()){var c=b.toJSON(),d=a("<li/>").attr("data-gid",c.gid).append(c.gname).addClass("groupItem");this.$(".groups-list").append(d)}},switchGroup:function(b){var c=parseInt(a(b.target).attr("data-gid"));g.selectGroup(c)},handleViewChange:function(a){"login"==a?this.hide():this.show()},handleGroupIn:function(a){this.$(".group-status").show(),this.$(".showGroupsSection").hide(),this.$(".groupTitle").html(a.gname),this.$(".shareKons").show()},handleGroupOut:function(){this.$(".group-status").hide(),this.$(".showGroupsSection").show(),this.$(".shareKons").hide()},handleLogout:function(){this.authHandler.logout&&this.authHandler.logoutuser(this.onLogoutSuccess)},onLogoutSuccess:function(){window.location=akp_ws.originURL,this.model.showView("login")},showGroups:function(){g.pullout()},showGroupsView:function(){this.model.showView("groups")},showAdminView:function(){this.model.showView("admin")},showUserView:function(){akp_ws.getProfile()},hide:function(){this.$el.hide(),a("#feedback_btn").hide()},show:function(){this.$el.show(),a("#feedback_btn").show()}}),o=c.View.extend({el:".login-screen",events:{"submit .loginform":"sendLoginReq","click a":"showView"},store:!1,initialize:function(){this.model.bind("viewChange",this.handleViewChange,this),b.bindAll(this,"handleLoginResp")},handleViewChange:function(a){"login"==a?this.show():this.hide()},checkCookieStatus:function(){this.showLogin();var a=j();null==a||""==a||console.log("user Cookie available. trying to login.")},render:function(){},showLogin:function(){a("#logOverlay,#logboard").hide(),this.show()},showView:function(b){a(a(b.currentTarget).attr("href")).show()},sendLogin:function(a,b,c){return f.loginuser(a,b,this.handleLoginResp)?(this.deactive(),this.store=c,void 0):!1},sendLoginReq:function(a){a.preventDefault();var b=this.serialize();b.username&&this.sendLogin(b.username,b.password,b.remember)},handleLoginResp:function(a){"success"==a.status||a.user?(this.hide(),this.activate(),this.clear()):a.error&&(this.showInfo(a.error,"error"),this.activate())},serialize:function(){return{username:this.$("#inputUsername").val(),password:this.$("#inputPassword").val(),remember:"checked"==this.$("#inputRememberMe").attr("checked")}},showLoading:function(){},showInfo:function(b,c){var d=a("<div/>").append(b).addClass("alert alert-"+c);this.$(".form-info").empty().append(d).show()},deactive:function(){this.$("#inputUsername").attr("disabled","disabled"),this.$("#inputPassword").attr("disabled","disabled"),this.$(".applogin").attr("disabled","disabled"),this.$("#inputRememberMe").attr("disabled","disabled")},activate:function(){this.$("#inputUsername").removeAttr("disabled"),this.$("#inputPassword").removeAttr("disabled"),this.$(".applogin").removeAttr("disabled"),this.$("#inputRememberMe").removeAttr("disabled")},clear:function(){this.$("#inputUsername").val(""),this.$("#inputPassword").val("")},show:function(){this.$el.show()},hide:function(){this.$el.hide(),this.$(".form-info").hide()}}),p=c.View.extend({el:".groupSelectorDialog",events:{},settings:{joined:".gjoined",others:".gallgroups"},initialize:function(){this.createView=new r,this.collection.bind("add",this.addGroup,this),this.collection.bind("revise",this.checkgroup,this),this.model.bind("viewChange",this.handleViewChange,this)},render:function(){},handleViewChange:function(a){"groups"==a?this.show():this.hide()},show:function(){this.$el.show()},hide:function(){this.$el.hide()},renderList:function(a){a.joined&&this.stretchList("joined",a.joined)
},stretchList:function(a,b){this.initSection(a),this.$(this.settings[a]).append(this.renderGroupCard(b))},initSection:function(a){this.$(this.settings[a]).empty()},renderGroupCard:function(a,b){this.$(this.settings[a]).find(".gcommonitem").remove(),this.$(this.settings[a]).append(b)},checkgroup:function(a){var b=this.$el.find(".ggroupcard[data-gid='"+a.get("gid")+"']");b.remove(),this.addGroup(a)},addGroup:function(a){var b=new q({model:a,collection:this.collection}),c=a.isMember(f.loginuserid);c?this.renderGroupCard("joined",b.render().$el):this.renderGroupCard("others",b.render().$el)},openGroup:function(b){a(b.currentTarget).data("gid")},createGroup:function(){}}),q=c.View.extend({events:{click:"selectGroup","click .joinReq":"sendJoinReq"},className:"akp-card-item ggroupcard",initialize:function(){b.bindAll(this,"handleResponse"),this.model.bind("remove",this.removeGroup,this),this.model.bind("updateCount",this.changeCount,this)},render:function(){var b=this.model.toJSON();b.type=this.model.getType(),b.image_large=b.image_large||"css/images/groupIcons/a.jpg";var c=a("#groupCard-template").tmpl([b]);return this.$el.attr("data-gid",b.gid).append(c),this.model.isMember(f.loginuserid)||(this.$el.addClass("card-vertical"),this.model.isRequested(f.loginuserid)?this.appendRequested():this.appendJoin()),this},changeCount:function(a){this.$(".count").html(a+" Members")},sendJoinReq:function(b){a(b.target).attr("disabled","disabled").html("Join sent"),f.groupJoin(this.model.get("gid"),this.handleResponse)},handleResponse:function(a){var b=this.model.toJSON();b.join_by_approval||(console.log(a),b.members.push(f.loginuserid),this.model.set({member_count:b.member_count++,members:b.members}),this.collection.reviseGroup(this.model))},appendJoin:function(){var b=a("<button/>").append("<span class='icon-plus-2'></span>").append("Join").addClass("btn btn-primary btn-block joinReq"),c=a("<div/>").append(b).addClass("card-action");this.$el.append(c)},appendRequested:function(){var b=a("<span/>").append("Awaiting Approval").addClass("alert alert-info"),c=a("<div/>").append(b).addClass("card-action");this.$el.append(c)},selectGroup:function(){this.model.isMember(f.loginuserid)&&this.model.setSelected()},removeGroup:function(){this.$el.remove()}}),r=c.View.extend({el:"#createGroupModal",events:{"submit .createPublicGroupForm":"sendCreateGroupReq","submit .createPrivateGroupForm":"sendCreateGroupReq","shown a[data-toggle='tab']":"setGroupType"},initialize:function(){b.bindAll(this,"sendCreateGroupReq","handleResult")},approval:{"public":!1,"private":!0},groupType:"public",render:function(){return this},setGroupType:function(b){this.groupType=a(b.target).data("grouptype")},sendCreateGroupReq:function(b){b.preventDefault();var c=a(b.target).find(".groupName").val();f.addGroup(c,this.approval[this.groupType],this.handleResult),this.disableDialog()},handleResult:function(a){console.log(a),this.closeDialog()},disableDialog:function(){this.$el.find("a").removeAttr("data-toggle"),this.$el.find("input").attr("disabled","disabled"),this.$el.find("select").attr("disabled","disabled"),this.$el.find("button[type='submit']").attr("disabled","disabled").html("Loading.."),this.$el.find("button.close").removeAttr("data-dismiss")},enableDialog:function(){this.$el.find("a").attr("data-toggle","tab"),this.$el.find("input").removeAttr("disabled"),this.$el.find("select").removeAttr("disabled"),this.$el.find("button[type='submit']").removeAttr("disabled").html("Done"),this.$el.find("button.close").attr("data-dismiss","modal")},closeDialog:function(){this.$el.modal("hide"),this.enableDialog(),this.reset()},reset:function(){this.$el.find("input").val("")}}),s=(c.View.extend({el:"#inviteOrgDialog",events:{"submit #inviteOrgForm":"orgInvite"},initialize:function(){},render:function(){},orgInvite:function(a){a.stopPropagation();var b={};b.email=this.$(".email-input").val()},disableDialog:function(){this.$el.find("input").attr("disabled","disabled"),this.$el.find("button[type='submit']").attr("disabled","disabled").html("Loading.."),this.$el.find("button.close").removeAttr("data-dismiss")},enableDialog:function(){this.$el.find("input").removeAttr("disabled"),this.$el.find("button[type='submit']").removeAttr("disabled").html("Done"),this.$el.find("button.close").attr("data-dismiss","modal")}}),c.View.extend({el:"#adminSection",events:{"submit .addUser_form":"addUser","submit .rmvUser_form":"removeUser","submit .addGroup_form":"addGroup","submit .rmvGroup_form":"removeGroup"},initialize:function(){b.bindAll(this,"addUser","removeUser","addGroup","removeGroup","addUserResponse"),this.model.bind("viewChange",this.handleViewChange,this),this.$(".knob").knob(),this.$(".knob.storage").knob({draw:function(){a(this.i).val(this.cv+"%")}})},render:function(){return this},addUser:function(b){if(!b.target.checkValidity())return this.showError(b.target),!1;this.preventDefault(b);var c=a(b.target).find("#addUser_uname").val(),d=a(b.target).find("#addUser_fname").val(),e=a(b.target).find("#addUser_pswd").val();f.adduser(c,d,e,this.addUserResponse),this.disableInputs(b.target)},removeUser:function(a){return a.target.checkValidity()?(this.preventDefault(a),void 0):(this.showError(a.target),!1)},addGroup:function(a){return a.target.checkValidity()?(this.preventDefault(a),void 0):(this.showError(a.target),!1)},removeGroup:function(a){return a.target.checkValidity()?(this.preventDefault(a),void 0):(this.showError(a.target),!1)},preventDefault:function(a){a.preventDefault()},addUserResponse:function(b){console.log(b);var c=this.$(".addUser_form");if("success"==b.status){var d=a("<div/>").addClass("alert alert-info").append("User Created Successfully.");c.find(".form-info").empty().append(d)}else{var d=a("<div/>").addClass("alert alert-error").append("Problem! creating user. Please try again.");c.find(".form-info").empty().append(d)}this.enableInputs(c)},disableInputs:function(a){this.$(a).find("input").attr("disabled","disabled"),this.$(a).find("button").attr("disabled","disabled")},enableInputs:function(a){this.$(a).find("input").removeAttr("disabled").val(""),this.$(a).find("button").removeAttr("disabled")},showError:function(b){var c=a("<div/>").addClass("alert alert-error").append("Please fill all the fields correctly!");b.find(".form-info").empty().append(c)},handleViewChange:function(a){"admin"==a?this.show():this.hide()},show:function(){this.$el.show(),this.animateStats()},hide:function(){this.$el.hide()},animateStats:function(){var b=Math.round(f.org.fsusage);a(".konb.storage").attr("rel",b),this.$(".knob").each(function(){var b=a(this),c=b.attr("rel");b.knob({draw:function(){a(this.i).val(this.cv+"%")}}),a({value:0}).animate({value:c},{duration:2e3,easing:"swing",step:function(){b.val(Math.ceil(this.value)).trigger("change")}})})}})),t=c.View.extend({el:a("#menu"),events:{"click li":"display","click a":"preventDefault"},defaults:{initialView:"kons",mainView:"",subView:"userprofile_view",onViewChange:{}},views:{container:"vault",kons:"kons",planner:"calendar",dashboard:"dashboard"},settings:{},initialize:function(c){if(b.bindAll(this,"render","popstateChange","changeState"),this.dbController=c.dashboard,this.tour=c.tour,this.baseModel=c.baseModel,this.settings=a.extend({},this.defaults,c),this.model.set(c),this.model.set(this.defaults),this.baseModel.bind("viewChange",this.handleViewChange,this),a(window).bind("popstate",this.popstateChange),window.location.hash){var d=this.fragmentHash(window.location.hash);if(this.views[d])return this.changeView(d),this}var e=this.model.get("initialView");this.changeView(e)},handleViewChange:function(a){"app"==a&&(a=this.model.get("mainView")),this.views[a]?this.changeState(a):"groups"==a?(this.deactiveApp(),this.hide()):this.deactiveApp()},deactiveApp:function(){this.$("li").removeClass("active"),a(".content").children(".appModule").hide()},popstateChange:function(a){var b=a.state;b&&b.tab&&(b.sub?this.changeState(b.tab,b.sub):this.changeState(b.tab))},fragmentHash:function(a){return a.substr(a.indexOf("#")+1,a.length)},getData:function(a){return this.defaults[a]},setData:function(b){a.extend(!0,this.defaults,b)},preventDefault:function(a){a.preventDefault()},display:function(b){var c=a(b.currentTarget).data("tabid");this.changeView(c)},changeView:function(a,b){if(this.model.get("mainView")!=a&&(this.changeState(a,b),!b&&"dashboard"==a)){var c=this.model.get("subView");c&&(b=c)}},changeState:function(b){this.model.set({mainView:b}),this.$("li").removeClass("active"),this.$("li[data-tabId="+b+"]").addClass("active"),a(".content").children().hide().end().children("#"+b).show(),this.trigger("viewChange",{title:b}),this.settings.onViewChange[b]&&"function"==typeof this.settings.onViewChange[b]&&this.settings.onViewChange[b].apply()},hide:function(){this.$el.hide()},show:function(){this.$el.show()}}),u=c.View.extend({el:".userView",events:{"click .db-opt":"selectView","submit #changePasswordForm":"changePswd"},initialize:function(a){b.bindAll(this,"handleResp"),this.baseModel=a.baseModel,this.baseModel.bind("viewChange",this.handleViewChange,this),this.model.set({subView:"userprofile_view"}),this.render()},render:function(){return this._changeView(this.model.get("subView")),this},changePswd:function(a){a.preventDefault(),this.disableFields();var b=f.loginuserid,c=this.$("#old_password").val(),d=this.$("#new_password").val(),e=this.$("#new_cpassword").val();return d!=e?(this.enableFields(),this.showInfo("Confirm Password should match with new password!","error"),this.$("#new_cpassword").focus(),!1):(f.changePswd(b,e,c,this.handleResp),void 0)},handleResp:function(a){"success"==a.status?this.showInfo("Password changed successfully.","info"):a.error&&this.showInfo(a.error,"error"),this.reset(),this.enableFields()},disableFields:function(){a(".changePswd").attr("disabled","disabled");this.$("#old_password").attr("disabled","disabled"),this.$("#new_password").attr("disabled","disabled"),this.$("#new_cpassword").attr("disabled","disabled")},enableFields:function(){this.$(".changePswd").removeAttr("disabled");this.$("#old_password").removeAttr("disabled"),this.$("#new_password").removeAttr("disabled"),this.$("#new_cpassword").removeAttr("disabled")},reset:function(){this.$("#old_password").val(""),this.$("#new_password").val(""),this.$("#new_cpassword").val("")},selectView:function(b){var c=a(b.currentTarget).data("routeid");this.changeState(c)},showInfo:function(b,c){var d=a("<div/>").addClass("alert alert-"+c).append(b);this.$(".changePasswordFormError").empty().append(d).show()},handleViewChange:function(a){"user"==a?this.show():this.hide()},changeState:function(a){this.changeView(a)},changeView:function(a){var b=this.model.get("subView");b!=a&&(this.model.set({subView:a}),this._changeView(a))},_changeView:function(b){this.$("li.db-opt").removeClass("db_active"),this.$("li.db-opt[data-routeid="+b+"]").addClass("db_active"),a(".db_views").children(".db_view").hide().end().children("#"+b).show()},show:function(){this.$el.show()},hide:function(){this.$el.hide()}}),v=c.View.extend({el:"#cmpnyEntryWizard",events:{"click #addmember":"addNewMemberToView","click .postmemberentry":"postNewMemberDetails","click .removememberentry":"removeMemberFromView","submit .newMemberEntryForm":"preventDefaultFormSubmit","submit #orgCreateForm":"createOrg","submit #userCreateForm":"addUser"},initialize:function(){b.bindAll(this,"stepChanging","stepChanged","finishing","finished","forward","orgCreated","adminAdded"),this.stepCount=0,this.orgCreateRequested=!1,this.userCreateRequested=!1,this.model.bind("viewChange",this.handleViewChange,this)},handleViewChange:function(a){"wizard"==a?this.show():this.hide()},render:function(){return this},handleInviteResp:function(a){console.log(a)},addNewMemberToView:function(){var b=a("#newMemberDetailsEntryForm").tmpl([]);this.$el.append(b)},postNewMemberDetails:function(b){var c=a(b.currentTarget).parent(".newinvitemember"),d=c.children(".inviteeName").val(),e=c.children(".inviteeEmail").val();this.inviteMember(d,e,this.handleInviteResp)},removeMemberFromView:function(){a(e.currentTarget).parent(".newinvitemember").remove()},preventDefaultFormSubmit:function(a){a.preventDefault()},inviteMember:function(a,b,c){var d={};f.inviteMember(d,c)},makeWizard:function(){this.$el.steps({headerTag:"h3",bodyTag:"section",enableAllSteps:!1,forceMoveForward:!0,onStepChanging:this.stepChanging,onStepChanged:this.stepChanged,onFinishing:this.finishing,onFinished:this.finished}),this.validatePassWords()},createOrg:function(a){if(!a.target.checkValidity())return this.showError(),!1;a.preventDefault();var b=this.$("#cmpnyName").val();return f.createOrg(b,this.orgCreated),this.disableInputs(a.target),!1},orgCreated:function(a){this.trigger("orgCreated",a.org),this.forward()},addUser:function(a){if(!a.target.checkValidity())return this.showError2(),!1;a.preventDefault();{var b=f.baseUser.username,c=this.$("#user_name").val(),d=this.$("#user_password").val();this.$("#user_cpassword").val()}f.adduser(b,c,d,this.adminAdded),this.disableInputs(a.target)},adminAdded:function(){this.trigger("adminRegistered"),this.forward()},disableInputs:function(b){a(b).find(":input").attr("disabled","disabled")},showError:function(){this.$(".orgCreateFormError").show()},showError2:function(){this.$(".userCreateFormError").show()},createDfltGroup:function(){f.createGroup(this.dfltGroupName,this.forward)},forward:function(){this.stepCount++,this.$el.steps("next")},back:function(){this.$el.steps("previous")},stepChanging:function(a,b){if(0==b&&0==this.stepCount)this.orgCreateRequested||(this.$("#orgCreateForm").submit(),this.orgCreateRequested=!0);else{if(0==b&&1==this.stepCount)return!0;if(1==b&&1==this.stepCount)this.userCreateRequested||(this.$("#userCreateForm").submit(),this.userCreateRequested=!0);else if(1==b&&2==this.stepCount)return!0}return!1},stepChanged:function(){return!0},finishing:function(){return!0},finished:function(){return this.trigger("finished"),!0},show:function(){a(".wizardContainer").show(),this.$el.show()},hide:function(){this.$el.hide(),a(".wizardContainer").hide()},validatePassWords:function(){var a=document.querySelector(" input[name=usr_password]"),b=document.querySelector(" input[name=usr_password_confirm]");a&&b&&[].forEach.call([a,b],function(c){c.addEventListener("input",function(){if(c.validity.patternMismatch===!1)if(a.value===b.value)try{a.setCustomValidity(""),b.setCustomValidity("")}catch(d){}else a.setCustomValidity("The two passwords do not match");(a.checkValidity()&&b.checkValidity())===!1?(a.setCustomValidity("The two passwords do not match, and they don't comply with the password rules."),b.setCustomValidity("The two passwords do not match, and they don't comply with the password rules.")):(a.setCustomValidity(""),b.setCustomValidity(""))},!1)})}}),w=c.View.extend({initialize:function(){b.bindAll(this,"showApp");var a=new l;this.model=new m,this.feedbackView=new h,this.userControls=new n({authHandler:f,model:this.model}),this.groupsView=new p({el:".groupSelectorDialog",model:this.model,collection:g}),this.wizardView=new v({model:this.model}),this.loginview=new o({model:this.model}),this.adminView=new s({model:this.model}),this.tour="",this.dashboardView=new u({model:a,baseModel:this.model}),this.navView=new t({dashboard:this.dashboardView,tour:this.tour,model:a,baseModel:this.model}),this.currentView="",this.navView.bind("viewChange",this.catchViewChange,this),this.wizardView.bind("finished",this.onfinish,this),this.userControls.bind("groupsView",this.showGroupsView,this),this.userControls.bind("adminView",this.showAdminView,this),g.bind("groupChange",this.showApp,this),g.bind("groupOut",this.showGroupsView,this),this.model.bind("viewChange",this.handleViewChange,this)},handleViewChange:function(b){"app"==b?(this.navView.show(),a(".akorp-ui").show(),a(".appContainer").show()):"user"==b||"groups"==b||"admin"==b?(a(".akorp-ui").show(),a(".appContainer").show()):(a(".appContainer").hide(),this.navView.hide())},onfinish:function(){this.loginview.sendLogin(f.baseUser.username,!0),this.wizardView.hide()},catchViewChange:function(a){this.trigger("viewChange",a),this.currentView=a,akp_ws.calendar.onVisible()},showLoginView:function(){this.loginview.checkCookieStatus()},showApp:function(){a("footer").hide(),this.catchViewChange(this.currentView),this.model.showView("app")},showGroupsView:function(){this.model.showView("groups")},showGroupSelector:function(){a("#logOverlay,#logboard,#usersignup,#pricinglist").hide(),a(".topbar,.akp-app").show(),a("footer").hide(),this.loginview.hide(),this.model.showView("groups")},notifyAudio:function(){var b=a(".appAudio");b[0].play()},hideAll:function(){a("#logOverlay,#logboard,#usersignup,#pricinglist").hide(),a(".topbar,.akp-app").show(),a("footer").hide(),this.loginview.hide(),this.navView.hide(),this.groupsView.hide(),this.wizardView.hide()},showView:function(a){this.hideAll(),"3stepwizard"==a?(this.wizardView.show(),this.wizardView.makeWizard()):"login"==a?this.loginview.checkCookieStatus():"prompt"==a?this.showLoginView():"user"==a&&this.model.showView("user")}});return w}),define("akpcontacts",["jquery","akpauth","akpGroups","plugins/jquery-ui"],function(a,b,c){var d=Backbone.Model.extend({idAttribute:"uid",initialize:function(){this.bind("change",this.handleChanges,this)},handleChanges:function(a){var b=a.changedAttributes(),c=a.toJSON();for(var d in b)switch(d){case"status":this.trigger("statusChange",c);break;case"status_line":this.trigger("statusMsgChange",c)}},isAlive:function(){return"offline"!=this.get("status")},updateStatus:function(a){this.set({status:a.status,status_line:a.status_line})}}),e=Backbone.Collection.extend({model:d,initialize:function(){_.bindAll(this,"hidemenu"),this.bind("hideTools",this.setTime,this),this.bind("timeout",this.clearTimer,this),this.bind("search",this.search,this),this.bind("showAll",this.showAll,this),this.timer=null},setTime:function(){this.timer=setTimeout(this.hidemenu,500)},clearTimer:function(){clearTimeout(this.timer)},hidemenu:function(){this.trigger("timeout")},getUserByUid:function(a){var b=this.where({uid:a})[0];return b?b.toJSON():!1},getModelByUid:function(a){var b=this.where({uid:a})[0];return b?b:!1},getGroupList:function(){return this.pluck("id")},changeStatus:function(a){this.changeUserStatus(a)},changeUserStatus:function(a){var b=this.get(a.uid);b&&b.updateStatus(a)},comparator:function(a){return a.get("status")},matches:function(a){return""===a?[]:this.filter(function(b){return-1!==b.get("first_name").toLowerCase().indexOf(a)})},search:function(a){this.hideAll();var b=this.matches(a.toLowerCase());for(model in b)b[model].trigger("change:show")},hideAll:function(){this.each(function(a){a.trigger("change:hide")})},showAll:function(){this.each(function(a){a.trigger("change:show")})},selector:function(a){var b=new i({el:a.el,users:this});return b},browser:function(b){return browser=new j(a.extend({users:this},b))}}),f=Backbone.View.extend({el:a("#contactList"),events:{"keyup #cnsearch":"searchContacts"},initialize:function(){this.collection.bind("add",this.addContact,this)},render:function(){},addContact:function(a){a.set({id:a.get("uid")});var b=new g({model:a});this.$(".clist").append(b.render().el),this.collection.sort()},searchContacts:function(b){var c=a(b.currentTarget).val();c?this.collection.trigger("search",c):this.collection.trigger("showAll")}}),g=Backbone.View.extend({className:"contact user",events:{mouseover:"showMenu",mouseout:"hideMenu",drop:"sendPeerData",dragover:"handleDragOver"},initialize:function(){this.model.bind("change:hide",this.hide,this),this.model.bind("change:show",this.show,this),this.model.bind("statusChange",this.updateStatus,this)},sendPeerData:function(a){if(a.stopPropagation(),a.preventDefault(),a.dataTransfer)for(var b=a.dataTransfer.items.length||a.target.files.length,c=0;b>c;c++){var d=a.dataTransfer.items[c].webkitGetAsEntry();akp_ws.sendPeer({file:d,mesgtype:"peerEvent",eventtype:"fileXfer",to:this.model.get("uid")})}},updateContact:function(a){var b="",c=a.changedAttributes(),d=a.toJSON();for(var e in c)switch(e){case"status":b=a.get("first_name")+" is "+d.status,this.render();break;case"status_line":b=a.get("first_name")+" is updated status message,"+d.status_line;break;default:b=!1}},updateStatus:function(a){var b=this.model.get("first_name")+" is "+a.status;this.render(),this.notify(b)},notify:function(a){a&&noty({layout:"bottomRight",theme:"default",type:"alert",text:a,timeout:1e4})},handleDragOver:function(a){a.stopPropagation(),a.preventDefault(),a.dataTransfer.dropEffect="copy"},hide:function(){this.$el.hide()},show:function(){this.$el.show()},render:function(){{var b=this.model.toJSON(),c={userid:b.uid,img:b.image_small||"css/images/user32.png",name:b.first_name},d=a("#user-template").tmpl([c]);a("<span />").addClass("ustatus").appendTo(d)}return this.$el.attr("data-uid",b.uid).html(d),this.setStatus(d,b.status),this.enhanceDraggable(this.$el),this},setStatus:function(a,b){this.$("span.ustatus").addClass(b)},enhanceDraggable:function(a){var b={containment:"document",appendTo:"body",helper:"clone",revert:"Invalid",zindex:1e6};a.draggable(b).bind("drag",this.onDrag)},onDrag:function(a,b){b.helper.css("background-color","#12e6ab")},showMenu:function(b){var c=a(b.currentTarget).offset();q.trigger("timeout"),r.render({posTop:c.top,posLeft:c.left,model:this.model})},hideMenu:function(){q.trigger("hideTools")}}),h=Backbone.Collection.extend({model:d}),i=Backbone.View.extend({defaults:{onAddUser:"",onRemoveUser:"",blockUsers:[],maxUsers:6,maxSuggestions:5},settings:{},className:"userSelector",events:{click:"getFocus","keyup .userInput":"getSuggestions"},initialize:function(b){_.bindAll(this,"render","_resetState","_selectUser","loadSuggestions"),this.settings=a.extend({},this.defaults,b),this.collection=new h,this.collection.bind("add",this.addUser,this),this.collection.bind("remove",this._removeUser,this),this.users=b.users},render:function(){return this.$el.append('<div class="usersSelected"><ul></ul></div><input type="text" class="userInput" placeholder="add follower" /><div class="userSuggestions"><ul class="sugglist"></ul</div>').addClass(this.className),this._resetState(),this},addUser:function(b){var c=b.toJSON(),d=this,e=a("<li/>").attr({"data-uid":c.id}).append(c.first_name+" "+c.last_name).addClass("userEntry").appendTo(this.$(".usersSelected ul"));a(" <span class='icon-cross removeUserTag'></span>").bind("click",{user:c.id},function(){d.removeUser(c.id)}).appendTo(e)},getFocus:function(){this.$(".userInput").focus()},getSuggestions:function(b){var c=a(b.currentTarget).val();if(c.length>0){var d=this.users.matches(c);this.loadSuggestions(d)}else if(!c.length&&8==b.keyCode){this.collection.pop()}},loadSuggestions:function(b){this.$(".userSuggestions").show(),this.$(".sugglist").empty();for(var c=this.settings.maxSuggestions?this.settings.maxSuggestions:b.length,d=0;c>d;d++){var e=b[d];if(e){var f=e.toJSON();a("<li/>").addClass("usrsugst").append(f.first_name).bind("click",{obj:f},this._selectUser).appendTo(this.$(".sugglist"))}}},_removeUser:function(a){var b=a.toJSON();this._removeUserTag(b.id)},_removeUserTag:function(a){this.$(".usersSelected ul").children("li[data-uid="+a+"]").remove()},_selectUser:function(a){this._resetState();var b=a.data.obj;b.id=b.uid,this.collection.add(b)},_resetState:function(){this.$(".sugglist").empty(),this.$(".userSuggestions").hide(),this.$(".userInput").val("").focus()},addUsers:function(a){for(var b=0;b<a.length;b++){var c=this.users.getUserByUid(a[b]);c&&(c.id=c.uid,this.collection.add(c))}},removeUser:function(a){var b=this.collection.get(a);this.collection.remove(b)},getSelected:function(){return this.collection.pluck("id")},reset:function(){return this.$(".usersSelected ul").empty(),this._resetState(),this.collection.reset(),this}}),j=Backbone.View.extend({defaults:{onFinish:"",onSelect:"",blockedUsers:[]},settings:{},events:{"click .close":"close","click .finish":"finish"},initialize:function(b){_.bindAll(this,"_selectUser"),this.settings=a.extend({},this.defaults,b),this.overlay=a("<div/>").addClass("overlay").appendTo("body");var c=a("#ubrowser-template").tmpl();this.template=this.$el.addClass("modal ").append(c).appendTo("body"),this.users=b.users,this.collection=new h,this.render(),this.addUsers()},render:function(){this.$el.css({height:window.innerHeight-100,width:"50%"})},addUsers:function(){for(var a=this.users.models,b=0;b<a.length;b++){var c=a[b],d=c.toJSON();this._renderUser(d)}},_renderUser:function(b){var c=a("#activeUser-template").tmpl([b]),d=a("<li/>").append(c).addClass("ubrowser-user").attr({"data-select":0,"data-user":b.uid}).bind("click",this._selectUser);this.template.find("ul").append(d)},_selectUser:function(b){var c=a(b.currentTarget).data("user");parseInt(a(b.currentTarget).attr("data-select"))?(this.collection.remove(c),a(b.currentTarget).removeClass("active").attr("data-select",0)):this._activeUser(c)},_activeUser:function(a){var b=this.users.getUserByUid(a);b.id=a,this.collection.add(b),this.$(".browserBody").find("li.ubrowser-user[data-user="+a+"]").addClass("active").attr("data-select",1)},_standardUser:function(a){this._activeUser(a),this.$(".browserBody").find("li.ubrowser-user[data-user="+a+"]").unbind("click")},selectUsers:function(a){for(var b=0;b<a.length;b++){var c=a[b];this._activeUser(c)}},blockUsers:function(a){this.settings.blockedUsers=a;for(var b=0;b<a.length;b++){var c=a[b];this._standardUser(c)}},getSelected:function(){var a=this.collection.pluck("id"),b=this.settings.blockedUsers;if(b.length)for(var c=0;c<b.length;c++)a=_.filter(a,function(a){return a!=b[c]});return a},getMatches:function(){},finish:function(){var a=this.getSelected();this.settings.onFinish.call(this,a),this.close()},close:function(){this.$el.remove(),this.overlay.remove()}}),k=Backbone.View.extend({className:"usertools",events:{mouseover:"showTools",mouseout:"hideTools","click .uprfl":"showProfile","click .uchat":"startChat","click .uvidcal":"startVideoCall","click .umail":"sendMail","click .uaudio":"startAudio"},initialize:function(){this.$el.appendTo("body"),this.collection.bind("timeout",this.hide,this)},render:function(b){var c=b.model.toJSON();this.model=b.model;var d=a("#usertools-template").tmpl([{name:c.first_name,status_line:c.status_line}]);this.$el.html(d).css({top:b.posTop+45,left:b.posLeft}).show()},showTools:function(){this.collection.trigger("timeout"),this.$el.show()},hideTools:function(){this.collection.trigger("hideTools")},hide:function(){this.$el.hide()},showProfile:function(){var a=this.model.get("uid");akp_ws.getProfile({id:a,mode:"read"})},startChat:function(){var a=this.model.get("uid");akp_ws.getIM(a)},startAudio:function(){if(!navigator.onLine)return noty({type:"error",text:"Sorry! You are now offline, You cannot make Audio Call.",layout:"bottomRight",time:5e3}),void 0;var a=this.model.get("uid");akp_ws.getMedia(a,{audio:!0})},startVideoCall:function(){if(!navigator.onLine)return noty({type:"error",text:"Sorry! You are now offline, You cannot make Video Call.",layout:"bottomRight",time:5e3}),void 0;var a=this.model.get("uid");akp_ws.getMedia(a)},sendMail:function(){noty({layout:"bottomRight",theme:"default",type:"error",text:"oops! We are still working on it! <br/> Stay tuned...",timeout:1e4})}}),l=Backbone.View.extend({el:".groupPendingApprovalsList",initialize:function(a){this.groups=a.groups,this.groups.bind("groupChange",this.changeGroup,this)},render:function(){return this},changeGroup:function(a){this.clear(),this.group=this.groups.getModelByGid(a.gid);var b=this.group.isAdmin(akp_ws.auth.loginuserid),c=a.pending_approval_list?a.pending_approval_list.length:!1;if(b&&c){this.show(c);var d,e=a.pending_approval_list;for(d in e){var f=this.collection.getModelByUid(e[d]);f&&this.renderApproval(f)}}else this.hide()},renderApproval:function(a){var b=new m({model:a,collection:this.collection,group:this.group});this.$(".groupPendingApprovals").append(b.render().$el)},clear:function(){this.$(".groupPendingApprovals").empty()},show:function(a){this.$(".pendingCount").html(a),this.$el.show()},hide:function(){this.$(".pendingCount").html(""),this.$el.hide()}}),m=Backbone.View.extend({className:"member",events:{"click .approve":"approveRequest","click .ignore":"declineRequest"},initialize:function(a){_.bindAll(this,"approveResp"),this.group=a.group},render:function(){var a=this.model.toJSON(),b=a.image_large||"css/images/user96.jpg",c="<p><img src='"+b+"' height=96 width=96 vertical-align=top class=member-pic /></p><div class=member-info><span class=member-name>"+a.first_name+"</span><br><span>"+a.jobtitle+"</span><div class='member-actions'><button class='btn btn-success approve' data-uid='"+a.uid+"'>Accept</button><button class='btn btn-default ignore' data-uid='"+a.uid+"'>Ignore</button></div></div>";return this.$el.append(c),this},declineRequest:function(b){a(b.currentTarget).attr("disabled","disabled").html("Processing..").closest(".approve").attr("disabled","disabled");var c=a(b.currentTarget).data("uid");this.collection.trigger("declineUser",c,this.declineResp)},declineResp:function(a){consloe.log(a)},approveRequest:function(b){a(b.currentTarget).attr("disabled","disabled").html("Processing..").closest(".ignore").attr("disabled","disabled");var c=a(b.currentTarget).data("uid");this.collection.trigger("approveUser",c,this.approveResp)},approveResp:function(a){console.log(a),"success"==a.status&&(this.reset(),this.group.users.add(this.model))},reset:function(){var a=this.group.get("pending_approval_list"),b=this.group.get("members");a=_.without(a,this.model.get("uid")),b.push(this.model.get("uid"));var c=this.group.get("member_count"),d=c++;this.group.set({pending_approval_list:a,members:b,member_count:d}),this.$el.remove()}}),n=Backbone.View.extend({el:a("#userGroupView"),events:{"click .groupLeave":"leaveGroup","click .groupDelete":"deleteGroup","click .groupPic-change":"picUpdate"},initialize:function(a){_.bindAll(this,"updateInfo","picUpdate"),this.groups=a.groups,this.approvals=new l({collection:this.collection,groups:this.groups}),this.groups.bind("groupChange",this.changeGroup,this)},render:function(){return this},picUpdate:function(){akp_ws.auth.picUpdater.render({target:this.group.get("homedir")+"/profile.png",transporter:akp_ws,onSuccess:this.updateInfo})},updateInfo:function(a){this.$(".groupImg").attr("src",a),akp_ws.auth.updateGroup(this.group.toJSON())},leaveGroup:function(b){!this.group.isAdmin()&&this.group.isMember()&&(this.groups.leaveGroup(this.group.get("gid"),this.handleLeaveGroup),a(b.currentTarget).attr("disabled","disabled"))},handleLeaveGroup:function(){akp_ws.alert("you left the group!","info")},deleteGroup:function(b){this.group.isAdmin()&&(this.groups.deleteGroup(this.group.get("gid"),this.handleDeleteGroup),a(b.currentTarget).attr("disabled","disabled"))},handleDeleteGroup:function(){akp_ws.alert("Group Deleted Successfully!","success")},changeGroup:function(a){this.clear(),this.group=this.groups.getModelByGid(a.gid);var b=a.image_large||"css/images/groupIcons/a.jpg";this.$(".groupImg").attr("src",b),this.$(".groupTitle").html(a.gname),c.getModelByGid(a.gid).isAdmin()?(this.$(".groupLeave").hide(),this.$(".groupDelete").show().removeAttr("disabled"),this.$(".groupHeader").addClass("admin")):(this.$(".groupDelete").hide(),this.$(".groupLeave").show().removeAttr("disabled")),this.renderMembers(a)},renderMembers:function(a){console.log(a);var b=a.members;for(var c in b){var d=b[c],e=this.collection.getModelByUid(d);e&&this.addMember(e)}},renderModels:function(a){var b=this;a.users.each(function(a){b.addMember(a)})},addMember:function(a){var b=new o({model:a});this.$(".groupTeam").find(".member-empty").remove(),this.$(".groupTeam").append(b.render().el)},showEmptyMsg:function(){a("<div/>").addClass("member-empty alert alert-info").append("No one joined yet!").appendTo(this.$(".groupTeam"))},clear:function(){this.$(".groupHeader").removeClass("admin"),this.$(".groupTeam").find(".member").remove(),this.$(".groupTeam").find(".member-empty").remove(),this.showEmptyMsg()
}}),o=Backbone.View.extend({className:"member",events:{"click .m-profile":"getProfile","click .m-chat":"getChat","click .m-media":"getMedia","click .m-mail":"getMail"},initialize:function(){},render:function(){var a=this.model.toJSON(),b=a.image_large?a.image_large:"css/images/user96.jpg",c="<p><img src='"+b+"' height=96 width=96 vertical-align=top class=member-pic /></p><div class=member-info><span class=member-name>"+a.first_name+"</span><br><span>"+a.jobtitle+"</span><div class=member-tools><span class='m-chat icon-bubble'></span></div></div>";return this.$el.append(c),this},getProfile:function(){var a=this.model.get("uid");akp_ws.getProfile({id:a,mode:"read"})},getChat:function(){var a=this.model.get("uid");akp_ws.getIM(a)},getMedia:function(){var a=this.model.get("uid");akp_ws.getMedia(a)},getMail:function(){noty({layout:"bottomRight",theme:"default",type:"error",text:"oops! We are still working on it! <br/> Stay tuned...",timeout:1e4})},clear:function(){}}),p=Backbone.View.extend({el:"#invitePeople2Group",events:{"click .inviteaddpplbtn":"addMorePpl",hidden:"clearinputs","click .addppl":"addppl"},initialize:function(){},render:function(){},addppl:function(b){{var c=a(b.currentTarget).siblings("input").val();a("<p/>").append(c).append('<span class="close"></span>').prependTo(".invite2grouplist")}a(b.currentTarget).parent().remove()},clearinputs:function(){var b=a("<p/>").addClass("input-append").append('	<input type="email" required="required" placeholder="name@company.com" /> <button class="btn addppl">Add</button>');this.$(".invite2grouplist").empty().append(b)},addMorePpl:function(){var b=a("<p/>").addClass("input-append").append('	<input type="email" required="required" placeholder="name@company.com" /> <button class="btn addppl">Add</button>');this.$(".invite2grouplist").append(b)}}),q=(new p,new e),r=(new f({collection:q}),new n({collection:q,groups:c}),new k({collection:q}));return q}),define("akpGroups",["jquery","akpauth","akpUsers","plugins/jquery-ui"],function(a,b,c){var d=Backbone.Model.extend({idAttribute:"gid",users:new c,initialize:function(){this.bind("change",this.handleChanges,this)},handleChanges:function(a){var b=a.changedAttributes(),c=a.toJSON();for(var d in b)switch(d){case"member_count":this.trigger("updateCount",c.member_count)}},getUsers:function(){return this.users},getUsersCount:function(){return this.users.length},setSelected:function(){this.collection.setSelected(this)},isAdmin:function(a){var b=a||akp_ws.auth.loginuserid;return this.get("admin")==b},isMember:function(a){var b=a||akp_ws.auth.loginuserid;return this.get("admin")==b?!0:_.contains(this.get("members"),b)},isRequested:function(a){var b=a||akp_ws.auth.loginuserid;return _.contains(this.get("pending_approval_list"),b)},isPublic:function(){return!this.get("join_by_approval")},isPrivate:function(){return this.get("join_by_approval")},getType:function(){return this.get("join_by_approval")?"Private":"Public"},hasPendingApprovals:function(){return this.get("pending_approval_list").length},remove:function(){this.trigger("remove")}}),e=Backbone.Collection.extend({model:d,initialize:function(){this.selected=null},getModelByGid:function(a){var b=this.where({gid:a})[0];return b?b:!1},groupsCount:function(){return this.length},setSelected:function(a){this.selected=a,this.trigger("groupIn",a.toJSON()),this.trigger("groupChange",a.toJSON())},selectedGroup:function(){return null!=this.selected?this.selected:!1},selectGroup:function(a){var b=this.getModelByGid(a);return b&&b.isMember()?(this.setSelected(b),b):!1},reviseGroup:function(a){this.trigger("revise",a)},pullout:function(){this.trigger("groupOut")},leaveGroup:function(a,b){var c=this;this.trigger("leaveGroup",a,function(d){c._leaveGroup(a,d,b)})},deleteGroup:function(a,b){var c=this;this.trigger("deleteGroup",a,function(d){c._deleteGroup(a,d,b)})},_leaveGroup:function(a,b,c){this.trigger("groupOut");var d=this.getModelByGid(a),e=d.get("members"),f=d.get("member_count");e=_.without(e,akp_ws.auth.loginuserid),d.set({member_count:f--,members:e}),this.trigger("revise",d),this.trigger("groupLeft"),c.call(this,b)},_deleteGroup:function(a,b,c){this.trigger("groupOut");var d=this.getModelByGid(a);d.remove(),this.remove(d),this.trigger("groupDeleted"),c.call(this,b)}}),f=new e;return f}),define("akpUsers",["jquery","akpauth","plugins/jquery-ui"],function(a){var b=Backbone.Model.extend({uid:null,name:null,initialize:function(){this.bind("change",this.handleChanges,this)},handleChanges:function(a){var b=a.changedAttributes(),c=a.toJSON();for(var d in b)switch(d){case"status":this.trigger("statusChange",c);break;case"status_line":this.trigger("statusMsgChange",c)}},isAlive:function(){return"offline"!=this.get("status")}}),c=Backbone.Collection.extend({model:b,initialize:function(){_.bindAll(this,"hidemenu"),this.bind("hideTools",this.setTime,this),this.bind("timeout",this.clearTimer,this),this.bind("statusChange",this.changeUserStatus,this),this.bind("search",this.search,this),this.bind("showAll",this.showAll,this),this.timer=null},setTime:function(){this.timer=setTimeout(this.hidemenu,500)},clearTimer:function(){clearTimeout(this.timer)},hidemenu:function(){this.trigger("timeout")},getUserByUid:function(a){var b=this.where({uid:a})[0];return b?b.toJSON():!1},getGroupList:function(){return this.pluck("id")},changeUserStatus:function(a){var b=this.get(a.uid);b&&b.set({status:a.status,status_line:a.status_line})},comparator:function(a){return a.get("status")},matches:function(a){return""===a?[]:this.filter(function(b){return-1!==b.get("first_name").toLowerCase().indexOf(a)})},search:function(a){this.hideAll();var b=this.matches(a.toLowerCase());for(model in b)b[model].trigger("change:show")},hideAll:function(){this.each(function(a){a.trigger("change:hide")})},showAll:function(){this.each(function(a){a.trigger("change:show")})},selector:function(a){var b=new userSelector({el:a.el,users:this});return b},browser:function(b){return browser=new userBrowser(a.extend({users:this},b))}});return c}),define("picUpdater",["jquery","underscore","backbone","akputils","plugins/jquery-ui","jcrop/jquery.Jcrop.min","plugins/Blob","plugins/canvas-toBlob","plugins/jquery-tmpl"],function(a,b,c){var d=c.View.extend({el:"#profilePicAlter",events:{"click #imageSubmit":"updateTarget","click #picChangeClose":"close","dragover #surface":"handleDragOver","drop #surface":"handleUpload","dragenter #surface":"handleDragEnter","dragleave #surface":"handleDragLeave","click .picSelectBtn":"handleSelectBtn","change .picSelectInput":"handleUpload"},initialize:function(a){this.controller=a.controller,b.bindAll(this,"getSelection","close","messageHandler","cropImage","postBlob","handleUpload");document.getElementById("cropWidget");this.surface=document.getElementById("surface"),this.canv1=document.getElementById("canv1"),this.canv2=document.getElementById("canv2");document.getElementById("imageSubmit");this.ctx1=canv1.getContext("2d"),this.ctx2=canv2.getContext("2d");document.getElementById("profilePicAlter");this.Worker=new SharedWorker("profilePic_upload.js"),this.Worker.port.start(),this.Worker.port.onerror=this._error,this.Worker.port.onmessage=this.messageHandler},handleSelectBtn:function(){this.$(".picSelectInput").click()},handleDragOver:function(a){a.preventDefault(),a.stopPropagation(),a.dataTransfer.dropEffect="copy"},handleUpload:function(a){a.preventDefault(),a.stopPropagation(),this.$("#surface").removeClass("drop-effect"),a.dataTransfer?this.loadImg(a.dataTransfer.files[0]):a.target&&this.loadImg(a.target.files[0])},handleDragEnter:function(){this.$("#surface").addClass("drop-effect")},handleDragLeave:function(){this.$("#surface").removeClass("drop-effect")},_error:function(a){consloe.log("ERROR: Line ",a.lineno," in ",a.filename,": ",a.message)},messageHandler:function(a){var b=a.data.obj;a.data.obj&&("request"==b.mesgtype||"cancel"==b.mesgtype?(b.uid=this.controller.loginuserid,b.gid=this.controller.cgd||0,this.transporter.postData(b),this.controller.maptable[b.cookie]="picUpload"):"complete"==b.mesgtype&&(this.trigger("completed"),this.close(),"function"==typeof this.onSuccess&&this.onSuccess.call(this,this.getSelection())))},updateTarget:function(){this.disableDialog(),this.$("#imageSubmit").attr("disabled","disabled").html("uploading.."),this.upload()},loadImg:function(a){var b=this;if(a.type.match(/image.*/)){var c=document.createElement("img");c.id="pic",c.file=a;var d=new FileReader;d.onload=function(a){c.onload=function(){b.displayImage(c)},c.src=a.target.result},d.readAsDataURL(a)}},cropImage:function(a){var b=a.x2-a.x,c=a.y2-a.y;this.ctx2.drawImage(this.canv1,a.x,a.y,b,c,0,0,200,230)},uploadSelection:function(){document.getElementById("canv2").toDataURL("image/png");return!1},postBlob:function(a){var b={mesgtype:"file_list",files:a,dname:this.target};this.Worker.port.postMessage(b)},upload:function(){this.canv2.toBlob(this.postBlob,"image/png")},post:function(a){this.Worker.port.postMessage(a)},picChangeCancel:function(){this.trigger("canceled")},displayImage:function(b){var c=b.width<400?b.width:400,d=b.height<400?b.height:400;this.resize(b,c,d),this.resize(canv1,c,d),this.resize(surface,c,d),this.resize(cropWidget,c,d),this.$("#surface").empty(),this.surface.appendChild(b),this.ctx1.drawImage(b,0,0,c,d),a("#"+b.id).Jcrop({aspectRatio:1,onSelect:this.cropImage,setSelect:[200,200,50,50],bgOpacity:.3,bgColor:"white"})},resize:function(a,b,c){a.width=b,a.height=c,a.style.width=b+"px",a.style.height=c+"px"},profilePicHandler:function(){this.clear()},render:function(a){return this.transporter=a.transporter,this.target=a.target,this.onSuccess=a.onSuccess,this.$el.modal("show"),this.clear(),this},show:function(){this.$el.show()},hide:function(){this.$el.hide()},getSelection:function(){var a=document.getElementById("canv2").toDataURL("image/png");return this.trigger("updated",a),a},clear:function(){this.ctx1.clearRect(0,0,this.canv1.width,this.canv1.height),this.ctx2.clearRect(0,0,this.canv2.width,this.canv2.height),this.appendSelectors(),this.resize(surface,400,400)},appendSelectors:function(){var b=a("<input type='file' class='picSelectInput' />").css({visibility:"hidden",width:"0px"}),c=a("<button class='picSelectBtn btn btn-primary'> Select from your computer</button>"),d=a("<p>Drop Here or <br/><br/></p>").append(b).append(c);this.$("#surface").empty().append(d)},close:function(){this.$el.modal("hide"),this.$("#imageSubmit").removeAttr("disabled").html("Done"),this.enableDialog()},disableDialog:function(){this.$el.find("button.close").removeAttr("data-dismiss")},enableDialog:function(){this.$el.find("button.close").attr("data-dismiss","modal")}});return d}),define("akpprofiles",["jquery","underscore","backbone","akputils","plugins/jquery-ui","jcrop/jquery.Jcrop.min","plugins/Blob","plugins/canvas-toBlob","plugins/jquery-tmpl"],function(a,b,c){var d=c.View.extend({el:a("#userprofile_view"),events:{"click #profileEdit":"editView","click #profileSave":"save","click #changePic":"getPic","click #profileEditCancel":"cancelEdit"},initialize:function(a){b.bindAll(this,"render","activeProfile","getClientProfile","showUpdate"),this.controller=a.controller},render:function(){var b=a("#profile-template").tmpl(this.user);this.$el.html(b),this.$("#profileSave").hide(),this.$("#profileEditCancel").hide()},show:function(a){return"undefined"==typeof a||a.id==this.controller.loginuserid||a.uid==this.controller.loginuserid?(this.activeProfile(),void 0):(this.model=this.collection.getModelByUid(a.uid||a.id),this.user=this.model.toJSON(),this.user.mode=a.mode,this.render(),void 0)},getClientProfile:function(){this.activeProfile()},activeProfile:function(a){this.user=a||this.controller.activeuser,this.user.mode="write",this.render()},editView:function(b){b.preventDefault();var c=this.controller,d=c.usersList[c.loginuserid];a(".prfl_fname").html('<input type="text" id="first_name" name="first_name" value="'+d.first_name+'" placeholder="First Name" required>'),a(".prfl_mname").html('<input type="text" id="middle_name" name="middle_name" value="'+d.middle_name+'" placeholder="Middle Name" >'),a(".prfl_lname").html('<input type="text" id="last_name" name="last_name" value="'+d.last_name+'" placeholder="Last Name" required>'),a(".prfl_sex").html('<select id="sex" ><option>Male</option><option>Female</option></select>'),a(".prfl_dob").html('<input type="date" id="dob" name="dob" value="'+d.dob+'" placeholder="Date of Birth" required>'),a(".prfl_mobile").html('<input type="text" id="mobile" name="mobile_no" value="'+d.mob+'" placeholder="Mobile" required>'),a(".prfl_haddr").html('<textarea rows="5" cols="25" id="haddr" value="">'+d.homeaddress+"</textarea>"),a(".prfl_designation").html('<input type="text" id="jobtitle" name="jobtitle" value="'+d.jobtitle+'" placeholder="Designation" required>'),a(".prfl_dept").html('<input type="text" id="dept" name="dept" value="'+d.dept+'" placeholder="Department Name" required>'),a(".prfl_comp").html('<input type="text" id="org" name="org" value="'+d.organization+'" placeholder="Company Name" required>'),a("#sex").val(d.sex),a("#changePic").css("display","block"),a("#profileEdit").hide(),a("#profileClose").hide(),a("#profileSave").show(),a("#profileEditCancel").show()},save:function(b){b.preventDefault();var c=a("input#dept").val(),d=a("input#dob").val(),e=a("input#first_name").val(),f=a("#haddr").val(),g=a("input#jobtitle").val(),h=a("input#last_name").val(),i=a("input#middle_name").val(),j=a("input#mobile").val(),k=a("input#org").val(),l=a("#sex").val(),m=(a("#waddr").val(),{first_name:e,middle_name:i,last_name:h,dob:d,email:this.user.email,mob:j,sex:l,homeaddress:f,jobtitle:g,dept:c,organization:k});this.controller.setuser(m,this.showUpdate),a("#profileSave").attr("disabled","disabled"),a("#profileEditCancel").attr("disabled","disabled")},showUpdate:function(a){a.user?this.activeProfile(a.user):a.error,this.$("#profileSave").removeAttr("disabled"),this.$("#profileEditCancel").removeAttr("disabled")},cancelEdit:function(a){a.preventDefault(),this.render()},getPic:function(a){a.preventDefault(),this.controller.picUpdater.render({transporter:akp_ws,target:akp_ws.vault.getUserHome()+"/profile.png",onSuccess:this.updatePic})},updatePic:function(b){a(".userPic").attr("src",b),this.controller.setuser(this.controller.activeuser)}});return d}),define("pdfOpener",["jquery","underscore","backbone","akpauth","akputils","plugins/pdf"],function(a){PDFJS.workerSrc="./js/lib/pdfjs/worker_loader.js";var b=function(){};return b.prototype.open=function(b){a(".viewer-screen").show();var c=document.getElementById("pdf-vwr-frame").contentWindow;c.postMessage({data:b,pdfjsLoadAction:"complete"},akp_ws.originURL)},new b}),define("feedback",["jquery","underscore","backbone","akputils","akpauth"],function(a,b,c,d,e){var f=c.View.extend({el:"#feedback_dialog",events:{"submit #feedback_form":"preventAction"},initialize:function(){b.bindAll(this,"handleSuccess")},render:function(){},preventAction:function(b){b.preventDefault();var c={uid:e.loginuserid,oid:e.org.id,stmt:this.$(".fdbk_stmt").val(),email:this.$(".fdbk_email").val(),name:e.activeuser.first_name};a.ajax({url:"https://www.antkorp.in/php/feedback.php",type:"post",data:{userFeedback:c},success:this.handleSuccess,error:function(a,b,c){console.log("The following error occured: "+b),console.log(c)}})},handleSuccess:function(a){var b=a;b&&(this.$(".fdbk_stmt").val(""),this.$(".fdbk_email").val(""),this.$el.modal("hide"))}});return f}),define("socketModule",[],function(){var socketModule=function(){this.clientid=null,this.clientidRecvd=!1,this.svcstatus={},this.regServices={},this.respondTimer,this.port=8080,this.host=window.location.host,this.protocal="wss://",this.serverAddress=this.protocal+this.host+":"+this.port,this.serviceRequests="/services=ngw,auth,fmgr,kons,rtc,calendar"};return socketModule.prototype.init=function(a,b,c){var d=this;this.statusupdate=a,this.sendMessage=b,this.handleObj=c,"WebSocket"in window?(this.ws=new WebSocket(this.serverAddress+this.serviceRequests),console.log("connection issued"),d.handleNotResponding(),this.ws.binaryType="arraybuffer",this.ws.onopen=function(a){setTimeout(function(){d.conOpen(a)},100)},this.ws.onerror=function(a){d.conError(a)},this.ws.onclose=function(a){d.conClose(a)},this.ws.onmessage=function(a){d.handleMessage(a)}):this.statusupdate.call(this,{status:"notSupported"})},socketModule.prototype.handleNotResponding=function(){var a=this;this.respondTimer=setTimeout(function(){a.statusupdate.call(a.handleObj,{status:"notResponding"})},3e4)},socketModule.prototype._gotResponse=function(){clearTimeout(this.respondTimer)},socketModule.prototype.close=function(){this.ws.close()},socketModule.prototype.conOpen=function(a){this.statusupdate.call(this.handleObj,{status:"opened",data:a}),this.svcstatus.ngw=!0,this._gotResponse()},socketModule.prototype.conError=function(a){this.statusupdate.call(this.handleObj,{status:"error",data:a}),this._gotResponse()},socketModule.prototype.conClose=function(a){this.statusupdate.call(this.handleObj,{status:"closed",data:a}),this._gotResponse()},socketModule.prototype.send=function(a){this.regServices[a.service]?this.svcstatus[a.service]?this.sendBuffer(a):this.statusupdate.call(this,{status:"svc_err",service:a.service}):this.statusupdate.call(this,{status:"unreg_err",service:a.service})},socketModule.prototype.sendBuffer=function(a){if("object"!=typeof a)return console.log("Input is not an object."),!1;var b=a.service;delete a.service;var c=JSON.stringify(a),d=new ArrayBuffer(c.length+4+32),e=new DataView(d);if(b.length<32)for(var f=0;f<32-b.length;f++)b+=" ";for(var f=0;f<b.length;f++)e.setUint8(f,b.charCodeAt(f));e.setInt32(32,c.length);for(var f=0;f<c.length;f++)e.setUint8(f+36,c.charCodeAt(f));try{this.ws.send(d)}catch(g){console.log("cannot send msgs through connection.")}},socketModule.prototype.toJSON=function(buffer){for(var recvBuffer=buffer,dv=new DataView(recvBuffer),service="",i=0;32>i;i++)service+=String.fromCharCode(dv.getUint8(i));for(var svcmsgLen=dv.getInt32(32,!1),jsonstr="",i=36;i<buffer.byteLength;i++)jsonstr+=String.fromCharCode(dv.getUint8(i));var obj;try{obj=JSON.parse(jsonstr),obj.service=service.toString().replace(/[\x00-\x1F\x80-\xFF]/g,"")}catch(e){try{obj=eval("("+jsonstr+")"),obj.service=service.toString().replace(/[\x00-\x1F\x80-\xFF]/g,"")}catch(e){return console.log("NOT_JSON_DATA_Err: recieved data failed to parse"),!1}}return obj},socketModule.prototype.handleMessage=function(a){var b=this.toJSON(a.data);b&&(this.clientidRecvd?"ngw"==b.service?this.handleSvcStatus.call(this,b):this.regServices[b.service]?this.sendMessage.apply(this.handleObj,[b]):console.log("Recieved message from unknown service"):(this.clientid=b.clientid,this.clientidRecvd=!0,this.statusupdate.call(this.handleObj,{status:"clientRegistered"})))},socketModule.prototype.handleSvcStatus=function(a){this.statusupdate.call(this.handleObj,{status:"svcupdate",service:a.service_name,eventtype:a.eventtype}),"service_up"==a.status?this.svcstatus[a.service_name]=!0:"service_down"==a.status&&(this.svcstatus[a.service_name]=!1)},socketModule.prototype.register=function(a){for(svc in a)this.svcstatus[a[svc]]=!0,this.regServices[a[svc]]=!0},socketModule});